<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TDRT Protocol | Bitcoin De-Risk Token</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        :root {
            --bg: #f5f5f7;
            --bg-white: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #515154;
            --text-muted: #86868b;
            --border: #d2d2d7;
            --green: #34c759;
            --red: #ff3b30;
            --blue: #007aff;
            --radius: 12px;
            --radius-lg: 16px;
            --shadow: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-hover: 0 8px 24px rgba(0,0,0,0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Header */
        header {
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding: 0 24px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo-mark {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #1d1d1f, #515154);
            border-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 9px;
            color: #fff;
            letter-spacing: 0.3px;
        }
        .logo-text {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .header-actions {
            display: flex;
            align-items: center;
            gap: 24px;
        }
        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            transition: color 0.2s;
        }
        .nav-link:hover { color: var(--text-primary); }
        .connect-btn {
            background: var(--text-primary);
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .connect-btn:hover { opacity: 0.85; }
        .connect-btn.connected {
            background: var(--bg);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        /* Price Ticker */
        .price-ticker {
            background: var(--bg-white);
            border-bottom: 1px solid rgba(0,0,0,0.06);
            padding: 12px 24px;
            display: flex;
            justify-content: center;
            gap: 40px;
            font-size: 13px;
        }
        .ticker-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ticker-label {
            color: var(--text-muted);
            font-weight: 500;
        }
        .ticker-price {
            font-weight: 600;
            color: var(--text-primary);
        }
        .ticker-change {
            font-size: 12px;
            font-weight: 600;
        }
        .ticker-change.up { color: var(--green); }
        .ticker-change.down { color: var(--red); }
        .ticker-change.neutral { color: var(--text-muted); }

        /* Main */
        main {
            max-width: 980px;
            margin: 0 auto;
            padding: 48px 24px 80px;
        }

        /* Hero */
        .hero {
            text-align: center;
            padding: 24px 0 56px;
        }
        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--green);
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        .hero-badge .dot {
            width: 6px;
            height: 6px;
            background: var(--green);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .hero h1 {
            font-size: 52px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -2px;
            margin-bottom: 12px;
            line-height: 1.05;
        }
        .hero h1 .gradient {
            background: linear-gradient(90deg, #007aff, #5856d6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .hero-subtitle {
            font-size: 19px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* Section */
        .section { margin-bottom: 24px; }
        .section-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        /* Tooltip */
        .tooltip-wrap {
            position: relative;
            display: inline-flex;
        }
        .tooltip-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--bg);
            color: var(--text-muted);
            font-size: 10px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: help;
            margin-left: 6px;
        }
        .tooltip-icon:hover { color: var(--text-secondary); }
        .tooltip-text {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-primary);
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 400;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            z-index: 50;
        }
        .tooltip-wrap:hover .tooltip-text {
            opacity: 1;
            visibility: visible;
        }

        /* Cards */
        .card-grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .card-grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        
        .metric-card {
            background: var(--bg-white);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }
        .metric-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }
        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -1px;
        }
        .metric-value.green { color: var(--green); }
        .metric-value.red { color: var(--red); }
        .metric-sub {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Positions */
        .positions-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 24px;
        }
        .positions-header {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
        }
        .positions-header h3 {
            font-size: 14px;
            font-weight: 600;
        }
        .positions-table {
            width: 100%;
            border-collapse: collapse;
        }
        .positions-table th {
            text-align: left;
            padding: 12px 16px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--bg);
        }
        .positions-table td {
            padding: 14px 16px;
            font-size: 13px;
            border-bottom: 1px solid rgba(0,0,0,0.04);
        }
        .positions-table tr:last-child td { border-bottom: none; }
        .positions-table tr:hover { background: var(--bg); }
        .positions-table .green { color: var(--green); font-weight: 600; }
        .positions-table .muted { color: var(--text-muted); }
        .positions-table .bold { font-weight: 600; }
        .positions-empty {
            padding: 48px;
            text-align: center;
            color: var(--text-muted);
        }

        /* Actions */
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 32px;
        }
        .action-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }
        .action-card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }
        .action-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        .action-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        .action-icon.blue { background: rgba(0, 122, 255, 0.1); color: var(--blue); }
        .action-icon.gray { background: var(--bg); color: var(--text-secondary); }
        .action-icon.green { background: rgba(52, 199, 89, 0.1); color: var(--green); }
        .action-card h3 {
            font-size: 16px;
            font-weight: 600;
        }
        .action-card > p {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .mint-status {
            background: var(--bg);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .status-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
        }
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        .status-dot.active { background: var(--green); }
        .status-dot.inactive { background: var(--red); }
        .status-text {
            font-size: 12px;
            font-weight: 600;
        }
        .status-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .status-detail {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
        }
        .status-detail span:first-child { color: var(--text-muted); }
        .status-detail span:last-child { font-weight: 500; }

        .input-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .input-row input {
            flex: 1;
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.2s;
        }
        .input-row input:focus {
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0,122,255,0.1);
        }
        .input-row input::placeholder { color: var(--text-muted); }
        .action-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .action-btn.primary {
            background: var(--blue);
            color: #fff;
        }
        .action-btn.primary:hover:not(:disabled) { background: #006ae0; }
        .action-btn.secondary {
            background: var(--bg);
            color: var(--text-primary);
        }
        .action-btn.secondary:hover:not(:disabled) { background: #e8e8ed; }
        .action-btn.green {
            background: var(--green);
            color: #fff;
        }
        .action-btn.green:hover:not(:disabled) { background: #2db84d; }

        .action-info {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .claim-box {
            background: var(--bg);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
            margin-bottom: 12px;
        }
        .claim-amount {
            font-size: 32px;
            font-weight: 700;
            color: var(--green);
        }
        .claim-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Trust Box */
        .trust-box {
            background: #1d1d1f;
            border-radius: var(--radius-lg);
            padding: 24px;
            color: #fff;
            margin-top: 32px;
        }
        .trust-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }
        .trust-icon {
            font-size: 32px;
        }
        .trust-header h4 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .trust-header p {
            font-size: 13px;
            color: rgba(255,255,255,0.6);
        }
        .trust-vaults {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        .trust-vault {
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 16px;
        }
        .trust-vault h5 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .trust-vault p {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            line-height: 1.5;
        }
        .vault-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--green);
            margin-bottom: 4px;
        }

        /* How It Works */
        .how-section {
            margin-top: 48px;
            padding-top: 48px;
            border-top: 1px solid var(--border);
        }
        .how-section h2 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -1px;
        }
        .how-section > p {
            color: var(--text-secondary);
            margin-bottom: 32px;
        }
        .how-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }
        .how-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow);
        }
        .how-num {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 16px;
        }
        .how-card h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .how-card p {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 32px 24px;
            border-top: 1px solid var(--border);
            background: var(--bg-white);
        }
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 12px;
        }
        .footer-links a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 13px;
        }
        .footer-links a:hover { color: var(--blue); }
        footer p {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .toast {
            background: var(--text-primary);
            color: #fff;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .toast.error { background: var(--red); }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .card-grid-4, .card-grid-3, .actions-grid, .how-grid, .trust-vaults {
                grid-template-columns: 1fr;
            }
            .hero h1 { font-size: 36px; }
            .price-ticker { flex-wrap: wrap; gap: 16px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <div class="logo-mark">TDRT</div>
            <span class="logo-text">Protocol</span>
        </div>
        <div class="header-actions">
            <a href="#how-it-works" class="nav-link">How it Works</a>
            <a href="#" class="nav-link" id="tokenLink" target="_blank">Token</a>
            <button class="connect-btn" id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
        </div>
    </header>

    <div class="price-ticker">
        <div class="ticker-item">
            <span class="ticker-label">BTC</span>
            <span class="ticker-price" id="btcPrice">$‚Äî</span>
        </div>
        <div class="ticker-item">
            <span class="ticker-label">TDRT</span>
            <span class="ticker-price" id="drtMarketPrice">$‚Äî</span>
        </div>
        <div class="ticker-item">
            <span class="ticker-label">Supply</span>
            <span class="ticker-price"><span id="totalSupply">‚Äî</span> TDRT</span>
        </div>
    </div>

    <main>
        <section class="hero">
            <div class="hero-badge">
                <span class="dot"></span>
                Live on Base Mainnet
            </div>
            <h1>Bitcoin <span class="gradient">De-Risk</span></h1>
            <p class="hero-subtitle">Protection against BTC volatility. 95% coverage, 5% deductible.</p>
        </section>

        <section class="section">
            <div class="section-label">Your Portfolio</div>
            <div class="card-grid-4">
                <div class="metric-card">
                    <div class="metric-label">
                        TDRT Balance
                        <span class="tooltip-wrap">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">Your De-Risk Token holdings</span>
                        </span>
                    </div>
                    <div class="metric-value" id="balanceValue">0.00</div>
                    <div class="metric-sub">tokens</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">
                        Portfolio Value
                        <span class="tooltip-wrap">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">Current market value</span>
                        </span>
                    </div>
                    <div class="metric-value" id="portfolioValue">$0.00</div>
                    <div class="metric-sub">@ <span id="costBasis">$0.00</span> avg</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">
                        Unrealized P&L
                        <span class="tooltip-wrap">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">Profit/loss vs cost basis</span>
                        </span>
                    </div>
                    <div class="metric-value" id="pnlValue">$0.00</div>
                    <div class="metric-sub" id="pnlPercent">0%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">
                        Claimable
                        <span class="tooltip-wrap">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">Available protection payout</span>
                        </span>
                    </div>
                    <div class="metric-value green" id="claimableValue">$0.00</div>
                    <div class="metric-sub">from BTC drop</div>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="section-label">Earnings</div>
            <div class="card-grid-3">
                <div class="metric-card">
                    <div class="metric-label">Total Earnings</div>
                    <div class="metric-value green" id="totalEarnings">$0.00</div>
                    <div class="metric-sub">claimed + pending</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Already Claimed</div>
                    <div class="metric-value" id="claimedValue">$0.00</div>
                    <div class="metric-sub">received to wallet</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Pending Claim</div>
                    <div class="metric-value green" id="pendingClaim">$0.00</div>
                    <div class="metric-sub">ready to claim</div>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="section-label">Your Positions</div>
            <div class="positions-card">
                <div class="positions-header">
                    <h3>Active Protection Positions</h3>
                </div>
                <div id="positionsContainer">
                    <div class="positions-empty">Connect wallet to view positions</div>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="section-label">Actions</div>
            <div class="actions-grid">
                <div class="action-card">
                    <div class="action-header">
                        <div class="action-icon blue">‚¨Ü</div>
                        <h3>Mint TDRT</h3>
                    </div>
                    <p>Purchase protection tokens at market price</p>
                    <div class="mint-status">
                        <div class="status-row">
                            <div class="status-dot inactive" id="mintIndicator"></div>
                            <span class="status-text" id="mintStatusText">Checking...</span>
                        </div>
                        <div class="status-details">
                            <div class="status-detail"><span>DEX Price</span><span id="dexPrice">$‚Äî</span></div>
                            <div class="status-detail"><span>TWAP</span><span id="twapPrice">$‚Äî</span></div>
                            <div class="status-detail"><span>Threshold</span><span id="thresholdPrice">$‚Äî</span></div>
                        </div>
                    </div>
                    <div class="input-row">
                        <input type="number" id="mintAmount" placeholder="Amount TDRT" step="0.01">
                    </div>
                    <button class="action-btn primary" id="mintBtn" onclick="mintTDRT()" disabled>Mint TDRT</button>
                    <div class="action-info">Cost: <span id="mintCost">0.00 USDC</span></div>
                </div>

                <div class="action-card">
                    <div class="action-header">
                        <div class="action-icon gray">‚¨á</div>
                        <h3>Redeem TDRT</h3>
                    </div>
                    <p>Burn tokens for $0.95 USDC each</p>
                    <div class="input-row">
                        <input type="number" id="burnAmount" placeholder="Amount TDRT" step="0.01">
                    </div>
                    <button class="action-btn secondary" id="burnBtn" onclick="burnTDRT()" disabled>Redeem TDRT</button>
                    <div class="action-info">Receive: <span id="burnReceive">0.00 USDC</span></div>
                </div>

                <div class="action-card">
                    <div class="action-header">
                        <div class="action-icon green">‚úì</div>
                        <h3>Claim Payout</h3>
                    </div>
                    <p>Collect protection from BTC drops</p>
                    <div class="claim-box">
                        <div class="claim-amount" id="claimAmount">$0.00</div>
                        <div class="claim-label">Available to claim</div>
                    </div>
                    <button class="action-btn green" id="claimBtn" onclick="claimPayout()" disabled>Claim Payout</button>
                </div>
            </div>
        </section>

        <section class="how-section" id="how-it-works">
            <h2>How It Works</h2>
            <p>Simple protection against Bitcoin downside volatility</p>
            <div class="how-grid">
                <div class="how-card">
                    <div class="how-num">1</div>
                    <h4>Get Protection</h4>
                    <p>Mint TDRT tokens at market price. Each token represents $1 of BTC exposure with 95% downside protection.</p>
                </div>
                <div class="how-card">
                    <div class="how-num">2</div>
                    <h4>Track Your Position</h4>
                    <p>Your anchor price is set at mint. If BTC drops below 95% of your anchor, you start earning protection payouts.</p>
                </div>
                <div class="how-card">
                    <div class="how-num">3</div>
                    <h4>Claim or Redeem</h4>
                    <p>Claim payouts when BTC drops, or redeem tokens for $0.95 USDC anytime. Your protection, your choice.</p>
                </div>
            </div>
        </section>

        <div class="trust-box">
            <div class="trust-header">
                <span class="trust-icon">üè¶</span>
                <div>
                    <h4>Two-Vault Architecture</h4>
                    <p>Every TDRT backed by on-chain reserves</p>
                </div>
            </div>
            <div class="trust-vaults">
                <div class="trust-vault">
                    <h5>Senior Vault <a href="#" id="seniorLink" target="_blank" style="color: var(--blue); font-weight: 400;">‚Üó</a></h5>
                    <div class="vault-value" id="seniorVault">$0.00</div>
                    <p>Reserved for redemptions and claim payouts. $0.95 per TDRT backed.</p>
                </div>
                <div class="trust-vault">
                    <h5>Junior Vault <a href="#" id="juniorLink" target="_blank" style="color: var(--blue); font-weight: 400;">‚Üó</a></h5>
                    <div class="vault-value" id="juniorVault">$0.00</div>
                    <p>Safety buffer from premiums. Covers large claims.</p>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-links">
            <a href="#" id="contractLink" target="_blank">Smart Contract</a>
            <a href="#how-it-works">Docs</a>
        </div>
        <p>TDRT Protocol v3.1 ‚Äî Trustless Bitcoin Volatility Infrastructure on Base</p>
    </footer>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        // TDRT v3.1 on Base Mainnet
        const CONTRACTS = {
            TDRT: "0x0854601dD514742A08FFA04c8a8764793A40DDD7",
            SENIOR: "0xAAac01aAae32E595857FFfeC703CF1BA42afd9C7",
            JUNIOR: "0x82a7119ddC377C4a6Db84D0a5d8ea8760879AAeE",
            USDC: "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"
        };

        const TDRT_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function totalSupply() view returns (uint256)",
            "function getBtcPrice() view returns (uint256)",
            "function getDEXPrice() view returns (uint256)",
            "function getUserLots(address) view returns (tuple(uint256 amount, uint256 anchorPrice, uint256 lowestPrice, uint256 timestamp, uint256 purchasePrice)[])",
            "function checkClaimStatus(address) view returns (uint256, uint256, uint256)",
            "function checkMintConditions() view returns (bool, uint256, uint256, uint256, uint256)",
            "function getUserStats(address) view returns (uint256, uint256, uint256, uint256, uint256)",
            "function mint(uint256 drtAmount)",
            "function burn(uint256 drtAmount)",
            "function claim()",
            "function updateLowestPrice()"
        ];

        const VAULT_ABI = ["function balance() view returns (uint256)"];
        const ERC20_ABI = ["function approve(address, uint256) returns (bool)", "function allowance(address, address) view returns (uint256)"];

        let provider, signer, userAddress, tdrtContract, seniorContract, juniorContract, usdcContract;
        let currentMarketPrice = 1.00;

        async function connectWallet() {
            if (!window.ethereum) { showToast('Install MetaMask', 'error'); return; }
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                const network = await provider.getNetwork();
                
                // Base Mainnet only
                if (network.chainId !== 8453) {
                    try {
                        await window.ethereum.request({ 
                            method: 'wallet_switchEthereumChain', 
                            params: [{ chainId: '0x2105' }] 
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x2105',
                                    chainName: 'Base',
                                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                    rpcUrls: ['https://mainnet.base.org'],
                                    blockExplorerUrls: ['https://basescan.org']
                                }]
                            });
                        }
                    }
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                }
                
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                document.getElementById('connectBtn').textContent = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
                document.getElementById('connectBtn').classList.add('connected');
                
                tdrtContract = new ethers.Contract(CONTRACTS.TDRT, TDRT_ABI, signer);
                seniorContract = new ethers.Contract(CONTRACTS.SENIOR, VAULT_ABI, signer);
                juniorContract = new ethers.Contract(CONTRACTS.JUNIOR, VAULT_ABI, signer);
                usdcContract = new ethers.Contract(CONTRACTS.USDC, ERC20_ABI, signer);
                
                const baseUrl = 'https://basescan.org';
                document.getElementById('contractLink').href = `${baseUrl}/address/${CONTRACTS.TDRT}`;
                document.getElementById('seniorLink').href = `${baseUrl}/address/${CONTRACTS.SENIOR}`;
                document.getElementById('juniorLink').href = `${baseUrl}/address/${CONTRACTS.JUNIOR}`;
                document.getElementById('tokenLink').href = `${baseUrl}/token/${CONTRACTS.TDRT}`;
                
                await refreshData();
                showToast('Connected to Base', 'success');
            } catch (e) { showToast(e.message, 'error'); }
        }

        async function refreshData() {
            if (!tdrtContract) return;
            try {
                const btcPrice = await tdrtContract.getBtcPrice();
                const currentBtc = Number(ethers.utils.formatUnits(btcPrice, 8));
                document.getElementById('btcPrice').textContent = '$' + currentBtc.toLocaleString(undefined, {maximumFractionDigits: 0});

                const bal = await tdrtContract.balanceOf(userAddress);
                const balNum = Number(ethers.utils.formatEther(bal));
                document.getElementById('balanceValue').textContent = balNum.toFixed(2);

                const supply = await tdrtContract.totalSupply();
                document.getElementById('totalSupply').textContent = Number(ethers.utils.formatEther(supply)).toFixed(0);

                const claimData = await tdrtContract.checkClaimStatus(userAddress);
                const claimableAmount = Number(claimData[0]) / 1e6;
                document.getElementById('claimableValue').textContent = '$' + claimableAmount.toFixed(2);
                document.getElementById('claimAmount').textContent = '$' + claimableAmount.toFixed(2);
                document.getElementById('pendingClaim').textContent = '$' + claimableAmount.toFixed(2);

                document.getElementById('burnBtn').disabled = bal.eq(0);
                document.getElementById('claimBtn').disabled = claimData[0].eq(0);

                await checkMintStatus();
                await loadUserStats(claimableAmount, balNum);
                await loadVaultData();
                await loadPositions(currentBtc);
            } catch (e) { console.error(e); }
        }

        async function checkMintStatus() {
            try {
                const c = await tdrtContract.checkMintConditions();
                const dexPrice = Number(c[1]) / 1e6;
                currentMarketPrice = dexPrice > 0 ? dexPrice : 1.00;
                
                document.getElementById('drtMarketPrice').textContent = '$' + currentMarketPrice.toFixed(2);
                document.getElementById('dexPrice').textContent = '$' + dexPrice.toFixed(4);
                document.getElementById('twapPrice').textContent = '$' + (Number(c[2]) / 1e6).toFixed(4);
                document.getElementById('thresholdPrice').textContent = '$' + (Number(c[3]) / 1e6).toFixed(4);
                
                const dot = document.getElementById('mintIndicator');
                const text = document.getElementById('mintStatusText');
                
                if (c[0]) {
                    dot.classList.add('active'); dot.classList.remove('inactive');
                    text.textContent = 'Available';
                    document.getElementById('mintBtn').disabled = false;
                    window.currentDexPrice = dexPrice;
                } else {
                    dot.classList.add('inactive'); dot.classList.remove('active');
                    text.textContent = 'Below Threshold';
                    document.getElementById('mintBtn').disabled = true;
                }
            } catch (e) {
                document.getElementById('mintStatusText').textContent = 'Unavailable';
            }
        }

        async function loadUserStats(claimableAmount, balNum) {
            try {
                const stats = await tdrtContract.getUserStats(userAddress);
                const totalCostBasis = Number(stats[1]) / 1e6;
                const claimedEarnings = Number(stats[3]) / 1e6;
                const avgPrice = Number(stats[2]) / 1e6;

                const currentValue = balNum * currentMarketPrice;
                document.getElementById('portfolioValue').textContent = '$' + currentValue.toFixed(2);
                document.getElementById('costBasis').textContent = avgPrice > 0 ? '$' + avgPrice.toFixed(2) : '$0.00';

                const pnl = currentValue - totalCostBasis;
                const pnlPercent = totalCostBasis > 0 ? (pnl / totalCostBasis * 100) : 0;
                
                const pnlEl = document.getElementById('pnlValue');
                pnlEl.textContent = (pnl >= 0 ? '+' : '') + '$' + pnl.toFixed(2);
                pnlEl.className = 'metric-value ' + (pnl >= 0 ? 'green' : 'red');
                document.getElementById('pnlPercent').textContent = (pnl >= 0 ? '+' : '') + pnlPercent.toFixed(1) + '%';

                document.getElementById('claimedValue').textContent = '$' + claimedEarnings.toFixed(2);
                document.getElementById('totalEarnings').textContent = '$' + (claimableAmount + claimedEarnings).toFixed(2);
            } catch (e) { console.error(e); }
        }

        async function loadVaultData() {
            try {
                const seniorBal = await seniorContract.balance();
                const juniorBal = await juniorContract.balance();
                document.getElementById('seniorVault').textContent = '$' + (Number(seniorBal) / 1e6).toFixed(2);
                document.getElementById('juniorVault').textContent = '$' + (Number(juniorBal) / 1e6).toFixed(2);
            } catch (e) { console.error(e); }
        }

        async function loadPositions(currentBtc) {
            try {
                const lots = await tdrtContract.getUserLots(userAddress);
                const container = document.getElementById('positionsContainer');
                if (lots.length === 0) {
                    container.innerHTML = '<div class="positions-empty">No positions yet</div>';
                    return;
                }

                const claimData = await tdrtContract.checkClaimStatus(userAddress);
                const totalClaimable = Number(claimData[0]) / 1e6;
                const totalAmount = lots.reduce((sum, l) => sum + Number(ethers.utils.formatEther(l.amount)), 0);

                let html = `<table class="positions-table"><thead><tr>
                    <th>Opened</th><th>Amount</th><th>Entry BTC</th><th>Claim Below</th><th>Tracked Low</th><th>Claimable</th>
                </tr></thead><tbody>`;

                lots.forEach((lot) => {
                    const amt = Number(ethers.utils.formatEther(lot.amount));
                    const anchor = Number(ethers.utils.formatUnits(lot.anchorPrice, 8));
                    const lowest = Math.min(Number(ethers.utils.formatUnits(lot.lowestPrice, 8)), currentBtc);
                    const date = new Date(Number(lot.timestamp) * 1000).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const lotClaimable = totalAmount > 0 ? (totalClaimable * amt / totalAmount) : 0;

                    html += `<tr>
                        <td class="muted">${date}</td>
                        <td class="bold">${amt.toFixed(2)} TDRT</td>
                        <td>$${anchor.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                        <td>$${(anchor * 0.95).toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                        <td>$${lowest.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                        <td class="green">$${lotClaimable.toFixed(2)}</td>
                    </tr>`;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (e) { console.error(e); }
        }

        async function mintTDRT() {
            const amt = document.getElementById('mintAmount').value;
            if (!amt || parseFloat(amt) <= 0) return;
            const btn = document.getElementById('mintBtn');
            btn.innerHTML = '<span class="spinner"></span>';
            btn.disabled = true;
            try {
                const cost = ethers.utils.parseUnits((parseFloat(amt) * (window.currentDexPrice || 1)).toFixed(6), 6);
                const allow = await usdcContract.allowance(userAddress, CONTRACTS.TDRT);
                if (allow.lt(cost)) {
                    await (await usdcContract.approve(CONTRACTS.TDRT, ethers.constants.MaxUint256)).wait();
                }
                await (await tdrtContract.mint(ethers.utils.parseEther(amt))).wait();
                showToast('Minted ' + amt + ' TDRT', 'success');
                document.getElementById('mintAmount').value = '';
                setTimeout(refreshData, 2000);
            } catch (e) { showToast(e.reason || e.message, 'error'); }
            btn.innerHTML = 'Mint TDRT';
            await checkMintStatus();
        }

        async function burnTDRT() {
            const amt = document.getElementById('burnAmount').value;
            if (!amt || parseFloat(amt) <= 0) return;
            const btn = document.getElementById('burnBtn');
            btn.innerHTML = '<span class="spinner"></span>';
            btn.disabled = true;
            try {
                await (await tdrtContract.burn(ethers.utils.parseEther(amt))).wait();
                showToast('Redeemed ' + amt + ' TDRT', 'success');
                document.getElementById('burnAmount').value = '';
                setTimeout(refreshData, 2000);
            } catch (e) { showToast(e.reason || e.message, 'error'); }
            btn.innerHTML = 'Redeem TDRT';
            btn.disabled = false;
        }

        async function claimPayout() {
            const btn = document.getElementById('claimBtn');
            btn.innerHTML = '<span class="spinner"></span>';
            btn.disabled = true;
            try {
                await (await tdrtContract.updateLowestPrice()).wait();
                await (await tdrtContract.claim()).wait();
                showToast('Claimed!', 'success');
                setTimeout(refreshData, 2000);
            } catch (e) { showToast(e.reason || e.message, 'error'); }
            btn.innerHTML = 'Claim Payout';
            btn.disabled = false;
        }

        document.getElementById('mintAmount').addEventListener('input', e => {
            document.getElementById('mintCost').textContent = ((parseFloat(e.target.value) || 0) * (window.currentDexPrice || 1)).toFixed(2) + ' USDC';
        });
        document.getElementById('burnAmount').addEventListener('input', e => {
            document.getElementById('burnReceive').textContent = ((parseFloat(e.target.value) || 0) * 0.95).toFixed(2) + ' USDC';
        });

        function showToast(msg, type = 'success') {
            const t = document.createElement('div');
            t.className = 'toast ' + type;
            t.innerHTML = `<span>${type === 'success' ? '‚úì' : '‚úï'}</span><span>${msg}</span>`;
            document.getElementById('toastContainer').appendChild(t);
            setTimeout(() => t.remove(), 4000);
        }

        window.addEventListener('load', async () => {
            if (window.ethereum) {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) connectWallet();
            }
        });

        if (window.ethereum) {
            window.ethereum.on('accountsChanged', a => a.length ? connectWallet() : location.reload());
            window.ethereum.on('chainChanged', () => location.reload());
        }
    </script>
</body>
</html>
