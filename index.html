<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TDRT Protocol | Hedge Fund in a Token v13</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        :root {
            --bg: #f5f5f7;
            --bg-white: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #515154;
            --text-muted: #86868b;
            --border: #d2d2d7;
            --green: #34c759;
            --red: #ff3b30;
            --blue: #007aff;
            --orange: #ff9500;
            --gold: #d4a726;
            --radius: 12px;
            --radius-lg: 16px;
            --shadow: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-hover: 0 8px 24px rgba(0,0,0,0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        header {
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding: 0 24px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-mark {
            width: 28px; height: 28px;
            background: linear-gradient(135deg, #1d1d1f, #515154);
            border-radius: 7px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 9px; color: #fff; letter-spacing: 0.3px;
        }
        .logo-text { font-size: 15px; font-weight: 600; color: var(--text-primary); }
        .header-actions { display: flex; align-items: center; gap: 24px; }
        .nav-link { color: var(--text-secondary); text-decoration: none; font-size: 13px; font-weight: 500; transition: color 0.2s; }
        .nav-link:hover { color: var(--text-primary); }
        .connect-btn {
            background: var(--text-primary); color: #fff; border: none;
            padding: 8px 16px; border-radius: 20px;
            font-family: inherit; font-size: 13px; font-weight: 500;
            cursor: pointer; transition: all 0.2s;
        }
        .connect-btn:hover { opacity: 0.85; }
        .connect-btn.connected { background: var(--bg); color: var(--text-primary); border: 1px solid var(--border); }

        main { max-width: 980px; margin: 0 auto; padding: 48px 24px 80px; }

        .hero { text-align: center; padding: 24px 0 56px; }
        .hero-badge { display: inline-flex; align-items: center; gap: 6px; color: var(--green); font-size: 12px; font-weight: 600; margin-bottom: 16px; }
        .hero-badge .dot { width: 6px; height: 6px; background: var(--green); border-radius: 50%; animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .hero h1 { font-size: 52px; font-weight: 700; color: var(--text-primary); letter-spacing: -2px; margin-bottom: 12px; line-height: 1.05; }
        .hero h1 .gradient { background: linear-gradient(90deg, #007aff, #5856d6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .trust-badges { display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 24px; flex-wrap: wrap; }
        .trust-badges .separator { color: var(--border); font-size: 13px; }
        .trust-badge-item { position: relative; display: inline-flex; cursor: default; }
        .trust-badge-item > span { font-size: 13px; color: var(--text-muted); font-weight: 500; }
        .trust-tooltip { position: absolute; bottom: calc(100% + 10px); left: 0; transform: none; background: var(--text-primary); color: #fff; padding: 10px 14px; border-radius: 8px; font-size: 12px; font-weight: 400; width: 220px; text-align: left; opacity: 0; visibility: hidden; transition: all 0.2s; z-index: 50; line-height: 1.5; }
        .trust-badge-item:hover .trust-tooltip { opacity: 1; visibility: visible; }

        .section { margin-bottom: 24px; }
        .section-label { font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }

        .tooltip-wrap { position: relative; display: inline-flex; }
        .tooltip-icon { width: 16px; height: 16px; border-radius: 50%; background: var(--bg); color: var(--text-muted); font-size: 10px; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; cursor: help; margin-left: 6px; }
        .tooltip-icon:hover { color: var(--text-secondary); }
        .tooltip-text { position: absolute; bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%); background: var(--text-primary); color: #fff; padding: 10px 14px; border-radius: 8px; font-size: 12px; font-weight: 400; width: 240px; white-space: normal; text-align: left; opacity: 0; visibility: hidden; transition: all 0.2s; z-index: 50; line-height: 1.5; }
        .tooltip-wrap:hover .tooltip-text { opacity: 1; visibility: visible; }

        .portfolio-section { margin-bottom: 32px; }
        .portfolio-grid { display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 12px; }
        
        .portfolio-main-card {
            background: linear-gradient(135deg, #1d1d1f, #3a3a3c);
            border-radius: var(--radius-lg);
            padding: 28px;
            color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .portfolio-main-label { font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 8px; font-weight: 500; }
        .portfolio-main-value { font-size: 36px; font-weight: 700; letter-spacing: -1px; margin-bottom: 8px; line-height: 1; }
        .portfolio-main-sub { font-size: 14px; color: rgba(255,255,255,0.5); display: flex; flex-direction: column; gap: 4px; margin-bottom: auto; }
        .portfolio-main-sub .row { display: flex; justify-content: space-between; }
        .portfolio-main-sub .value { color: #fff; font-weight: 600; }
        .trade-btn-bottom {
            margin-top: 16px;
            padding: 12px 20px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            text-align: center;
            transition: all 0.2s;
            display: block;
            width: 100%;
        }
        .trade-btn-bottom:hover { background: rgba(255,255,255,0.18); }

        .claimable-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .claimable-card:hover { box-shadow: var(--shadow-hover); transform: translateY(-2px); }
        .claimable-label { font-size: 12px; font-weight: 500; color: var(--text-muted); margin-bottom: 8px; display: flex; align-items: center; }
        .claimable-value { font-size: 36px; font-weight: 700; letter-spacing: -1px; margin-bottom: 8px; color: var(--green); }
        .claimable-sub { font-size: 12px; color: var(--text-muted); margin-bottom: auto; }
        .claim-btn-inline { 
            margin-top: 16px; 
            padding: 12px 20px; 
            background: var(--green); 
            color: #fff; 
            border: none; 
            border-radius: 10px; 
            font-family: inherit; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s;
            width: 100%;
        }
        .claim-btn-inline:hover { opacity: 0.9; }
        .claim-btn-inline:disabled { opacity: 0.4; cursor: not-allowed; }

        .earnings-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .earnings-card:hover { box-shadow: var(--shadow-hover); transform: translateY(-2px); }
        .earnings-label { font-size: 12px; font-weight: 500; color: var(--text-muted); margin-bottom: 8px; display: flex; align-items: center; }
        .earnings-value { font-size: 28px; font-weight: 700; letter-spacing: -1px; margin-bottom: 4px; }
        .earnings-value.green { color: var(--green); }
        .earnings-value.gold { color: var(--gold); }
        .earnings-sub { font-size: 12px; color: var(--text-muted); }
        .earnings-breakdown { margin-top: auto; padding-top: 16px; border-top: 1px solid rgba(0,0,0,0.06); }
        .earnings-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; }
        .earnings-row:last-child { margin-bottom: 0; }
        .earnings-row .label { color: var(--text-muted); }
        .earnings-row .value { font-weight: 600; color: var(--green); }

        .positions-card { background: var(--bg-white); border-radius: var(--radius-lg); box-shadow: var(--shadow); overflow: visible; margin-bottom: 24px; }
        .positions-header { padding: 16px 20px; border-bottom: 1px solid rgba(0,0,0,0.06); display: flex; align-items: center; justify-content: space-between; }
        .positions-header h3 { font-size: 14px; font-weight: 600; }
        .btc-price-display { display: flex; align-items: center; gap: 6px; }
        .btc-label { font-size: 11px; font-weight: 500; color: var(--text-muted); }
        .btc-value { font-size: 13px; font-weight: 500; color: var(--text-secondary); }
        .btc-change { font-size: 11px; font-weight: 600; }
        .btc-change.up { color: var(--green); }
        .btc-change.down { color: var(--red); }
        .lock-btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 12px; font-weight: 600; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
        .lock-btn:hover:not(:disabled) { background: var(--text-primary); color: #fff; border-color: var(--text-primary); }
        .lock-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .lock-btn .lock-icon { font-size: 11px; }
        .lock-header-btn { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 10px; font-weight: 600; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.3px; }
        .lock-header-btn:hover:not(:disabled) { background: var(--text-primary); color: #fff; border-color: var(--text-primary); }
        .lock-header-btn:disabled { opacity: 0.35; cursor: not-allowed; background: var(--bg); color: var(--text-muted); }
        .relock-chip { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: default; }
        .relock-chip.available { background: rgba(52, 199, 89, 0.12); color: var(--green); }
        .relock-chip.current { background: var(--bg); color: var(--text-muted); }
        .positions-table-wrapper { width: 100%; }
        .positions-table { width: 100%; border-collapse: collapse; }
        .positions-table th { text-align: left; padding: 12px 16px; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; background: var(--bg); }
        .positions-table th .tooltip-text { text-transform: none; letter-spacing: normal; }
        .positions-table td { padding: 14px 16px; font-size: 13px; border-bottom: 1px solid rgba(0,0,0,0.04); }
        .positions-table tr:last-child td { border-bottom: none; }
        .positions-table tr:hover { background: var(--bg); }
        .positions-table .green { color: var(--green); font-weight: 600; }
        .positions-table .red { color: var(--red); }
        .positions-table .muted { color: var(--text-muted); }
        .positions-table .bold { font-weight: 600; }
        .change-indicator { font-size: 11px; font-weight: 600; margin-left: 6px; }
        .change-indicator.green { color: var(--green); }
        .change-indicator.red { color: var(--red); }
        .change-indicator.muted { color: var(--text-muted); }
        .deductible-tag { font-size: 10px; color: var(--text-muted); margin-left: 4px; }
        .positions-empty { padding: 48px; text-align: center; color: var(--text-muted); font-size: 14px; }
        .positions-empty a { color: var(--blue); text-decoration: none; font-weight: 600; transition: opacity 0.2s; }
        .positions-empty a:hover { opacity: 0.7; text-decoration: underline; }

        .actions-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 32px; }
        .action-card { background: var(--bg-white); border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow); transition: all 0.3s ease; }
        .action-card:hover { box-shadow: var(--shadow-hover); transform: translateY(-2px); }
        .action-header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
        .action-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .action-icon.blue { background: rgba(0, 122, 255, 0.1); color: var(--blue); }
        .action-icon.gray { background: var(--bg); color: var(--text-secondary); }
        .action-card h3 { font-size: 16px; font-weight: 600; }
        .action-card > p { font-size: 13px; color: var(--text-muted); margin-bottom: 16px; }

        .mint-status { background: var(--bg); border-radius: 10px; padding: 14px; margin-bottom: 12px; }
        .status-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .status-badge { 
            display: inline-flex; 
            align-items: center; 
            gap: 6px; 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 600;
        }
        .status-badge.available { background: rgba(52, 199, 89, 0.15); color: var(--green); }
        .status-badge.unavailable { background: rgba(255, 59, 48, 0.1); color: var(--red); }
        .status-badge.capped { background: rgba(255, 149, 0, 0.15); color: var(--orange); }
        .status-badge .dot { width: 6px; height: 6px; border-radius: 50%; }
        .status-badge.available .dot { background: var(--green); }
        .status-badge.unavailable .dot { background: var(--red); }
        .status-badge.capped .dot { background: var(--orange); }
        .status-details { display: flex; flex-direction: column; gap: 4px; }
        .status-detail { display: flex; justify-content: space-between; font-size: 11px; }
        .status-detail .label { color: var(--text-muted); }
        .status-detail .value { font-weight: 600; color: var(--text-secondary); }
        .status-detail .value.green { color: var(--green); }

        .info-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 13px; border-bottom: 1px solid rgba(0,0,0,0.04); }
        .info-row:last-of-type { border-bottom: none; }
        .info-row .label { color: var(--text-muted); }
        .info-row .value { font-weight: 600; }

        .input-wrap { position: relative; margin-bottom: 8px; }
        .input-wrap input { width: 100%; background: var(--bg); border: none; border-radius: 10px; padding: 14px 90px 14px 16px; font-family: inherit; font-size: 15px; font-weight: 500; color: var(--text-primary); outline: none; -moz-appearance: textfield; }
        .input-wrap input::-webkit-outer-spin-button, .input-wrap input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .input-wrap input:focus { box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2); }
        .input-wrap .suffix { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: 600; color: var(--text-muted); }
        .input-wrap .max-btn { position: absolute; right: 50px; top: 50%; transform: translateY(-50%); background: rgba(0, 122, 255, 0.1); color: var(--blue); border: none; padding: 4px 8px; border-radius: 6px; font-family: inherit; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .input-wrap .max-btn:hover { background: rgba(0, 122, 255, 0.2); }

        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-family: inherit; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; margin-top: 8px; }
        .btn-primary { background: var(--text-primary); color: #fff; }
        .btn-primary:hover { opacity: 0.85; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .protocol-stats { margin-bottom: 48px; }
        .stats-box {
            background: linear-gradient(135deg, #1d1d1f 0%, #252527 100%);
            border-radius: var(--radius-lg);
            padding: 24px 28px;
            color: #fff;
        }
        .stats-inner { display: flex; align-items: flex-start; gap: 40px; }
        .stat-block { }
        .stat-block:first-child { flex: 1; }
        .stat-label { font-size: 11px; color: rgba(255,255,255,0.4); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .stat-main { font-size: 26px; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 12px; }
        .stat-main.stat-link { color: #fff; text-decoration: none; display: inline-block; transition: opacity 0.2s; }
        .stat-main.stat-link:hover { opacity: 0.7; }
        .stat-main.ratio-green { color: var(--green); margin-bottom: 0; }
        .stat-ratio { text-align: right; }
        .vault-row { display: flex; gap: 12px; }
        .vault-item {
            display: flex; align-items: center; gap: 6px; padding: 8px 12px;
            background: rgba(255,255,255,0.04); border-radius: 8px;
            text-decoration: none; color: #fff; transition: all 0.2s; font-size: 13px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .vault-item:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
        .vault-label { color: rgba(255,255,255,0.5); }
        .vault-amt { font-weight: 600; margin-left: auto; }
        .vault-item::after { content: '↗'; font-size: 10px; color: rgba(255,255,255,0.3); margin-left: 4px; }

        .how-section { margin-bottom: 48px; }
        .section-header { text-align: center; margin-bottom: 28px; }
        .section-header h2 { font-size: 32px; font-weight: 700; letter-spacing: -1px; margin-bottom: 8px; }
        .section-header p { color: var(--text-muted); font-size: 16px; }
        .how-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .how-card { background: var(--bg-white); border-radius: var(--radius); padding: 24px 20px; text-align: center; box-shadow: var(--shadow); transition: all 0.3s ease; }
        .how-card:hover { box-shadow: var(--shadow-hover); transform: translateY(-2px); }
        .how-step { width: 32px; height: 32px; background: var(--text-primary); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; margin: 0 auto 14px; }
        .how-card h3 { font-size: 14px; font-weight: 600; margin-bottom: 8px; }
        .how-card p { font-size: 12px; color: var(--text-muted); line-height: 1.5; }

        footer { text-align: center; padding: 32px 24px; border-top: 1px solid rgba(0,0,0,0.06); }
        footer p { font-size: 12px; color: var(--text-muted); }
        footer a { color: var(--blue); text-decoration: none; }
        footer a:hover { text-decoration: underline; }

        #toastContainer { position: fixed; top: 70px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; }
        .toast { padding: 12px 16px; border-radius: 10px; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 8px; animation: slideIn 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .toast.success { background: #e8f5e9; color: #2e7d32; }
        .toast.error { background: #ffebee; color: #c62828; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .spinner { width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; vertical-align: middle; margin-right: 6px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(4px); }
        .modal-content { background: #fff; border-radius: 16px; padding: 24px; max-width: 360px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
        .modal-content h3 { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .modal-desc { font-size: 14px; color: var(--text-secondary); margin-bottom: 16px; line-height: 1.5; }
        .modal-details { background: var(--bg); border-radius: 10px; padding: 12px 14px; margin-bottom: 12px; }
        .modal-row { display: flex; justify-content: space-between; font-size: 13px; padding: 6px 0; }
        .modal-row span:first-child { color: var(--text-muted); }
        .modal-row span:last-child { font-weight: 600; }
        .modal-note { font-size: 12px; color: var(--text-muted); margin-bottom: 20px; line-height: 1.5; }
        .modal-warning { background: #fff3cd; border: 1px solid #ffc107; border-radius: 10px; padding: 12px 14px; margin-bottom: 12px; font-size: 13px; color: #856404; line-height: 1.5; }
        .modal-buttons { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 10px; font-family: inherit; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; }
        .modal-btn.secondary { background: var(--bg); color: var(--text-secondary); }
        .modal-btn.secondary:hover { background: var(--border); }
        .modal-btn.primary { background: var(--text-primary); color: #fff; }
        .modal-btn.primary:hover { opacity: 0.9; }

        @media (max-width: 768px) {
            body { overflow-x: hidden; }
            main { padding: 24px 16px 60px; max-width: 100%; }
            header { padding: 0 16px; }
            .header-actions { gap: 12px; }
            .nav-link { font-size: 12px; }
            .connect-btn { padding: 6px 12px; font-size: 12px; border-radius: 16px; }
            .logo-text { font-size: 13px; }
            .hero { padding: 16px 0 32px; }
            .hero h1 { font-size: 32px; letter-spacing: -1px; }
            .trust-badges { gap: 6px; padding: 0 8px; }
            .trust-badge-item > span { font-size: 11px; }
            .trust-badges .separator { font-size: 11px; }
            .portfolio-grid { grid-template-columns: 1fr; gap: 12px; }
            .portfolio-main-card, .claimable-card, .earnings-card { padding: 20px; }
            .actions-grid { grid-template-columns: 1fr; }
            .action-card { padding: 20px; }
            .how-grid { grid-template-columns: 1fr; }
            .stats-section { margin: 0 -16px; border-radius: 0; }
            .stats-inner { flex-direction: column; gap: 28px; padding: 28px 20px; text-align: center; }
            .stat-block { text-align: center; width: 100%; }
            .vault-row { flex-direction: column; gap: 12px; width: 100%; }
            .vault-item { 
                justify-content: space-between; 
                width: 100%; 
                padding: 14px 18px;
                border-radius: 10px;
                background: rgba(255,255,255,0.08);
            }
            .vault-label { font-size: 13px; }
            .vault-amt { font-size: 15px; font-weight: 600; }
            .positions-card { margin: 0 -16px; border-radius: 0; padding: 16px; }
            .positions-table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; margin: 0 -16px; padding: 0 16px; }
            .positions-table { font-size: 11px; min-width: 600px; }
            .positions-table th, .positions-table td { padding: 10px 8px; white-space: nowrap; }
            .section-label { font-size: 11px; }
            footer { padding: 24px 16px; }
            footer p { font-size: 11px; }
            
            /* Mobile tooltip - bottom sheet style */
            .trust-tooltip { display: none !important; }
            .tooltip-text { display: none !important; }
            .mobile-tooltip-sheet {
                display: none;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: #1d1d1f;
                color: #fff;
                padding: 24px 20px 32px;
                border-radius: 16px 16px 0 0;
                z-index: 1001;
                text-align: left;
                font-size: 14px;
                line-height: 1.6;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
            }
            .mobile-tooltip-sheet.active { display: block; }
            .mobile-tooltip-sheet .sheet-title {
                font-weight: 600;
                font-size: 15px;
                margin-bottom: 8px;
                color: #fff;
            }
            .mobile-tooltip-sheet .sheet-close {
                position: absolute;
                top: 16px;
                right: 16px;
                background: rgba(255,255,255,0.1);
                border: none;
                color: #fff;
                width: 28px;
                height: 28px;
                border-radius: 50%;
                font-size: 16px;
                cursor: pointer;
            }
            .tooltip-overlay {
                display: none;
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 1000;
            }
            .tooltip-overlay.active { display: block; }
        }
        
        /* Wallet picker modal */
        .wallet-modal {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            padding: 24px 20px 32px;
            border-radius: 16px 16px 0 0;
            z-index: 1001;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
        }
        .wallet-modal.active { display: block; }
        .wallet-modal h3 { font-size: 17px; font-weight: 600; margin-bottom: 20px; text-align: center; }
        .wallet-option {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: var(--bg);
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.2s;
            text-decoration: none;
            color: var(--text-primary);
        }
        .wallet-option:hover { background: var(--border); }
        .wallet-option img { width: 36px; height: 36px; border-radius: 8px; }
        .wallet-option span { font-size: 15px; font-weight: 500; }
        .wallet-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: var(--bg);
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <div class="logo-mark">DRT</div>
            <span class="logo-text">TDRT Protocol</span>
        </div>
        <div class="header-actions">
            <a href="https://app.uniswap.org/swap?chain=base&inputCurrency=0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913&outputCurrency=0xe068Be95da35Fd9daF04e5d834aB7b8bA1d6C21E" target="_blank" class="nav-link">Trade</a>
            <a href="https://basescan.org/address/0xe068Be95da35Fd9daF04e5d834aB7b8bA1d6C21E" target="_blank" class="nav-link">Contract</a>
            <button class="connect-btn" id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
        </div>
    </header>

    <main>
        <section class="hero">
            <div class="hero-badge"><span class="dot"></span> Live on Base</div>
            <h1>Bitcoin <span class="gradient">De-Risk</span> Token</h1>
            <div class="trust-badges">
                <div class="trust-badge-item">
                    <span>✓ Ultra Transparent</span>
                    <div class="trust-tooltip">All reserves and contracts are open-source and visible on-chain. Verify anytime on Basescan.</div>
                </div>
                <span class="separator">•</span>
                <div class="trust-badge-item">
                    <span>✓ Counter-Cyclical Asset</span>
                    <div class="trust-tooltip">Earn when Bitcoin drops. Never lose value when Bitcoin rises. No expiration date. Claiming payouts doesn't burn your tokens — you keep them until you sell or redeem.</div>
                </div>
                <span class="separator">•</span>
                <div class="trust-badge-item">
                    <span>✓ 100% Decentralized</span>
                    <div class="trust-tooltip">No admin keys. No manual controls. Fully autonomous smart contracts.</div>
                </div>
                <span class="separator">•</span>
                <div class="trust-badge-item">
                    <span>✓ Exit Anytime</span>
                    <div class="trust-tooltip">Redeem or sell 24/7. No lockups, no waiting periods.</div>
                </div>
            </div>
        </section>

        <section class="portfolio-section">
            <div class="section-label">Your Portfolio</div>
            <div class="portfolio-grid">
                <div class="portfolio-main-card">
                    <div class="portfolio-main-label">DRT Balance</div>
                    <div class="portfolio-main-value" id="balanceValue">0.00</div>
                    <div class="portfolio-main-sub">
                        <div class="row">
                            <span>Total Value (USD)</span>
                            <span class="value" id="portfolioValue">$0.00</span>
                        </div>
                        <div class="row">
                            <span>Market Price per DRT</span>
                            <span class="value" id="drtMarketPrice">$1.00</span>
                        </div>
                    </div>
                    <a href="https://app.uniswap.org/swap?chain=base&inputCurrency=0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913&outputCurrency=0xe068Be95da35Fd9daF04e5d834aB7b8bA1d6C21E" target="_blank" class="trade-btn-bottom">Trade</a>
                </div>
                <div class="claimable-card">
                    <div class="claimable-label">
                        Claimable
                        <div class="tooltip-wrap">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">You start getting paid when Bitcoin drops 0.1%. See Your Positions table below for per-position breakdown.</span>
                        </div>
                    </div>
                    <div class="claimable-value" id="claimableValue">$0.00</div>
                    <div class="claimable-sub">Available now</div>
                    <button class="claim-btn-inline" id="claimBtn" onclick="claimAll()" disabled>Claim Payout</button>
                </div>
                <div class="earnings-card">
                    <div class="earnings-label">
                        Total Earnings
                        <div class="tooltip-wrap">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">Your lifetime earnings from payouts. Includes both claimed USDC and pending claimable amounts.</span>
                        </div>
                    </div>
                    <div class="earnings-value gold" id="totalEarnings" style="font-size: 36px;">$0.00</div>
                    <div class="earnings-sub">Lifetime</div>
                    <div class="earnings-breakdown">
                        <div class="earnings-row">
                            <span class="label">Claimed</span>
                            <span class="value" id="claimedValue" style="color: var(--text-primary);">$0.00</span>
                        </div>
                        <div class="earnings-row">
                            <span class="label">Claimable</span>
                            <span class="value" id="pendingValue" style="color: var(--text-primary);">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="positions-card">
                <div class="positions-header">
                    <h3>Your Positions</h3>
                    <div class="btc-price-display">
                        <span class="btc-label">Live Bitcoin</span>
                        <span class="btc-value" id="positionBtcPrice">—</span>
                        <span class="btc-change" id="btcChange"></span>
                    </div>
                </div>
                <div id="positionsContainer"><div class="positions-empty">Connect wallet to view positions</div></div>
            </div>
        </section>

        <section class="section">
            <div class="section-label">Actions</div>
            <div class="actions-grid">
                <div class="action-card">
                    <div class="action-header">
                        <div class="action-icon blue">⬆</div>
                        <h3>Mint DRT</h3>
                    </div>
                    <p>Mint new tokens when market price is above $1.00</p>
                    <div class="mint-status">
                        <div class="status-row">
                            <div class="status-badge unavailable" id="mintStatusBadge">
                                <span class="dot"></span>
                                <span id="mintStatusText">Checking...</span>
                            </div>
                            <div class="tooltip-wrap" id="mintTooltipWrap" data-title="Mint Status">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text" id="mintTooltipText">Checking mint conditions...</span>
                            </div>
                        </div>
                        <div class="status-details">
                            <div class="status-detail">
                                <div class="tooltip-wrap" style="margin-left: 0;">
                                    <span class="label" style="cursor: help;">Mint Price ⓘ</span>
                                    <span class="tooltip-text" style="left: 0; transform: none;">The current spot market price. You mint new tokens at this price.</span>
                                </div>
                                <span class="value" id="dexPrice">$1.00</span>
                            </div>
                            <div class="status-detail">
                                <div class="tooltip-wrap" style="margin-left: 0;">
                                    <span class="label" style="cursor: help;">Market Pulse ⓘ</span>
                                    <span class="tooltip-text" style="left: 0; transform: none;">How much above $1 the market price of DRT is. 20% pulse means price is $1.20 and you can mint up to 20% of total supply today.</span>
                                </div>
                                <span class="value" id="pulsePercent">0%</span>
                            </div>
                            <div class="status-detail">
                                <div class="tooltip-wrap" style="margin-left: 0;">
                                    <span class="label" style="cursor: help;">Daily Cap ⓘ</span>
                                    <span class="tooltip-text" style="left: 0; transform: none;">The maximum amount of new tokens that can be minted today, as a percentage of total supply. Resets at midnight UTC.</span>
                                </div>
                                <span class="value" id="dailyCapPercent">0% of supply</span>
                            </div>
                            <div class="status-detail">
                                <span class="label">Remaining Today</span>
                                <span class="value green" id="dailyCapLeft">0 DRT</span>
                            </div>
                        </div>
                    </div>
                    <div class="input-wrap">
                        <input type="number" id="mintAmount" placeholder="0.00" step="0.01">
                        <button class="max-btn" onclick="setMaxMint()">MAX</button>
                        <span class="suffix">DRT</span>
                    </div>
                    <div class="info-row"><span class="label">Cost</span><span class="value" id="mintCost">0.00 USDC</span></div>
                    <button class="btn btn-primary" id="mintBtn" onclick="mintDRT()" disabled>Mint DRT</button>
                </div>

                <div class="action-card">
                    <div class="action-header">
                        <div class="action-icon gray">⬇</div>
                        <h3>Redeem DRT</h3>
                    </div>
                    <p>Redeem tokens for $0.95 USDC anytime</p>
                    <div class="info-row" style="margin-top: 82px;"><span class="label">Redemption Rate</span><span class="value">$0.95/DRT</span></div>
                    <div class="input-wrap">
                        <input type="number" id="redeemAmount" placeholder="0.00" step="0.01">
                        <button class="max-btn" onclick="setMaxRedeem()">MAX</button>
                        <span class="suffix">DRT</span>
                    </div>
                    <div class="info-row"><span class="label">You Receive</span><span class="value" id="redeemReceive">0.00 USDC</span></div>
                    <button class="btn btn-primary" id="redeemBtn" onclick="redeemDRT()" disabled>Redeem DRT</button>
                </div>
            </div>
        </section>

        <section class="protocol-stats">
            <div class="stats-box">
                <div class="stats-inner">
                    <div class="stat-block">
                        <div class="stat-label">Reserves</div>
                        <div class="stat-main" id="totalReserves">$0.00</div>
                        <div class="vault-row">
                            <a href="https://basescan.org/address/0x62D2547D9e4c109AA374ccdA2F9CeA553459Cd5D" target="_blank" class="vault-item">
                                <span class="vault-label">Senior Vault</span>
                                <div class="tooltip-wrap" data-title="Senior Vault">
                                    <span class="tooltip-icon" style="width:14px;height:14px;font-size:9px;background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.35);">?</span>
                                    <span class="tooltip-text" style="width:280px;">Holds $0.95 per token. Pays claims and redemptions directly. Auto-refilled by Junior Vault. Locked — no manual withdrawals.</span>
                                </div>
                                <span class="vault-amt" id="seniorVault">$0.00</span>
                            </a>
                            <a href="https://basescan.org/address/0xbeE7751c07432b56B5fb18CCf0B276059DC71FBa" target="_blank" class="vault-item">
                                <span class="vault-label">Junior Vault</span>
                                <div class="tooltip-wrap" data-title="Junior Vault">
                                    <span class="tooltip-icon" style="width:14px;height:14px;font-size:9px;background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.35);">?</span>
                                    <span class="tooltip-text" style="width:280px;">Dynamic surplus buffer. Auto-refills Senior Vault after claims. Locked — no manual withdrawals.</span>
                                </div>
                                <span class="vault-amt" id="juniorVault">$0.00</span>
                            </a>
                        </div>
                    </div>
                    <div class="stat-block">
                        <div class="stat-label">Supply</div>
                        <a href="https://basescan.org/token/0xe068Be95da35Fd9daF04e5d834aB7b8bA1d6C21E" target="_blank" class="stat-main stat-link" id="totalSupplyDisplay">0 DRT</a>
                    </div>
                    <div class="stat-block stat-ratio">
                        <div class="stat-label">Reserve / Supply</div>
                        <div class="stat-main ratio-green" id="backingRatio">100%</div>
                    </div>
                </div>
            </div>
        </section>

        <section class="how-section">
            <div class="section-header">
                <h2>How It Works</h2>
                <p>Get the most out of Bitcoin volatility</p>
            </div>
            <div class="how-grid">
                <div class="how-card">
                    <div class="how-step">1</div>
                    <h3>Get DRT</h3>
                    <p>Get DRT on Uniswap or mint it here. This locks your starting Bitcoin price. If the price goes up, you can lock in that new high anytime you want.</p>
                </div>
                <div class="how-card">
                    <div class="how-step">2</div>
                    <h3>Collect Yield</h3>
                    <p>When Bitcoin drops 0.1%, you start getting paid. The system tracks the lowest point for you, so you don't have to worry about timing the bottom.</p>
                </div>
                <div class="how-card">
                    <div class="how-step">3</div>
                    <h3>Exit Anytime</h3>
                    <p>Exit anytime, 24/7. You can swap back to USDC inside the app or sell on Uniswap for instant cash.</p>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>TDRT Protocol v13 · <a href="https://basescan.org/address/0xe068Be95da35Fd9daF04e5d834aB7b8bA1d6C21E" target="_blank">View on BaseScan</a> · Built on Base with Uniswap V4</p>
    </footer>

    <div id="toastContainer"></div>
    <div class="tooltip-overlay" id="tooltipOverlay" onclick="closeMobileTooltip()"></div>
    
    <!-- Mobile Tooltip Bottom Sheet -->
    <div class="mobile-tooltip-sheet" id="mobileTooltipSheet">
        <button class="sheet-close" onclick="closeMobileTooltip()">×</button>
        <div class="sheet-title" id="sheetTitle"></div>
        <div class="sheet-content" id="sheetContent"></div>
    </div>
    
    <!-- Wallet Picker Modal -->
    <div class="tooltip-overlay" id="walletOverlay" onclick="closeWalletModal()"></div>
    <div class="wallet-modal" id="walletModal">
        <button class="wallet-modal-close" onclick="closeWalletModal()">×</button>
        <h3>Connect Wallet</h3>
        <a class="wallet-option" onclick="openWallet('metamask')">
            <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask">
            <span>MetaMask</span>
        </a>
        <a class="wallet-option" onclick="openWallet('coinbase')">
            <img src="https://altcoinsbox.com/wp-content/uploads/2022/12/coinbase-wallet-logo.webp" alt="Coinbase Wallet">
            <span>Coinbase Wallet</span>
        </a>
        <a class="wallet-option" onclick="openWallet('trust')">
            <img src="https://trustwallet.com/assets/images/media/assets/trust_platform.svg" alt="Trust Wallet">
            <span>Trust Wallet</span>
        </a>
        <a class="wallet-option" onclick="openWallet('rainbow')">
            <img src="https://avatars.githubusercontent.com/u/48327834?s=200&v=4" alt="Rainbow">
            <span>Rainbow</span>
        </a>
    </div>

    <!-- Lock New High Confirmation Modal -->
    <div id="lockModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h3>Lock New High</h3>
            <p class="modal-desc">Update your entry price to the current BTC price for eligible positions.</p>
            <div class="modal-warning" id="lockWarning" style="display:none;"></div>
            <div class="modal-details">
                <div class="modal-row">
                    <span>Positions to update</span>
                    <span id="modalEligibleCount">0</span>
                </div>
                <div class="modal-row">
                    <span>New entry price</span>
                    <span id="modalNewPrice">$0</span>
                </div>
            </div>
            <p class="modal-note">How it works: Your wallet will show a transfer of all tokens to yourself. This is required to trigger the update, but only eligible positions (where BTC is higher than entry) will be changed. Ineligible positions remain unchanged. Your tokens stay in your wallet the entire time.</p>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeLockModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmLockNewHigh()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Claim Payout Confirmation Modal -->
    <div id="claimModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h3>Claim Payout</h3>
            <p class="modal-desc">You'll receive USDC in your wallet for your claimable positions.</p>
            <div class="modal-details">
                <div class="modal-row">
                    <span>You'll receive</span>
                    <span id="modalClaimAmount">$0.00 USDC</span>
                </div>
            </div>
            <p class="modal-note">This will reset your Bitcoin entry price to the current price for claimed positions.</p>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeClaimModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmClaimAll()">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Contract addresses - TDRT v13
        const TDRT_ADDRESS = "0xe068Be95da35Fd9daF04e5d834aB7b8bA1d6C21E";
        const SENIOR_ADDRESS = "0x62D2547D9e4c109AA374ccdA2F9CeA553459Cd5D";
        const JUNIOR_ADDRESS = "0xbeE7751c07432b56B5fb18CCf0B276059DC71FBa";
        const USDC_ADDRESS = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";
        const CBBTC_USD_FEED = "0x07DA0E54543a844a80ABE69c8A12F22B3aA59f9D";

        // ABIs - v13
        const TDRT_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function totalSupply() view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function getBtcPrice() view returns (uint256)",
            "function getDexPrice() view returns (uint256)",
            "function getPremiumBps() view returns (uint256)",
            "function getMintCapacity() view returns (uint256 capacity, uint256 used, uint256 remaining)",
            "function checkMintConditions() view returns (bool canMint, uint256 dexPrice, uint256 premiumBps, uint256 dailyCapacity, uint256 dailyUsed, uint256 dailyRemaining, uint256 trueMaxMint)",
            "function getUserLots(address) view returns (tuple(uint256 amount, uint256 anchorPrice, uint256 lowestPrice, uint256 timestamp, uint256 purchasePrice)[])",
            "function getUserStats(address) view returns (uint256 totalTokens, uint256 lotCount, uint256 averageAnchor, uint256 lowestTracked)",
            "function checkClaimStatus(address user, uint256 lotIndex) view returns (bool canClaim, uint256 potentialPayout, uint256 anchorPrice, uint256 lowestPrice, uint256 currentBtcPrice)",
            "function mint(uint256 usdcAmount)",
            "function redeem(uint256 amount)",
            "function claim(uint256 lotIndex)",
            "function transfer(address to, uint256 amount) returns (bool)",
            "event Claimed(address indexed user, uint256 lotIndex, uint256 payout, uint256 btcPriceAtClaim)"
        ];

        const VAULT_ABI = ["function balance() view returns (uint256)"];
        const ERC20_ABI = ["function approve(address, uint256) returns (bool)", "function allowance(address, address) view returns (uint256)", "function balanceOf(address) view returns (uint256)"];
        const CHAINLINK_ABI = ["function latestRoundData() view returns (uint80, int256, uint256, uint256, uint80)"];

        // State
        let provider, signer, userAddress;
        let tdrtContract, seniorContract, juniorContract, usdcContract, chainlinkContract;
        let currentMarketPrice = 1.00;
        let userLotsData = [];
        let userBalance = 0;
        let remainingDailyCap = 0;
        let refreshInterval;

        // Detect mobile
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // Wallet modal functions
        function showWalletModal() {
            document.getElementById('walletOverlay').classList.add('active');
            document.getElementById('walletModal').classList.add('active');
        }
        
        function closeWalletModal() {
            document.getElementById('walletOverlay').classList.remove('active');
            document.getElementById('walletModal').classList.remove('active');
        }
        
        function openWallet(wallet) {
            const dappUrl = window.location.href;
            const host = window.location.host + window.location.pathname;
            
            const links = {
                // MetaMask: opens MetaMask browser with the dapp
                metamask: `https://metamask.app.link/dapp/${host}`,
                // Coinbase Wallet: opens Coinbase browser with the dapp
                coinbase: `https://go.cb-w.com/dapp?cb_url=${encodeURIComponent(dappUrl)}`,
                // Trust Wallet: opens Trust browser with the dapp
                trust: `trust://open_url?coin_id=60&url=${encodeURIComponent(dappUrl)}`,
                // Rainbow: opens Rainbow browser with the dapp
                rainbow: `https://rnbwapp.com/dapp?url=${encodeURIComponent(dappUrl)}`
            };
            
            closeWalletModal();
            window.location.href = links[wallet];
        }

        // Connect wallet
        async function connectWallet() {
            // Mobile without injected wallet - show wallet picker
            if (isMobile() && !window.ethereum) {
                showWalletModal();
                return;
            }
            
            if (!window.ethereum) { 
                showToast('Please install a Web3 wallet (MetaMask, Coinbase Wallet, etc.)', 'error'); 
                return; 
            }
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum, "any");
                await provider.send("eth_requestAccounts", []);
                const network = await provider.getNetwork();
                
                if (network.chainId !== 8453) {
                    try {
                        await window.ethereum.request({ 
                            method: 'wallet_switchEthereumChain', 
                            params: [{ chainId: '0x2105' }] 
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x2105',
                                    chainName: 'Base',
                                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                    rpcUrls: ['https://mainnet.base.org'],
                                    blockExplorerUrls: ['https://basescan.org']
                                }]
                            });
                        }
                    }
                    provider = new ethers.providers.Web3Provider(window.ethereum, "any");
                }
                
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                document.getElementById('connectBtn').textContent = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
                document.getElementById('connectBtn').classList.add('connected');
                
                tdrtContract = new ethers.Contract(TDRT_ADDRESS, TDRT_ABI, signer);
                seniorContract = new ethers.Contract(SENIOR_ADDRESS, VAULT_ABI, provider);
                juniorContract = new ethers.Contract(JUNIOR_ADDRESS, VAULT_ABI, provider);
                usdcContract = new ethers.Contract(USDC_ADDRESS, ERC20_ABI, signer);
                chainlinkContract = new ethers.Contract(CBBTC_USD_FEED, CHAINLINK_ABI, provider);
                
                await refreshData();
                if (refreshInterval) clearInterval(refreshInterval);
                refreshInterval = setInterval(refreshData, 30000);
                
                showToast('Connected to Base', 'success');
            } catch (e) { 
                console.error('Connect error:', e);
                showToast(e.message, 'error'); 
            }
        }

        // Refresh all data
        async function refreshData() {
            if (!tdrtContract) return;
            try {
                // BTC price
                let currentBtc;
                try {
                    const roundData = await chainlinkContract.latestRoundData();
                    currentBtc = Number(roundData[1]) / 1e8;
                } catch (e) {
                    const btcPrice = await tdrtContract.getBtcPrice();
                    currentBtc = Number(btcPrice) / 1e8;
                }
                
                // Store for modal
                currentBtcForModal = currentBtc;
                
                // Update BTC price display in positions header
                const btcDisplay = document.getElementById('positionBtcPrice');
                if (btcDisplay) btcDisplay.textContent = '$' + currentBtc.toLocaleString(undefined, {maximumFractionDigits: 0});
                
                // 24h change indicator (placeholder - would need historical data API for real values)
                const btcChangeEl = document.getElementById('btcChange');
                if (btcChangeEl) {
                    // For now just show a neutral indicator since we don't have 24h historical data
                    btcChangeEl.textContent = '';
                }

                // DEX price
                const dexPrice = await tdrtContract.getDexPrice();
                currentMarketPrice = Number(dexPrice) / 1e6;
                document.getElementById('drtMarketPrice').textContent = '$' + currentMarketPrice.toFixed(2);
                document.getElementById('dexPrice').textContent = '$' + currentMarketPrice.toFixed(4);

                // Balance (v8 uses 6 decimals)
                const bal = await tdrtContract.balanceOf(userAddress);
                const balNum = Number(bal) / 1e6;
                userBalance = balNum;
                document.getElementById('balanceValue').textContent = balNum.toFixed(2);

                // Portfolio value
                const portfolioValue = balNum * currentMarketPrice;
                document.getElementById('portfolioValue').textContent = '$' + portfolioValue.toFixed(2);

                // Load user lots and calculate claimable
                await loadUserLots(currentBtc);
                
                // Button states
                document.getElementById('redeemBtn').disabled = balNum <= 0;

                await checkMintStatus();
                await loadVaultData();
                await loadPositions(currentBtc);
            } catch (e) { 
                console.error('refreshData error:', e); 
            }
        }

        // Load user lots
        async function loadUserLots(currentBtc) {
            try {
                const lots = await tdrtContract.getUserLots(userAddress);
                userLotsData = [];
                let totalClaimable = 0;

                for (let i = 0; i < lots.length; i++) {
                    const lot = lots[i];
                    const amt = Number(lot.amount) / 1e6;
                    if (amt < 0.0001) continue;

                    try {
                        const status = await tdrtContract.checkClaimStatus(userAddress, i);
                        const payout = Number(status.potentialPayout) / 1e6;
                        userLotsData.push({
                            index: i,
                            amount: amt,
                            anchorPrice: Number(lot.anchorPrice) / 1e8,
                            lowestPrice: Number(status.lowestPrice) / 1e8,  // Use effectiveLowest from checkClaimStatus
                            timestamp: Number(lot.timestamp),
                            purchasePrice: Number(lot.purchasePrice) / 1e6,
                            canClaim: status.canClaim,
                            payout: payout
                        });
                        totalClaimable += payout;
                    } catch (e) {
                        userLotsData.push({
                            index: i,
                            amount: amt,
                            anchorPrice: Number(lot.anchorPrice) / 1e8,
                            lowestPrice: Number(lot.lowestPrice) / 1e8,  // Fallback to stored if checkClaimStatus fails
                            timestamp: Number(lot.timestamp),
                            purchasePrice: Number(lot.purchasePrice) / 1e6,
                            canClaim: false,
                            payout: 0
                        });
                    }
                }

                // Smart format: show more decimals for small amounts
                function formatUsd(val) {
                    if (val < 0.01 && val > 0) return '$' + val.toFixed(4);
                    return '$' + val.toFixed(2);
                }

                // Query historical Claimed events for this user
                let totalClaimed = 0;
                try {
                    const filter = tdrtContract.filters.Claimed(userAddress);
                    const events = await tdrtContract.queryFilter(filter);
                    totalClaimed = events.reduce((sum, e) => sum + Number(e.args.payout) / 1e6, 0);
                } catch (e) {
                    console.log('Could not query claim history:', e);
                }

                const totalEarnings = totalClaimed + totalClaimable;

                document.getElementById('claimableValue').textContent = formatUsd(totalClaimable);
                document.getElementById('claimedValue').textContent = formatUsd(totalClaimed);
                document.getElementById('pendingValue').textContent = formatUsd(totalClaimable);
                document.getElementById('totalEarnings').textContent = formatUsd(totalEarnings);
                document.getElementById('claimBtn').disabled = totalClaimable <= 0;
            } catch (e) {
                console.error('loadUserLots error:', e);
                userLotsData = [];
            }
        }

        // Countdown interval for cap reset
        let countdownInterval;

        function getTimeUntilMidnightUTC() {
            const now = new Date();
            const midnight = new Date(now);
            midnight.setUTCDate(midnight.getUTCDate() + 1);
            midnight.setUTCHours(0, 0, 0, 0);
            const diff = midnight - now;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            return hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
        }

        function startCapCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                const tooltip = document.getElementById('mintTooltipText');
                if (tooltip && remainingDailyCap < 0.01) {
                    tooltip.textContent = 'Daily mint cap reached. Unlocks at midnight UTC (in ' + getTimeUntilMidnightUTC() + ') or if market price rises.';
                }
            }, 1000);
        }

        // Check mint status - v13 elastic cap with Market Pulse and true max
        let trueMaxMintable = 0;
        async function checkMintStatus() {
            try {
                const c = await tdrtContract.checkMintConditions();
                const canMint = c.canMint;
                const dexPrice = Number(c.dexPrice) / 1e6;
                const premiumBps = Number(c.premiumBps);
                const pulsePercent = premiumBps / 100;
                const dailyCapacity = Number(c.dailyCapacity) / 1e6;
                const dailyUsed = Number(c.dailyUsed) / 1e6;
                remainingDailyCap = Number(c.dailyRemaining) / 1e6;
                trueMaxMintable = Number(c.trueMaxMint) / 1e6;

                document.getElementById('pulsePercent').textContent = '+' + pulsePercent.toFixed(1) + '%';
                document.getElementById('dailyCapPercent').textContent = pulsePercent.toFixed(1) + '% of supply';
                document.getElementById('dailyCapLeft').textContent = trueMaxMintable.toFixed(2) + ' DRT';

                const badge = document.getElementById('mintStatusBadge');
                const text = document.getElementById('mintStatusText');
                const tooltip = document.getElementById('mintTooltipText');
                const mintBtn = document.getElementById('mintBtn');

                if (dexPrice <= 1.00) {
                    // Price at or below $1.00 - closed
                    badge.className = 'status-badge unavailable';
                    text.textContent = 'Closed';
                    tooltip.innerHTML = 'Minting is closed. Market price must be above $1.00 to mint new tokens. Current price: $' + dexPrice.toFixed(4) + ' <a href="https://app.uniswap.org/swap?chain=base&inputCurrency=0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913&outputCurrency=0xe068Be95da35Fd9daF04e5d834aB7b8bA1d6C21E" target="_blank" style="color:#007aff;text-decoration:none;font-weight:600;">Trade →</a>';
                    mintBtn.disabled = true;
                    if (countdownInterval) clearInterval(countdownInterval);
                } else if (remainingDailyCap < 0.01) {
                    // Cap reached
                    badge.className = 'status-badge capped';
                    text.textContent = 'Cap Reached';
                    tooltip.innerHTML = 'Daily mint cap reached. Unlocks at midnight UTC (in ' + getTimeUntilMidnightUTC() + ') or if market price rises. <a href="https://app.uniswap.org/swap?chain=base&inputCurrency=0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913&outputCurrency=0xe068Be95da35Fd9daF04e5d834aB7b8bA1d6C21E" target="_blank" style="color:#007aff;text-decoration:none;font-weight:600;">Trade →</a>';
                    mintBtn.disabled = true;
                    startCapCountdown();
                } else {
                    // Open for minting
                    badge.className = 'status-badge available';
                    text.textContent = 'Open';
                    tooltip.textContent = 'Minting is open. Available when market price is above $1.00, capped at ' + pulsePercent.toFixed(1) + '% of total supply today.';
                    mintBtn.disabled = false;
                    if (countdownInterval) clearInterval(countdownInterval);
                }
            } catch (e) {
                console.error('checkMintStatus error:', e);
                document.getElementById('mintStatusText').textContent = 'Error';
            }
        }

        // Load vault data (works without wallet connection)
        async function loadVaultData() {
            try {
                // Use read-only provider if no wallet connected
                const readProvider = provider || new ethers.providers.JsonRpcProvider('https://mainnet.base.org');
                const seniorRead = new ethers.Contract(SENIOR_ADDRESS, VAULT_ABI, readProvider);
                const juniorRead = new ethers.Contract(JUNIOR_ADDRESS, VAULT_ABI, readProvider);
                const tdrtRead = new ethers.Contract(TDRT_ADDRESS, ["function totalSupply() view returns (uint256)"], readProvider);
                
                const seniorBal = await seniorRead.balance();
                const juniorBal = await juniorRead.balance();
                const supply = await tdrtRead.totalSupply();
                const senior = Number(seniorBal) / 1e6;
                const junior = Number(juniorBal) / 1e6;
                const totalSupply = Number(supply) / 1e6;
                const totalReserves = senior + junior;
                const reservePerToken = totalSupply > 0 ? (totalReserves / totalSupply * 100).toFixed(0) : 100;
                
                document.getElementById('seniorVault').textContent = '$' + senior.toFixed(2);
                document.getElementById('juniorVault').textContent = '$' + junior.toFixed(2);
                document.getElementById('totalReserves').textContent = '$' + totalReserves.toFixed(2);
                document.getElementById('totalSupplyDisplay').textContent = totalSupply.toFixed(2) + ' DRT';
                document.getElementById('backingRatio').textContent = reservePerToken + '%';
            } catch (e) { 
                console.error('loadVaultData error:', e); 
            }
        }
        
        // Load vault data on page load
        document.addEventListener('DOMContentLoaded', loadVaultData);

        // Load positions table
        let anyLotCanRelock = false;
        async function loadPositions(currentBtc) {
            const container = document.getElementById('positionsContainer');
            anyLotCanRelock = false;
            
            if (userLotsData.length === 0) {
                container.innerHTML = '<div class="positions-empty"><a href="https://app.uniswap.org/swap?chain=base&inputCurrency=0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913&outputCurrency=0xe068Be95da35Fd9daF04e5d834aB7b8bA1d6C21E" target="_blank">Buy DRT</a> on Uniswap to get started.</div>';
                return;
            }

            let html = `<table class="positions-table"><thead><tr>
                <th>Opened</th>
                <th>Amount</th>
                <th><div class="tooltip-wrap"><span style="cursor:help;">Entry BTC ⓘ</span><span class="tooltip-text" style="width:220px;">The BTC price when you acquired this position. You can lock new high when BTC price is higher.</span></div></th>
                <th><button class="lock-header-btn" id="lockNewHighBtn" onclick="lockNewHigh()" disabled>↑ Lock New High</button><div class="tooltip-wrap" data-title="↑ Lock New High"><span class="tooltip-icon" style="margin-left:4px;">?</span><span class="tooltip-text" style="width:220px;">Lock current BTC price as your new entry. Only available when BTC is higher than your entry.</span></div></th>
                <th><div class="tooltip-wrap"><span style="cursor:help;">Claim Below ⓘ</span><span class="tooltip-text" style="width:200px;">You can claim payouts when BTC drops 0.1% from your entry.</span></div></th>
                <th><div class="tooltip-wrap"><span style="cursor:help;">Tracked Low ⓘ</span><span class="tooltip-text" style="width:200px;">The lowest BTC price recorded since you opened this position. Payouts are based on this.</span></div></th>
                <th>Claimable</th>
                <th></th>
            </tr></thead><tbody>`;

            // Sort by timestamp (newest first)
            const sortedLots = [...userLotsData].sort((a, b) => b.timestamp - a.timestamp);

            sortedLots.forEach((lot) => {
                const date = new Date(lot.timestamp * 1000).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const lowest = lot.lowestPrice; // Show actual stored lowest, not min(stored, current)
                const changePercent = ((lowest - lot.anchorPrice) / lot.anchorPrice) * 100;
                
                // Fix 7: Handle 0% case specially
                let changeDisplay;
                if (Math.abs(changePercent) < 0.05) {
                    changeDisplay = '<span class="change-indicator muted">0.0%</span>';
                } else if (changePercent < 0) {
                    changeDisplay = `<span class="change-indicator red">▼ ${Math.abs(changePercent).toFixed(1)}%</span>`;
                } else {
                    changeDisplay = `<span class="change-indicator green">▲ ${Math.abs(changePercent).toFixed(1)}%</span>`;
                }
                
                // Fix 5 & 6: Relock status with button-like styling and hover text
                const canRelock = currentBtc > lot.anchorPrice;
                if (canRelock) anyLotCanRelock = true;
                const relockStatus = canRelock 
                    ? `<span class="relock-chip available" title="Click 'Lock New High' to update entry to $${currentBtc.toLocaleString(undefined, {maximumFractionDigits: 0})}">↑ $${currentBtc.toLocaleString(undefined, {maximumFractionDigits: 0})}</span>` 
                    : `<span class="relock-chip current" title="Entry is at or above current BTC price">Current</span>`;

                html += `<tr>
                    <td class="muted">${date}</td>
                    <td class="bold">${lot.amount.toFixed(2)} DRT</td>
                    <td>$${lot.anchorPrice.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                    <td>${relockStatus}</td>
                    <td>$${(lot.anchorPrice * 0.999).toLocaleString(undefined, {maximumFractionDigits: 0})} <span class="deductible-tag">-0.1%</span></td>
                    <td>$${lowest.toLocaleString(undefined, {maximumFractionDigits: 0})} ${changeDisplay}</td>
                    <td class="green">${lot.payout < 0.01 && lot.payout > 0 ? '$' + lot.payout.toFixed(4) : '$' + lot.payout.toFixed(2)}</td>
                    <td>${lot.canClaim ? `<button onclick="claimLot(${lot.index})" style="background:var(--green);color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;">Claim</button>` : ''}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = '<div class="positions-table-wrapper">' + html + '</div>';
            
            // Enable/disable Lock New High button
            const lockBtn = document.getElementById('lockNewHighBtn');
            if (lockBtn) lockBtn.disabled = !anyLotCanRelock;
        }

        // Mint DRT - v8 takes USDC amount, user enters DRT
        async function mintDRT() {
            const drtAmt = document.getElementById('mintAmount').value;
            if (!drtAmt || parseFloat(drtAmt) <= 0) return;
            
            const btn = document.getElementById('mintBtn');
            const originalText = btn.innerHTML;
            
            try {
                // Calculate USDC cost from DRT amount
                const drtAmount = parseFloat(drtAmt);
                const usdcCost = drtAmount * currentMarketPrice;
                const usdcAmount = ethers.utils.parseUnits(usdcCost.toFixed(6), 6);
                
                const allow = await usdcContract.allowance(userAddress, TDRT_ADDRESS);
                
                if (allow.lt(usdcAmount)) {
                    btn.innerHTML = '<span class="spinner"></span> Approving...';
                    btn.disabled = true;
                    const approveTx = await usdcContract.approve(TDRT_ADDRESS, ethers.constants.MaxUint256);
                    await approveTx.wait();
                }
                
                btn.innerHTML = '<span class="spinner"></span> Minting...';
                btn.disabled = true;
                const mintTx = await tdrtContract.mint(usdcAmount);
                await mintTx.wait();
                
                showToast('Minted ' + drtAmt + ' DRT successfully!', 'success');
                document.getElementById('mintAmount').value = '';
                document.getElementById('mintCost').textContent = '0.00 USDC';
                setTimeout(refreshData, 2000);
            } catch (e) { 
                console.error('Mint error:', e);
                showToast(e.reason || e.message, 'error'); 
            }
            btn.innerHTML = originalText;
            await checkMintStatus();
        }

        // Redeem DRT
        async function redeemDRT() {
            const amt = document.getElementById('redeemAmount').value;
            if (!amt || parseFloat(amt) <= 0) return;
            
            const btn = document.getElementById('redeemBtn');
            btn.innerHTML = '<span class="spinner"></span> Redeeming...';
            btn.disabled = true;
            
            try {
                const amount = ethers.utils.parseUnits(amt, 6);
                const tx = await tdrtContract.redeem(amount);
                await tx.wait();
                showToast('Redeemed ' + amt + ' DRT for ' + (parseFloat(amt) * 0.95).toFixed(2) + ' USDC', 'success');
                document.getElementById('redeemAmount').value = '';
                document.getElementById('redeemReceive').textContent = '0.00 USDC';
                setTimeout(refreshData, 2000);
            } catch (e) { 
                console.error('Redeem error:', e);
                showToast(e.reason || e.message, 'error'); 
            }
            btn.innerHTML = 'Redeem DRT';
            btn.disabled = false;
        }

        // Claim single lot
        async function claimLot(lotIndex) {
            try {
                showToast('Claiming...', 'success');
                const tx = await tdrtContract.claim(lotIndex);
                await tx.wait();
                showToast('Claimed successfully!', 'success');
                setTimeout(refreshData, 2000);
            } catch (e) {
                console.error('Claim error:', e);
                showToast(e.reason || e.message, 'error');
            }
        }

        // Claim all claimable lots - show modal first
        function claimAll() {
            const claimableLots = userLotsData.filter(l => l.canClaim);
            if (claimableLots.length === 0) return;
            
            // Calculate total claimable
            const totalClaimable = claimableLots.reduce((sum, lot) => sum + lot.payout, 0);
            
            // Smart format for modal
            const formattedAmount = totalClaimable < 0.01 && totalClaimable > 0 
                ? '$' + totalClaimable.toFixed(4) + ' USDC'
                : '$' + totalClaimable.toFixed(2) + ' USDC';
            
            // Populate modal
            document.getElementById('modalClaimAmount').textContent = formattedAmount;
            
            // Show modal
            document.getElementById('claimModal').style.display = 'flex';
        }
        
        function closeClaimModal() {
            document.getElementById('claimModal').style.display = 'none';
        }
        
        // Actually execute the claim after confirmation
        async function confirmClaimAll() {
            closeClaimModal();
            
            const claimableLots = userLotsData.filter(l => l.canClaim);
            if (claimableLots.length === 0) return;

            const btn = document.getElementById('claimBtn');
            btn.innerHTML = '<span class="spinner"></span> Claiming...';
            btn.disabled = true;

            try {
                for (const lot of claimableLots) {
                    const tx = await tdrtContract.claim(lot.index);
                    await tx.wait();
                }
                showToast('All claims processed!', 'success');
                setTimeout(refreshData, 2000);
            } catch (e) {
                console.error('Claim error:', e);
                showToast(e.reason || e.message, 'error');
            }
            btn.innerHTML = 'Claim Payout';
            btn.disabled = false;
        }

        // Lock New High - show confirmation modal first
        let currentBtcForModal = 0;
        function lockNewHigh() {
            if (!anyLotCanRelock) return;
            
            // Count eligible lots and check for claimables
            const eligibleLots = userLotsData.filter(lot => currentBtcForModal > lot.anchorPrice);
            const totalClaimable = userLotsData.reduce((sum, lot) => sum + lot.payout, 0);
            
            // Populate modal
            document.getElementById('modalEligibleCount').textContent = eligibleLots.length + ' of ' + userLotsData.length;
            document.getElementById('modalNewPrice').textContent = '$' + currentBtcForModal.toLocaleString(undefined, {maximumFractionDigits: 0});
            
            // Show warning if there are unclaimed payouts
            const warningEl = document.getElementById('lockWarning');
            if (totalClaimable > 0.01) {
                warningEl.innerHTML = `⚠️ You have <strong>$${totalClaimable.toFixed(2)}</strong> unclaimed payouts in eligible positions. Locking a new high resets your position's history. If you lock now without claiming, you will lose these earnings.`;
                warningEl.style.display = 'block';
            } else {
                warningEl.style.display = 'none';
            }
            
            // Show modal
            document.getElementById('lockModal').style.display = 'flex';
        }
        
        function closeLockModal() {
            document.getElementById('lockModal').style.display = 'none';
        }
        
        // Actually execute the lock after confirmation
        async function confirmLockNewHigh() {
            closeLockModal();
            
            const btn = document.getElementById('lockNewHighBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner"></span>';
            btn.disabled = true;

            try {
                // Get user's full balance
                const balance = await tdrtContract.balanceOf(userAddress);
                if (balance == 0) {
                    showToast('No tokens to re-lock', 'error');
                    return;
                }
                
                // Self-transfer triggers anchor ratchet in _update hook
                const tx = await tdrtContract.transfer(userAddress, balance);
                await tx.wait();
                
                showToast('Locked at new high! Your entry prices have been updated.', 'success');
                setTimeout(refreshData, 2000);
            } catch (e) {
                console.error('Lock error:', e);
                showToast(e.reason || e.message, 'error');
            }
            btn.innerHTML = originalText;
            btn.disabled = !anyLotCanRelock;
        }

        // Input handlers
        document.getElementById('mintAmount').addEventListener('input', e => {
            const drt = parseFloat(e.target.value) || 0;
            const usdcCost = drt * currentMarketPrice;
            document.getElementById('mintCost').textContent = usdcCost.toFixed(2) + ' USDC';
        });

        document.getElementById('redeemAmount').addEventListener('input', e => {
            const drt = parseFloat(e.target.value) || 0;
            document.getElementById('redeemReceive').textContent = (drt * 0.95).toFixed(2) + ' USDC';
        });

        // Max buttons - v13 uses true max from contract (geometric series limit)
        function setMaxMint() {
            // Use trueMaxMintable directly from contract (no rounding down)
            const safeMax = Math.max(0, trueMaxMintable);
            document.getElementById('mintAmount').value = safeMax.toFixed(6);
            document.getElementById('mintCost').textContent = (safeMax * currentMarketPrice).toFixed(2) + ' USDC';
        }

        function setMaxRedeem() {
            document.getElementById('redeemAmount').value = userBalance.toFixed(6);
            document.getElementById('redeemReceive').textContent = (userBalance * 0.95).toFixed(2) + ' USDC';
        }

        // Toast
        function showToast(msg, type = 'success') {
            const t = document.createElement('div');
            t.className = 'toast ' + type;
            t.innerHTML = `<span>${type === 'success' ? '✓' : '✕'}</span><span>${msg}</span>`;
            document.getElementById('toastContainer').appendChild(t);
            setTimeout(() => t.remove(), 4000);
        }

        // Auto-connect on page load
        document.addEventListener('DOMContentLoaded', async () => {
            if (window.ethereum) {
                try {
                    // Only auto-connect if wallet already authorized (no popup)
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        await connectWallet();
                    }
                } catch (e) {
                    console.log('Auto-connect failed:', e);
                }
            }
        });

        // Handle account/chain changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', a => a.length ? connectWallet() : location.reload());
            window.ethereum.on('chainChanged', () => location.reload());
        }

        // Mobile tooltip - bottom sheet style
        const tooltipData = {
            'Ultra Transparent': 'All reserves and contracts are open-source and visible on-chain. Verify anytime on Basescan.',
            'Counter-Cyclical Asset': 'Earn when Bitcoin drops. Never lose value when Bitcoin rises. No expiration date. Claiming payouts doesn\'t burn your tokens — you keep them until you sell or redeem.',
            '100% Decentralized': 'No admin keys. No manual controls. Fully autonomous smart contracts.',
            'Exit Anytime': 'Redeem or sell 24/7. No lockups, no waiting periods.'
        };
        
        function closeMobileTooltip() {
            document.getElementById('tooltipOverlay').classList.remove('active');
            document.getElementById('mobileTooltipSheet').classList.remove('active');
        }
        
        function showMobileTooltip(title, content) {
            document.getElementById('sheetTitle').textContent = title;
            document.getElementById('sheetContent').textContent = content;
            document.getElementById('tooltipOverlay').classList.add('active');
            document.getElementById('mobileTooltipSheet').classList.add('active');
        }

        document.querySelectorAll('.trust-badge-item').forEach(item => {
            const handler = function(e) {
                if (window.innerWidth <= 768) {
                    e.preventDefault();
                    e.stopPropagation();
                    const titleText = this.querySelector('span').textContent.replace('✓ ', '');
                    const content = tooltipData[titleText] || '';
                    showMobileTooltip(titleText, content);
                }
            };
            // Use both click and touchstart for MetaMask browser compatibility
            item.addEventListener('click', handler);
            item.addEventListener('touchend', function(e) {
                if (window.innerWidth <= 768) {
                    e.preventDefault();
                    handler.call(this, e);
                }
            });
        });

        // Make all tooltip-wrap elements tap-to-show on mobile (using event delegation for dynamic content)
        document.addEventListener('click', function(e) {
            const tooltipWrap = e.target.closest('.tooltip-wrap');
            if (tooltipWrap && window.innerWidth <= 768) {
                e.preventDefault();
                e.stopPropagation();
                
                // Get the label text - check data-title first
                let title = tooltipWrap.getAttribute('data-title') || '';
                
                if (!title) {
                    const labelSpan = tooltipWrap.querySelector('.label, span:first-child');
                    if (labelSpan) {
                        title = labelSpan.textContent.replace(' ⓘ', '').replace('ⓘ', '').replace('?', '').trim();
                    }
                }
                // Fallback: check parent for label
                if (!title) {
                    const parent = tooltipWrap.closest('.claimable-label, .earnings-label, .status-detail, th');
                    if (parent) {
                        const text = parent.childNodes[0];
                        if (text && text.nodeType === 3) {
                            title = text.textContent.trim();
                        } else {
                            title = parent.textContent.replace('?', '').replace('ⓘ', '').trim().split('\n')[0];
                        }
                    }
                }
                
                // Get tooltip content
                const tooltipText = tooltipWrap.querySelector('.tooltip-text');
                const content = tooltipText ? tooltipText.textContent : '';
                
                // Clean up title
                title = title.replace(/\s+/g, ' ').trim();
                
                if (content) {
                    showMobileTooltip(title || content.substring(0, 30), content);
                }
            }
        });
        
        document.addEventListener('touchend', function(e) {
            const tooltipWrap = e.target.closest('.tooltip-wrap');
            if (tooltipWrap && window.innerWidth <= 768) {
                e.preventDefault();
                
                // Get the label text - check data-title first
                let title = tooltipWrap.getAttribute('data-title') || '';
                
                if (!title) {
                    const labelSpan = tooltipWrap.querySelector('.label, span:first-child');
                    if (labelSpan) {
                        title = labelSpan.textContent.replace(' ⓘ', '').replace('ⓘ', '').replace('?', '').trim();
                    }
                }
                if (!title) {
                    const parent = tooltipWrap.closest('.claimable-label, .earnings-label, .status-detail, th');
                    if (parent) {
                        const text = parent.childNodes[0];
                        if (text && text.nodeType === 3) {
                            title = text.textContent.trim();
                        } else {
                            title = parent.textContent.replace('?', '').replace('ⓘ', '').trim().split('\n')[0];
                        }
                    }
                }
                
                const tooltipText = tooltipWrap.querySelector('.tooltip-text');
                const content = tooltipText ? tooltipText.textContent : '';
                
                title = title.replace(/\s+/g, ' ').trim();
                
                if (content) {
                    showMobileTooltip(title || content.substring(0, 30), content);
                }
            }
        });
    </script>
</body>
</html>
