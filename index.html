<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TDRT Protocol | Test De-Risk Token</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        :root {
            --bg: #f5f5f7;
            --bg-white: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #515154;
            --text-muted: #86868b;
            --border: #d2d2d7;
            --green: #34c759;
            --red: #ff3b30;
            --blue: #007aff;
            --radius: 12px;
            --radius-lg: 16px;
            --shadow: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-hover: 0 8px 24px rgba(0,0,0,0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Header */
        header {
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding: 0 24px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo-mark {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #1d1d1f, #515154);
            border-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 9px;
            color: #fff;
            letter-spacing: 0.3px;
        }
        .logo-text {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .header-actions {
            display: flex;
            align-items: center;
            gap: 24px;
        }
        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            transition: color 0.2s;
        }
        .nav-link:hover { color: var(--text-primary); }
        .connect-btn {
            background: var(--text-primary);
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .connect-btn:hover { opacity: 0.85; }
        .connect-btn.connected {
            background: var(--bg);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        /* Price Ticker */
        .price-ticker {
            background: var(--bg-white);
            border-bottom: 1px solid rgba(0,0,0,0.06);
            padding: 12px 24px;
            display: flex;
            justify-content: center;
            gap: 40px;
            font-size: 13px;
        }
        .ticker-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ticker-label {
            color: var(--text-muted);
            font-weight: 500;
        }
        .ticker-price {
            font-weight: 600;
            color: var(--text-primary);
        }
        .ticker-change {
            font-size: 12px;
            font-weight: 600;
        }
        .ticker-change.up { color: var(--green); }
        .ticker-change.down { color: var(--red); }
        .ticker-change.neutral { color: var(--text-muted); }

        /* Main */
        main {
            max-width: 980px;
            margin: 0 auto;
            padding: 48px 24px 80px;
        }

        /* Hero */
        .hero {
            text-align: center;
            padding: 24px 0 56px;
        }
        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--green);
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        .hero-badge .dot {
            width: 6px;
            height: 6px;
            background: var(--green);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .hero h1 {
            font-size: 52px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -2px;
            margin-bottom: 12px;
            line-height: 1.05;
        }
        .hero h1 .gradient {
            background: linear-gradient(90deg, #007aff, #5856d6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .hero-subtitle {
            font-size: 19px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* Section */
        .section { margin-bottom: 24px; }
        .section-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        /* Tooltip */
        .tooltip-wrap {
            position: relative;
            display: inline-flex;
        }
        .tooltip-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--bg);
            color: var(--text-muted);
            font-size: 10px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: help;
            margin-left: 6px;
        }
        .tooltip-icon:hover { color: var(--text-secondary); }
        .tooltip-text {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-primary);
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 400;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            z-index: 50;
        }
        .tooltip-wrap:hover .tooltip-text {
            opacity: 1;
            visibility: visible;
        }

        /* Cards */
        .card-grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .card-grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        
        .metric-card {
            background: var(--bg-white);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }
        .metric-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }
        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -1px;
        }
        .metric-value.green { color: var(--green); }
        .metric-value.red { color: var(--red); }
        .metric-sub {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Positions */
        .positions-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 24px;
        }
        .positions-header {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
        }
        .positions-header h3 {
            font-size: 14px;
            font-weight: 600;
        }
        .positions-table {
            width: 100%;
            border-collapse: collapse;
        }
        .positions-table th {
            text-align: left;
            padding: 12px 16px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--bg);
        }
        .positions-table td {
            padding: 14px 16px;
            font-size: 13px;
            border-bottom: 1px solid rgba(0,0,0,0.04);
        }
        .positions-table tr:last-child td { border-bottom: none; }
        .positions-table tr:hover { background: var(--bg); }
        .positions-table .green { color: var(--green); font-weight: 600; }
        .positions-table .muted { color: var(--text-muted); }
        .positions-table .bold { font-weight: 600; }
        .positions-empty {
            padding: 48px;
            text-align: center;
            color: var(--text-muted);
        }

        /* Actions */
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 32px;
        }
        .action-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }
        .action-card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }
        .action-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        .action-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        .action-icon.blue { background: rgba(0, 122, 255, 0.1); color: var(--blue); }
        .action-icon.gray { background: var(--bg); color: var(--text-secondary); }
        .action-icon.green { background: rgba(52, 199, 89, 0.1); color: var(--green); }
        .action-card h3 {
            font-size: 16px;
            font-weight: 600;
        }
        .action-card > p {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .mint-status {
            background: var(--bg);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .status-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
        }
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        .status-dot.active { background: var(--green); }
        .status-dot.inactive { background: var(--red); }
        .status-text {
            font-size: 12px;
            font-weight: 600;
        }
        .status-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .status-detail {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
        }
        .status-detail .label { color: var(--text-muted); }
        .status-detail .value { font-weight: 600; color: var(--text-secondary); }

        .claim-display {
            text-align: center;
            padding: 24px 0;
        }
        .claim-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .claim-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--green);
            letter-spacing: -1px;
        }
        .claim-note {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 13px;
            border-bottom: 1px solid rgba(0,0,0,0.04);
        }
        .info-row:last-of-type { border-bottom: none; }
        .info-row .label { color: var(--text-muted); }
        .info-row .value { font-weight: 600; }

        .input-wrap {
            position: relative;
            margin-bottom: 8px;
        }
        .input-wrap input {
            width: 100%;
            background: var(--bg);
            border: none;
            border-radius: 10px;
            padding: 14px 50px 14px 16px;
            font-family: inherit;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            outline: none;
        }
        .input-wrap input:focus {
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
        }
        .input-wrap .suffix {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
        }
        .btn-primary {
            background: var(--text-primary);
            color: #fff;
        }
        .btn-primary:hover { opacity: 0.85; }
        .btn-green {
            background: var(--green);
            color: #fff;
        }
        .btn-green:hover { opacity: 0.9; }
        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Reserves */
        .reserves-box {
            background: linear-gradient(135deg, #1d1d1f, #3a3a3c);
            border-radius: var(--radius-lg);
            padding: 32px;
            margin-bottom: 48px;
            color: #fff;
        }
        .reserves-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 28px;
        }
        .reserves-icon {
            width: 44px;
            height: 44px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .reserves-title {
            font-size: 18px;
            font-weight: 600;
        }
        .reserves-subtitle {
            font-size: 13px;
            color: rgba(255,255,255,0.5);
            margin-top: 2px;
        }
        .reserves-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }
        .reserve-item {
            background: rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .reserve-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 6px;
        }
        .reserve-label-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-bottom: 4px;
        }
        .reserve-label {
            font-size: 11px;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .reserve-tip {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            color: rgba(255,255,255,0.6);
            font-size: 9px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: help;
            position: relative;
        }
        .reserve-tip:hover { background: rgba(255,255,255,0.25); color: #fff; }
        .reserve-tip-text {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }
        .reserve-tip:hover .reserve-tip-text {
            opacity: 1;
            visibility: visible;
        }
        .reserve-tag {
            font-size: 11px;
            color: rgba(255,255,255,0.35);
        }
        .reserve-link {
            display: inline-block;
            font-size: 11px;
            color: var(--blue);
            text-decoration: none;
            margin-top: 10px;
            font-weight: 500;
        }
        .reserve-link:hover { text-decoration: underline; }
        .reserves-footer {
            display: flex;
            justify-content: center;
            gap: 28px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .reserves-footer span {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
        }
        .reserves-footer .check { color: var(--green); margin-right: 6px; }

        /* How */
        .how-section { margin-bottom: 48px; }
        .section-header {
            text-align: center;
            margin-bottom: 28px;
        }
        .section-header h2 {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -1px;
            margin-bottom: 8px;
        }
        .section-header p {
            color: var(--text-muted);
            font-size: 16px;
        }
        .how-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        .how-card {
            background: var(--bg-white);
            border-radius: var(--radius);
            padding: 24px 20px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }
        .how-card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }
        .how-step {
            width: 32px;
            height: 32px;
            background: var(--text-primary);
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            margin: 0 auto 14px;
        }
        .how-card h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .how-card p {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        /* Trust */
        .trust-box {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 28px;
            box-shadow: var(--shadow);
        }
        .trust-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        .trust-icon { font-size: 24px; }
        .trust-header h4 {
            font-size: 16px;
            font-weight: 600;
        }
        .trust-header p {
            font-size: 13px;
            color: var(--text-muted);
        }
        .trust-vaults {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .trust-vault {
            background: var(--bg);
            border-radius: var(--radius);
            padding: 18px;
        }
        .trust-vault h5 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
        }
        .trust-vault p {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 68px;
            right: 20px;
            z-index: 1000;
        }
        .toast {
            background: var(--bg-white);
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-hover);
            animation: slideIn 0.3s ease;
            font-size: 13px;
            font-weight: 500;
        }
        .toast.success { border-left: 3px solid var(--green); }
        .toast.error { border-left: 3px solid var(--red); }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid var(--border);
            border-top-color: var(--text-primary);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Footer */
        footer {
            text-align: center;
            padding: 24px;
            border-top: 1px solid rgba(0,0,0,0.06);
        }
        footer a {
            color: var(--blue);
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
        }
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 8px;
        }
        footer p {
            color: var(--text-muted);
            font-size: 12px;
        }

        @media (max-width: 900px) {
            .card-grid-4 { grid-template-columns: repeat(2, 1fr); }
            .how-grid { grid-template-columns: repeat(2, 1fr); }
            .actions-grid { grid-template-columns: 1fr; }
            .reserves-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 600px) {
            .hero h1 { font-size: 36px; }
            .card-grid-3 { grid-template-columns: 1fr; }
            .trust-vaults { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <div class="logo-mark">DRT</div>
            <span class="logo-text">DRT Protocol</span>
        </div>
        <div class="header-actions">
            <a href="#how-it-works" class="nav-link">How It Works</a>
            <button class="connect-btn" id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
        </div>
    </header>

    <div class="price-ticker">
        <div class="ticker-item">
            <span class="ticker-label">DRT</span>
            <span class="ticker-price" id="drtMarketPrice">$0.95</span>
            <span class="ticker-change neutral" id="drtChange">0.00%</span>
        </div>
        <div class="ticker-item">
            <span class="ticker-label">BTC</span>
            <span class="ticker-price" id="btcPrice">$0</span>
            <span class="ticker-change neutral" id="btcChange">0.00%</span>
        </div>
    </div>

    <main>
        <section class="hero">
            <div class="hero-badge"><span class="dot"></span> Live on Base</div>
            <h1>Bitcoin <span class="gradient">De-Risk</span> Token</h1>
            <p class="hero-subtitle">Earn when Bitcoin drops. Exit anytime with full liquidity.</p>
        </section>

        <section class="section">
            <div class="section-label">Your Portfolio</div>
            <div class="card-grid-4">
                <div class="metric-card">
                    <div class="metric-label">DRT Balance <span class="tooltip-wrap"><span class="tooltip-icon">?</span><span class="tooltip-text">Total DRT tokens you own</span></span></div>
                    <div class="metric-value" id="balanceValue">0.00</div>
                    <div class="metric-sub">DRT</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Value <span class="tooltip-wrap"><span class="tooltip-icon">?</span><span class="tooltip-text">Balance √ó market price</span></span></div>
                    <div class="metric-value" id="portfolioValue">$0.00</div>
                    <div class="metric-sub">USD</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Avg Cost <span class="tooltip-wrap"><span class="tooltip-icon">?</span><span class="tooltip-text">Average price per DRT</span></span></div>
                    <div class="metric-value" id="costBasis">$0.00</div>
                    <div class="metric-sub">Per DRT</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">P&L <span class="tooltip-wrap"><span class="tooltip-icon">?</span><span class="tooltip-text">Profit/Loss since purchase</span></span></div>
                    <div class="metric-value" id="pnlValue">$0.00</div>
                    <div class="metric-sub" id="pnlPercent">0%</div>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="section-label">Earnings</div>
            <div class="card-grid-3">
                <div class="metric-card">
                    <div class="metric-label">Claimable <span class="tooltip-wrap"><span class="tooltip-icon">?</span><span class="tooltip-text">Ready to claim now</span></span></div>
                    <div class="metric-value green" id="claimableValue">$0.00</div>
                    <div class="metric-sub">Available</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Claimed <span class="tooltip-wrap"><span class="tooltip-icon">?</span><span class="tooltip-text">Already claimed</span></span></div>
                    <div class="metric-value" id="claimedValue">$0.00</div>
                    <div class="metric-sub">All time</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Earnings <span class="tooltip-wrap"><span class="tooltip-icon">?</span><span class="tooltip-text">Claimable + Claimed</span></span></div>
                    <div class="metric-value green" id="totalEarnings">$0.00</div>
                    <div class="metric-sub">Lifetime</div>
                </div>
            </div>
        </section>

        <div class="positions-card">
            <div class="positions-header"><h3>Active Positions</h3></div>
            <div id="positionsContainer"><div class="positions-empty">Connect wallet to view positions</div></div>
        </div>

        <div class="actions-grid">
            <div class="action-card">
                <div class="action-header">
                    <div class="action-icon blue">‚ú¶</div>
                    <h3>Mint DRT</h3>
                </div>
                <p>Mint new tokens when conditions are met.</p>
                <div class="mint-status">
                    <div class="status-row">
                        <div class="status-dot" id="mintIndicator"></div>
                        <span class="status-text" id="mintStatusText">Checking...</span>
                    </div>
                    <div class="status-details">
                        <div class="status-detail"><span class="label">Market</span><span class="value" id="dexPrice">‚Äî</span></div>
                        <div class="status-detail"><span class="label">7-Day Avg</span><span class="value" id="twapPrice">‚Äî</span></div>
                        <div class="status-detail"><span class="label">Min (105%)</span><span class="value" id="thresholdPrice">‚Äî</span></div>
                    </div>
                </div>
                <div class="input-wrap">
                    <input type="number" id="mintAmount" placeholder="0.00" step="0.01">
                    <span class="suffix">DRT</span>
                </div>
                <div class="info-row"><span class="label">Cost</span><span class="value" id="mintCost">0.00 USDC</span></div>
                <button class="btn btn-primary" id="mintBtn" onclick="mintBDRT()" disabled>Mint DRT</button>
            </div>

            <div class="action-card">
                <div class="action-header">
                    <div class="action-icon gray">‚Üì</div>
                    <h3>Redeem DRT</h3>
                </div>
                <p>Convert back to USDC at $0.95 anytime.</p>
                <div class="input-wrap">
                    <input type="number" id="burnAmount" placeholder="0.00" step="0.01">
                    <span class="suffix">DRT</span>
                </div>
                <div class="info-row"><span class="label">You Receive</span><span class="value" id="burnReceive">0.00 USDC</span></div>
                <div class="info-row"><span class="label">Rate</span><span class="value">$0.95/DRT</span></div>
                <button class="btn btn-primary" id="burnBtn" onclick="burnBDRT()" disabled>Redeem DRT</button>
            </div>

            <div class="action-card">
                <div class="action-header">
                    <div class="action-icon green">‚óÜ</div>
                    <h3>Claim Payout</h3>
                </div>
                <p>Collect when BTC drops 5%+ from entry.</p>
                <div class="claim-display">
                    <div class="claim-label">Claimable Now</div>
                    <div class="claim-value" id="claimAmount">$0.00</div>
                </div>
                <div class="claim-note">See positions for details</div>
                <button class="btn btn-green" id="claimBtn" onclick="claimPayout()" disabled>Claim Payout</button>
            </div>
        </div>

        <div class="reserves-box">
            <div class="reserves-header">
                <div class="reserves-icon">üîí</div>
                <div>
                    <div class="reserves-title">Protocol Reserves</div>
                    <div class="reserves-subtitle">100% backed ¬∑ Fully transparent ¬∑ On-chain</div>
                </div>
            </div>
            <div class="reserves-grid">
                <div class="reserve-item">
                    <div class="reserve-value" id="seniorVault">$0.00</div>
                    <div class="reserve-label-row">
                        <span class="reserve-label">Senior Vault</span>
                        <span class="reserve-tip">?<span class="reserve-tip-text">Backs redemptions & payouts</span></span>
                    </div>
                    <div class="reserve-tag">‚â•$0.95/DRT</div>
                    <a href="#" class="reserve-link" id="seniorLink" target="_blank">View on Basescan ‚Üó</a>
                </div>
                <div class="reserve-item">
                    <div class="reserve-value" id="juniorVault">$0.00</div>
                    <div class="reserve-label-row">
                        <span class="reserve-label">Junior Vault</span>
                        <span class="reserve-tip">?<span class="reserve-tip-text">Safety buffer for Senior</span></span>
                    </div>
                    <div class="reserve-tag">‚â•$0.05/DRT</div>
                    <a href="#" class="reserve-link" id="juniorLink" target="_blank">View on Basescan ‚Üó</a>
                </div>
                <div class="reserve-item">
                    <div class="reserve-value" id="totalSupply">0</div>
                    <div class="reserve-label-row">
                        <span class="reserve-label">Total Supply</span>
                    </div>
                    <div class="reserve-tag">DRT</div>
                    <a href="#" class="reserve-link" id="tokenLink" target="_blank">View Token ‚Üó</a>
                </div>
            </div>
            <div class="reserves-footer">
                <span><span class="check">‚úì</span>On-chain</span>
                <span><span class="check">‚úì</span>No admin keys</span>
                <span><span class="check">‚úì</span>Immutable</span>
            </div>
        </div>

        <section class="how-section" id="how-it-works">
            <div class="section-header">
                <h2>How It Works</h2>
                <p>Simple, transparent, fully trustless</p>
            </div>
            <div class="how-grid">
                <div class="how-card">
                    <div class="how-step">1</div>
                    <h3>Earn When BTC Drops</h3>
                    <p>Buy DRT and earn when Bitcoin drops 5%+ from your entry.</p>
                </div>
                <div class="how-card">
                    <div class="how-step">2</div>
                    <h3>Maximize Earnings</h3>
                    <p>Payout based on lowest BTC. Rebounds don't reduce it.</p>
                </div>
                <div class="how-card">
                    <div class="how-step">3</div>
                    <h3>Get More DRT</h3>
                    <p>Mint from protocol or buy from DEX anytime.</p>
                </div>
                <div class="how-card">
                    <div class="how-step">4</div>
                    <h3>Exit Anytime</h3>
                    <p>Redeem at $0.95 or sell on exchange. No lockups.</p>
                </div>
            </div>
        </section>

        <div class="trust-box">
            <div class="trust-header">
                <span class="trust-icon">üè¶</span>
                <div>
                    <h4>Two-Vault Architecture</h4>
                    <p>Every DRT backed by on-chain reserves</p>
                </div>
            </div>
            <div class="trust-vaults">
                <div class="trust-vault">
                    <h5>Senior Vault (‚â•$0.95/DRT)</h5>
                    <p>Reserved for redemptions and claim payouts. Topped up from Junior when needed.</p>
                </div>
                <div class="trust-vault">
                    <h5>Junior Vault (‚â•$0.05/DRT)</h5>
                    <p>Safety buffer supporting Senior. Funded from excess reserves.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- DEBUG SECTION -->
    <div style="max-width:980px; margin:0 auto; padding:24px;">
        <div style="background:#1d1d1f; color:#fff; border-radius:12px; padding:24px;">
            <h3 style="margin-bottom:16px;">üîß Debug Output</h3>
            <pre id="debugOutput" style="background:#2d2d2f; padding:16px; border-radius:8px; overflow:auto; font-size:12px; max-height:400px;">Waiting for wallet connection...</pre>
        </div>
    </div>

    <footer>
        <div class="footer-links">
            <a href="#" id="contractLink" target="_blank">Smart Contract</a>
            <a href="#how-it-works">Docs</a>
        </div>
        <p>DRT Protocol ‚Äî Trustless Bitcoin Volatility Infrastructure</p>
    </footer>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        // TDRT Mainnet Contract Addresses
        const CONTRACTS = {
            BDRT: "0x601F382DF787fe54815214B6c46739D1b94E1aC5",
            SENIOR: "0x356fdc4369c752d566c3046941af477A05aD8274",
            JUNIOR: "0x66B69E02Ca6FB8173Bc4C08955d8F8c82AE0783F",
            USDC: "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",
            POOL: "0x28B0CA48277C1b322B78E2aaE22EE6ddD63372Cf"
        };

        // TDRT ABI (no purchasePrice in Lot, no getUserStats)
        const BDRT_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function totalSupply() view returns (uint256)",
            "function getBtcPrice() view returns (uint256)",
            "function getUserLots(address) view returns (tuple(uint256 amount, uint256 anchorPrice, uint256 lowestPrice, uint256 timestamp)[])",
            "function checkClaimStatus(address) view returns (uint256, uint256, uint256)",
            "function checkMintConditions() view returns (bool, uint256, uint256, uint256, uint256)",
            "function mint(uint256 drtAmount)",
            "function burn(uint256 drtAmount)",
            "function claim()",
            "function updateLowestPrice()"
        ];

        const POOL_ABI = [
            "function slot0() view returns (uint160 sqrtPriceX96, int24 tick, uint16 observationIndex, uint16 observationCardinality, uint16 observationCardinalityNext, uint8 feeProtocol, bool unlocked)",
            "function token0() view returns (address)"
        ];

        const VAULT_ABI = ["function balance() view returns (uint256)"];
        const ERC20_ABI = ["function approve(address, uint256) returns (bool)", "function allowance(address, address) view returns (uint256)"];

        let provider, signer, userAddress, bdrtContract, seniorContract, juniorContract, usdcContract, poolContract;
        let currentMarketPrice = 1.00;
        let userLotsData = [];

        // Get price directly from Uniswap V3 pool
        async function getUniswapPrice() {
            try {
                const pool = new ethers.Contract(CONTRACTS.POOL, POOL_ABI, provider);
                const slot0 = await pool.slot0();
                const sqrtPriceX96 = slot0[0];
                const token0 = await pool.token0();
                
                // sqrtPriceX96 = sqrt(price) * 2^96
                // price (token1/token0) = (sqrtPriceX96 / 2^96)^2
                
                const sqrtPriceX96Num = Number(sqrtPriceX96);
                const Q96 = 2 ** 96;
                
                // Calculate raw price (token1 per token0)
                let rawPrice = (sqrtPriceX96Num / Q96) ** 2;
                
                // Check token order
                const tdrtIsToken0 = token0.toLowerCase() === CONTRACTS.BDRT.toLowerCase();
                
                // TDRT has 18 decimals, USDC has 6 decimals
                // Decimal adjustment = 10^(token0_decimals - token1_decimals)
                if (tdrtIsToken0) {
                    // price is USDC per TDRT
                    // Adjust: multiply by 10^(18-6) = 10^12
                    rawPrice = rawPrice * (10 ** 12);
                } else {
                    // price is TDRT per USDC, need to invert
                    // Adjust: divide by 10^(6-18) = multiply by 10^12, then invert
                    rawPrice = 1 / (rawPrice * (10 ** 12));
                }
                
                console.log('Uniswap price:', rawPrice);
                return rawPrice;
            } catch (e) {
                console.error('Uniswap price error:', e);
                return 1.00;
            }
        }

        async function connectWallet() {
            if (!window.ethereum) { showToast('Install a Web3 wallet', 'error'); return; }
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum, "any");
                await provider.send("eth_requestAccounts", []);
                const network = await provider.getNetwork();
                
                // Switch to Base mainnet (8453)
                if (network.chainId !== 8453) {
                    try {
                        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x2105' }] });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x2105',
                                    chainName: 'Base',
                                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                    rpcUrls: ['https://mainnet.base.org'],
                                    blockExplorerUrls: ['https://basescan.org']
                                }]
                            });
                        }
                    }
                    provider = new ethers.providers.Web3Provider(window.ethereum, "any");
                }
                
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                document.getElementById('connectBtn').textContent = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
                document.getElementById('connectBtn').classList.add('connected');
                
                bdrtContract = new ethers.Contract(CONTRACTS.BDRT, BDRT_ABI, signer);
                seniorContract = new ethers.Contract(CONTRACTS.SENIOR, VAULT_ABI, provider);
                juniorContract = new ethers.Contract(CONTRACTS.JUNIOR, VAULT_ABI, provider);
                usdcContract = new ethers.Contract(CONTRACTS.USDC, ERC20_ABI, signer);
                poolContract = new ethers.Contract(CONTRACTS.POOL, POOL_ABI, provider);
                
                document.getElementById('contractLink').href = `https://basescan.org/address/${CONTRACTS.BDRT}`;
                document.getElementById('seniorLink').href = `https://basescan.org/address/${CONTRACTS.SENIOR}`;
                document.getElementById('juniorLink').href = `https://basescan.org/address/${CONTRACTS.JUNIOR}`;
                document.getElementById('tokenLink').href = `https://basescan.org/token/${CONTRACTS.BDRT}`;
                
                await refreshData();
                showToast('Connected to Base', 'success');
            } catch (e) { 
                console.error(e);
                showToast(e.message, 'error'); 
            }
        }

        async function refreshData() {
            if (!bdrtContract) return;
            let debugLog = '';
            const addDebug = (msg) => { debugLog += msg + '\n'; document.getElementById('debugOutput').textContent = debugLog; };
            
            try {
                addDebug('=== STARTING REFRESH ===');
                addDebug('User: ' + userAddress);
                
                // Get BTC price
                const btcPrice = await bdrtContract.getBtcPrice();
                addDebug('\n=== BTC PRICE ===');
                addDebug('Raw: ' + btcPrice.toString());
                const currentBtc = Number(ethers.utils.formatUnits(btcPrice, 8));
                addDebug('Formatted ($): ' + currentBtc.toLocaleString());
                document.getElementById('btcPrice').textContent = '$' + currentBtc.toLocaleString(undefined, {maximumFractionDigits: 0});

                // Get balance
                const bal = await bdrtContract.balanceOf(userAddress);
                addDebug('\n=== BALANCE ===');
                addDebug('Raw: ' + bal.toString());
                const balNum = Number(ethers.utils.formatEther(bal));
                addDebug('Formatted: ' + balNum + ' TDRT');
                document.getElementById('balanceValue').textContent = balNum.toFixed(2);

                // Get supply
                const supply = await bdrtContract.totalSupply();
                addDebug('\n=== SUPPLY ===');
                addDebug('Raw: ' + supply.toString());
                addDebug('Formatted: ' + Number(ethers.utils.formatEther(supply)));
                document.getElementById('totalSupply').textContent = Number(ethers.utils.formatEther(supply)).toFixed(0);

                // Get claimable
                const claimData = await bdrtContract.checkClaimStatus(userAddress);
                addDebug('\n=== CLAIM STATUS ===');
                addDebug('claimData[0] raw: ' + claimData[0].toString());
                addDebug('claimData[1] raw: ' + claimData[1].toString());
                addDebug('claimData[2] raw: ' + claimData[2].toString());
                const claimableAmount = Number(claimData[0]) / 1e6;
                addDebug('Claimable ($): ' + claimableAmount);
                document.getElementById('claimableValue').textContent = '$' + claimableAmount.toFixed(2);
                document.getElementById('claimAmount').textContent = '$' + claimableAmount.toFixed(2);

                document.getElementById('burnBtn').disabled = bal.eq(0);
                document.getElementById('claimBtn').disabled = claimData[0].eq(0);

                // Get pool data for price
                addDebug('\n=== UNISWAP POOL ===');
                const slot0 = await poolContract.slot0();
                addDebug('sqrtPriceX96: ' + slot0[0].toString());
                addDebug('tick: ' + slot0[1].toString());
                const token0 = await poolContract.token0();
                addDebug('token0: ' + token0);
                addDebug('TDRT: ' + CONTRACTS.BDRT);
                addDebug('TDRT is token0: ' + (token0.toLowerCase() === CONTRACTS.BDRT.toLowerCase()));

                // Load lots first for cost basis
                addDebug('\n=== LOADING LOTS ===');
                await loadUserLots(addDebug);
                await checkMintStatus(addDebug);
                await loadUserStats(claimableAmount, balNum, addDebug);
                await loadVaultData();
                await loadPositions(currentBtc, addDebug);
                
                addDebug('\n=== REFRESH COMPLETE ===');
            } catch (e) { 
                addDebug('\nERROR: ' + e.message);
                console.error('refreshData error:', e); 
            }
        }

        async function loadUserLots(addDebug) {
            try {
                const lots = await bdrtContract.getUserLots(userAddress);
                if (addDebug) {
                    addDebug('Raw lots count: ' + lots.length);
                    lots.forEach((lot, i) => {
                        addDebug('  Lot ' + i + ':');
                        addDebug('    amount raw: ' + lot.amount.toString());
                        addDebug('    amount: ' + ethers.utils.formatEther(lot.amount) + ' TDRT');
                        addDebug('    anchorPrice raw: ' + lot.anchorPrice.toString());
                        addDebug('    anchorPrice: $' + Number(ethers.utils.formatUnits(lot.anchorPrice, 8)).toLocaleString());
                        addDebug('    lowestPrice raw: ' + lot.lowestPrice.toString());
                        addDebug('    lowestPrice: $' + Number(ethers.utils.formatUnits(lot.lowestPrice, 8)).toLocaleString());
                        addDebug('    timestamp raw: ' + lot.timestamp.toString());
                        addDebug('    timestamp: ' + new Date(Number(lot.timestamp) * 1000).toLocaleString());
                    });
                }
                // Filter out zero/tiny amount lots (less than 0.01 TDRT)
                userLotsData = lots.filter(lot => {
                    const amt = Number(ethers.utils.formatEther(lot.amount));
                    return amt > 0.01;
                });
                if (addDebug) addDebug('Filtered lots count: ' + userLotsData.length);
            } catch (e) {
                console.error('loadUserLots error:', e);
                if (addDebug) addDebug('loadUserLots ERROR: ' + e.message);
                userLotsData = [];
            }
        }

        async function checkMintStatus(addDebug) {
            try {
                // Get price from Uniswap directly
                const uniPrice = await getUniswapPrice();
                if (addDebug) addDebug('\n=== MINT STATUS ===');
                if (addDebug) addDebug('Uniswap price calculated: $' + uniPrice);
                currentMarketPrice = uniPrice > 0 ? uniPrice : 1.00;
                window.currentDexPrice = currentMarketPrice;
                
                document.getElementById('drtMarketPrice').textContent = '$' + currentMarketPrice.toFixed(2);
                document.getElementById('dexPrice').textContent = '$' + currentMarketPrice.toFixed(4);
                
                // Get TWAP from contract
                const c = await bdrtContract.checkMintConditions();
                if (addDebug) {
                    addDebug('checkMintConditions:');
                    addDebug('  allowed: ' + c[0]);
                    addDebug('  dexPrice raw: ' + c[1].toString());
                    addDebug('  dexPrice: $' + (Number(c[1]) / 1e6));
                    addDebug('  twap raw: ' + c[2].toString());
                    addDebug('  twap: $' + (Number(c[2]) / 1e6));
                    addDebug('  threshold raw: ' + c[3].toString());
                    addDebug('  remaining raw: ' + c[4].toString());
                }
                const twap = Number(c[2]) / 1e6;
                const threshold = twap * 1.05;
                
                document.getElementById('twapPrice').textContent = '$' + twap.toFixed(4);
                document.getElementById('thresholdPrice').textContent = '$' + threshold.toFixed(4);
                
                const dot = document.getElementById('mintIndicator');
                const text = document.getElementById('mintStatusText');
                
                // Check conditions with real price
                const canMint = currentMarketPrice > 1.00 && currentMarketPrice > threshold;
                
                if (canMint) {
                    dot.classList.add('active'); dot.classList.remove('inactive');
                    text.textContent = 'Available';
                    document.getElementById('mintBtn').disabled = false;
                } else {
                    dot.classList.add('inactive'); dot.classList.remove('active');
                    text.textContent = currentMarketPrice <= 1.00 ? 'Below $1.00' : 'Below Threshold';
                    document.getElementById('mintBtn').disabled = true;
                }
            } catch (e) {
                console.error('checkMintStatus error:', e);
                document.getElementById('mintStatusText').textContent = 'Unavailable';
            }
        }

        async function loadUserStats(claimableAmount, balNum, addDebug) {
            try {
                if (addDebug) addDebug('\n=== USER STATS ===');
                // Calculate stats from lots since TDRT doesn't have getUserStats
                let totalCostBasis = 0;
                let totalTokensFromLots = 0;
                
                userLotsData.forEach(lot => {
                    const amt = Number(ethers.utils.formatEther(lot.amount));
                    totalTokensFromLots += amt;
                    // Lots from protocol mints cost $1.00 each
                    totalCostBasis += amt * 1.00;
                });
                
                if (addDebug) {
                    addDebug('Tokens from lots: ' + totalTokensFromLots);
                    addDebug('Balance: ' + balNum);
                    addDebug('Market price: $' + currentMarketPrice);
                }
                
                // Tokens bought on DEX (not in lots) - estimate at current price
                const tokensFromDex = balNum - totalTokensFromLots;
                if (tokensFromDex > 0) {
                    totalCostBasis += tokensFromDex * currentMarketPrice;
                    if (addDebug) addDebug('Tokens from DEX: ' + tokensFromDex);
                }
                
                const avgPrice = balNum > 0 ? totalCostBasis / balNum : 0;
                const currentValue = balNum * currentMarketPrice;
                
                if (addDebug) {
                    addDebug('Total cost basis: $' + totalCostBasis);
                    addDebug('Avg price: $' + avgPrice);
                    addDebug('Current value: $' + currentValue);
                }
                
                document.getElementById('portfolioValue').textContent = '$' + currentValue.toFixed(2);
                document.getElementById('costBasis').textContent = avgPrice > 0 ? '$' + avgPrice.toFixed(2) : '$0.00';

                const pnl = currentValue - totalCostBasis;
                const pnlPercent = totalCostBasis > 0 ? (pnl / totalCostBasis * 100) : 0;
                
                if (addDebug) {
                    addDebug('P&L: $' + pnl);
                    addDebug('P&L %: ' + pnlPercent + '%');
                }
                
                const pnlEl = document.getElementById('pnlValue');
                pnlEl.textContent = (pnl >= 0 ? '+' : '-') + '$' + Math.abs(pnl).toFixed(2);
                pnlEl.className = 'metric-value ' + (pnl >= 0 ? 'green' : 'red');
                document.getElementById('pnlPercent').textContent = (pnl >= 0 ? '+' : '') + pnlPercent.toFixed(1) + '%';

                document.getElementById('claimedValue').textContent = '$0.00';
                document.getElementById('totalEarnings').textContent = '$' + claimableAmount.toFixed(2);
            } catch (e) { 
                console.error('loadUserStats error:', e); 
                if (addDebug) addDebug('loadUserStats ERROR: ' + e.message);
            }
        }

        async function loadVaultData() {
            try {
                const seniorBal = await seniorContract.balance();
                const juniorBal = await juniorContract.balance();
                document.getElementById('seniorVault').textContent = '$' + (Number(seniorBal) / 1e6).toFixed(2);
                document.getElementById('juniorVault').textContent = '$' + (Number(juniorBal) / 1e6).toFixed(2);
            } catch (e) { console.error('loadVaultData error:', e); }
        }

        async function loadPositions(currentBtc, addDebug) {
            try {
                if (addDebug) addDebug('\n=== POSITIONS ===');
                const container = document.getElementById('positionsContainer');
                
                if (userLotsData.length === 0) {
                    container.innerHTML = '<div class="positions-empty">No positions yet</div>';
                    if (addDebug) addDebug('No positions to display');
                    return;
                }

                const claimData = await bdrtContract.checkClaimStatus(userAddress);
                const totalClaimable = Number(claimData[0]) / 1e6;
                const totalAmount = userLotsData.reduce((sum, l) => sum + Number(ethers.utils.formatEther(l.amount)), 0);
                
                if (addDebug) {
                    addDebug('Current BTC: $' + currentBtc);
                    addDebug('Total claimable: $' + totalClaimable);
                    addDebug('Total amount: ' + totalAmount + ' TDRT');
                }

                let html = `<table class="positions-table"><thead><tr>
                    <th>Opened</th><th>Amount</th><th>Entry BTC</th><th>Claim Below</th><th>Tracked Low</th><th>Claimable</th><th>Claimed</th>
                </tr></thead><tbody>`;

                userLotsData.forEach((lot) => {
                    const amt = Number(ethers.utils.formatEther(lot.amount));
                    const anchor = Number(ethers.utils.formatUnits(lot.anchorPrice, 8));
                    const storedLowest = Number(ethers.utils.formatUnits(lot.lowestPrice, 8));
                    const lowest = Math.min(storedLowest, currentBtc);
                    const timestamp = Number(lot.timestamp);
                    const date = new Date(timestamp * 1000).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const lotClaimable = totalAmount > 0 ? (totalClaimable * amt / totalAmount) : 0;

                    html += `<tr>
                        <td class="muted">${date}</td>
                        <td class="bold">${amt.toFixed(2)} DRT</td>
                        <td>$${anchor.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                        <td>$${(anchor * 0.95).toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                        <td>$${lowest.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                        <td class="green">$${lotClaimable.toFixed(2)}</td>
                        <td class="muted">$0.00</td>
                    </tr>`;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (e) { console.error('loadPositions error:', e); }
        }

        async function mintBDRT() {
            const amt = document.getElementById('mintAmount').value;
            if (!amt || parseFloat(amt) <= 0) return;
            const btn = document.getElementById('mintBtn');
            btn.innerHTML = '<span class="spinner"></span>';
            btn.disabled = true;
            try {
                const cost = ethers.utils.parseUnits((parseFloat(amt) * currentMarketPrice).toFixed(6), 6);
                const allow = await usdcContract.allowance(userAddress, CONTRACTS.BDRT);
                if (allow.lt(cost)) {
                    await (await usdcContract.approve(CONTRACTS.BDRT, ethers.constants.MaxUint256)).wait();
                }
                await (await bdrtContract.mint(ethers.utils.parseEther(amt))).wait();
                showToast('Minted ' + amt + ' DRT', 'success');
                document.getElementById('mintAmount').value = '';
                setTimeout(refreshData, 2000);
            } catch (e) { showToast(e.reason || e.message, 'error'); }
            btn.innerHTML = 'Mint DRT';
            await checkMintStatus();
        }

        async function burnBDRT() {
            const amt = document.getElementById('burnAmount').value;
            if (!amt || parseFloat(amt) <= 0) return;
            const btn = document.getElementById('burnBtn');
            btn.innerHTML = '<span class="spinner"></span>';
            btn.disabled = true;
            try {
                await (await bdrtContract.burn(ethers.utils.parseEther(amt))).wait();
                showToast('Redeemed ' + amt + ' DRT', 'success');
                document.getElementById('burnAmount').value = '';
                setTimeout(refreshData, 2000);
            } catch (e) { showToast(e.reason || e.message, 'error'); }
            btn.innerHTML = 'Redeem DRT';
            btn.disabled = false;
        }

        async function claimPayout() {
            const btn = document.getElementById('claimBtn');
            btn.innerHTML = '<span class="spinner"></span>';
            btn.disabled = true;
            try {
                await (await bdrtContract.updateLowestPrice()).wait();
                await (await bdrtContract.claim()).wait();
                showToast('Claimed!', 'success');
                setTimeout(refreshData, 2000);
            } catch (e) { showToast(e.reason || e.message, 'error'); }
            btn.innerHTML = 'Claim Payout';
            btn.disabled = false;
        }

        document.getElementById('mintAmount').addEventListener('input', e => {
            document.getElementById('mintCost').textContent = ((parseFloat(e.target.value) || 0) * currentMarketPrice).toFixed(2) + ' USDC';
        });
        document.getElementById('burnAmount').addEventListener('input', e => {
            document.getElementById('burnReceive').textContent = ((parseFloat(e.target.value) || 0) * 0.95).toFixed(2) + ' USDC';
        });

        function showToast(msg, type = 'success') {
            const t = document.createElement('div');
            t.className = 'toast ' + type;
            t.innerHTML = `<span>${type === 'success' ? '‚úì' : '‚úï'}</span><span>${msg}</span>`;
            document.getElementById('toastContainer').appendChild(t);
            setTimeout(() => t.remove(), 4000);
        }

        window.addEventListener('load', async () => {
            if (window.ethereum) {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) connectWallet();
            }
        });

        if (window.ethereum) {
            window.ethereum.on('accountsChanged', a => a.length ? connectWallet() : location.reload());
            window.ethereum.on('chainChanged', () => location.reload());
        }
    </script>
</body>
</html>
