<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>De-Risk Token | DRT</title>
    <link rel="icon" type="image/png" href="data:image/png;base64,UklGRvgJAABXRUJQVlA4WAoAAAAgAAAA8wEA8wEASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZWUDggCggAABBkAJ0BKvQB9AE+USiQRiOioaEk8kgIcAoJaW7hdj7yt1uVfmb/R9q39DtBf4/9kvuvDLvEv5bvfoAN1T68/4D0Pf9Vx11AD+Rf1v/n/zz19P8ny+/RX/i9xD9eOtV6KoaDPifE+J8T4nxPifE+J8T4nxPifE+J8T4nxPifE+J8T4nxPifE+J8T4nxPifE+J8T4nxPifE+J8T4nxPifE+J8T4nxPifE+J8T4nxPifE+J8T4nxPifE+J8T4nxPifE+J8T4nxPifE+J8T4nxPifE+J8T4nxPifE+J8T4nxPifE+J8T4nxPPauDajPQAiXIXgoRjRuR3Mm/bTVmBQqlMjTAZuKKjvaUY7xepTEQCtctbU2ptMgeV/xoEGDyTiE9eiMkYgaBKYi7LJAfe2VYUHTcm38YFOlGZqelY99JSBjkq+peJj8EAGMBlx4PHMIIhR9ugMH4yNcLXAfmWj2ktjPgjh03JuBtNzZrDb4iDO/sVkBOMvkdSNzWy6Lh03JBVsmaJ8qNzVAgD6ZfI6kbmoHDpuTckFWyZonyo3NUCAPpl8jqRuagcOm5NyQVbJmifKjchNE7BVITzlab4sbETjJ4xpNqbU2pbtNzb6RzG3q3O60sUPADOTihnKygUqLQa90nXDpBVsmaJ8qNyLUy9x2uh2dRKVHst1QcHaRuagcOm5NyQVbJmifKjc04IyZjTuJ8ZHjvUKNDcm5NyasFRnXJZybxAMXBJRvYi47yo1AomEn16HJjdzag2RuagcOm5NyQVhdtYvYJT0Xu82q0qDou/DunJkTDO20JJwFgLAWAc1AhF/0VEzmQQCjZAKok5kB6cBuOFdgVp1nk24m5o56dMAmjJ8g+2RvrzpOua0v/90B1w6bk3J917puTcm5Nybk3JuTcm5Nybk3JuTcm5Nybk3JuTcm5Nybk3JuTcm5Nybk3JuTcm5Nybk3JuTcm5Nybk3JuTcm5Nybk3JuTcm5Nybk3JuTcm5Nybk3JuTcm5Nybk3JuTcm5Nybk3JuTcm5Nybk3JuTcm5Nybk3JuTcm5Nybk3JuTcm5Nybk3JuTcm5Nybk3I4AAP7/1KMAAAAAAAAAEOSD38X7TLTzutzUdJc5YSQLJJzlftp8pdULP31SyyszweGPSdvR12U47K2ROi35mSNiRGs6WtIrz8nnHEazELlUn7kA47iLBV8AdpLC//h8+G3+f5YrGmYlQ2tmu1tqdXdTLR2w/0bny91MwFjMGgpQG1lEVlnzZOMnGyFDyCnFkmDH/WIa0I/KhH5e1CNBYHrpUjP0nEmyO//Q/qxmdAqdPc3z3Dq0mBzDizWNYOu/1dTLMWRZ5TaNGG48+EYeq6UPYSNr26Brbf8LjqrQ85InliccNXKm1rX1QIUOmBo6U6n7galF+I70VbG2uQs8TTDUMcuvuHpQ9M2hrcTt2mJ7GID7QOFA7Iy5ahyF2PqBajnVabf9Rfs5nVYap21phZkdwCz0khGG4UdIw3K39HpCG8N2Kf1r/yJbFDDXOyAn5bNsD9BKOfqOeZWaQPdH4MFOpuzv9Vv1Zi4W9egB3KhcEIl5sp09LODd+Qv+vQiRhZl9PdyK9LqV8My16LxBTHfhdShnPzPGG+SB2CXadq5o5RMPzQyJtovQB521h7c29r1EU4+z2pXcLXv5ViaL3qi1f5tKgTG5v7N172K1zr7ecukz9H+J//x3cFuNre1QMOHw8/P98KnnylGB5kHvab9a5xU/xfePEXyV6KsOgWFx62CjOgHImyUGAX8w8cd37z0EiBrtC4MjgevcErdGWEHXeGY+SAy4fw6u8hDMFeIIH7JvDMOAKLhmHCE4Zlmzd28G6y6r5wjfw9RMOIcGXSik+PEO9zKkEel5+GnCvHhi68bgICNIwvKzfj/z6GpwzDy2OkFnoc88WrrUkX0AFPbpPwCN6UUVboJTKyEJNeCXyT7DtxgAIThmWvkr7fWM7lkKjbSmUDnVuGS7r+/htWhe/lH2igtHiwKzJwOsbG0cxHrfuf32V1UpBf3nNTLSTVJ2w0+ksGNcEwTRsHSYQNrVM2lWFr/dmHyJY4IjhmX6TZ4sKLGOzlgqeEpGmeoVIp6/lUuG6oz6/SmKusWM/7G0+k/5mavPwNePt5td03cW8c40+axp3UFYds+AtgSYtgwXVQsAChOK6ZntwS+XGisA3Ue03qJsjIioCrfkGxurTSELl6zU4DxUjSQJqYPSi9uGZFmKmyl29MZcsWqVmIZjAR1EpcEUmjgn7ouiiGy8t63qhw+mmKu1G8HRY2Uwm1I1mOYNFXZlY2EXOwt7ywFV5tVYI627+3dUXwvS9MyG1G3VGyCRrr0jm7saaIhSurnhA9avwEVCWTIp+2+0I2MaH9TK5ixW5Qnhj/Jo3KQuV7FGLx8Ql9LoCNnP13VzB/RtUTiqtqQBp5laJhFERJq07COosaUmTGbC37s1iRNFDq/8PQKjJYTAVXSVPXtiNJfNYmgPgs+Rv/8WiDlLZy9+5NNf0Ptv7n92c6/+zhF8VL9ARRsHUHCGhPa4T4vUigw2WrwphnpuIeBVZ5+nO8mcxqpOTOmtIrd5yiIXAXaNGM95imtLh2UsBHWBaH8D2Ss2ZcrPVXiAf1PZg42v8ss35wGGB9j/APrO/nX+nN/czxjOabFsz0zTIYGtJ4PBdoJ0saQquBLF/cP7s+WwygdxFNT4lnyJ1AOzpM9ay6doWo6oCphy6gAAAAAAAAAAAAAAAA==">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        :root {
            --bg: #f5f5f7;
            --bg-white: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #515154;
            --text-muted: #86868b;
            --border: #d2d2d7;
            --green: #34c759;
            --red: #ff3b30;
            --blue: #007aff;
            --orange: #ff9500;
            --gold: #d4a726;
            --radius: 12px;
            --radius-lg: 16px;
            --shadow: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-hover: 0 8px 24px rgba(0,0,0,0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        header {
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding: 0 24px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 999;
        }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-mark {
            width: 28px; height: 28px;
            border-radius: 7px;
            overflow: hidden;
        }
        .logo-mark img {
            width: 100%; height: 100%; object-fit: cover;
        }
        .logo-text { font-size: 15px; font-weight: 600; color: var(--text-primary); }
        .header-actions { display: flex; align-items: center; gap: 24px; }
        .nav-link { color: var(--text-secondary); text-decoration: none; font-size: 13px; font-weight: 500; transition: color 0.2s; }
        .nav-link:hover { color: var(--text-primary); }
        .connect-btn {
            background: var(--text-primary); color: #fff; border: none;
            padding: 8px 16px; border-radius: 20px;
            font-family: inherit; font-size: 13px; font-weight: 500;
            cursor: pointer; transition: all 0.2s;
        }
        .connect-btn:hover { opacity: 0.85; }
        .connect-btn.connected { background: var(--bg); color: var(--text-primary); border: 1px solid var(--border); }

        main { max-width: 980px; margin: 0 auto; padding: 48px 24px 80px; }

        .hero { text-align: center; padding: 24px 0 56px; }
        .hero-badge { display: inline-flex; align-items: center; gap: 6px; color: var(--green); font-size: 12px; font-weight: 600; margin-bottom: 16px; }
        .hero-badge .dot { width: 6px; height: 6px; background: var(--green); border-radius: 50%; animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .hero h1 { font-size: 52px; font-weight: 700; color: var(--text-primary); letter-spacing: -2px; margin-bottom: 12px; line-height: 1.05; }
        .hero h1 .gradient { background: linear-gradient(90deg, #007aff, #5856d6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .trust-badges { display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 24px; flex-wrap: wrap; }
        .trust-badges .separator { color: var(--border); font-size: 13px; }
        .trust-badge-item { position: relative; display: inline-flex; cursor: default; }
        .trust-badge-item > span { font-size: 13px; color: var(--text-muted); font-weight: 500; }
        .trust-tooltip { position: absolute; bottom: calc(100% + 10px); left: 0; transform: none; background: var(--text-primary); color: #fff; padding: 10px 14px; border-radius: 8px; font-size: 12px; font-weight: 400; width: 220px; text-align: left; opacity: 0; visibility: hidden; transition: all 0.2s; z-index: 50; line-height: 1.5; }
        .trust-badge-item:hover .trust-tooltip { opacity: 1; visibility: visible; }

        .section { margin-bottom: 24px; }
        .section-label { font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }

        .tooltip-wrap { position: relative; display: inline-flex; align-items: center; }
        .tooltip-icon { width: 16px; height: 16px; border-radius: 50%; background: var(--bg); color: var(--text-muted); font-size: 10px; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; cursor: help; margin-left: 6px; }
        .tooltip-icon:hover { color: var(--text-secondary); background: var(--border); }
        .tooltip-text { position: absolute; bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%); background: var(--text-primary); color: #fff; padding: 10px 14px; border-radius: 8px; font-size: 12px; font-weight: 400; width: 240px; white-space: normal; text-align: left; opacity: 0; visibility: hidden; transition: all 0.2s; z-index: 50; line-height: 1.5; pointer-events: none; }
        .tooltip-wrap:hover .tooltip-text { opacity: 1; visibility: visible; }
        
        /* Loading overlay for refresh states */
        .loading-overlay { 
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(255,255,255,0.92); 
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center; 
            z-index: 10; border-radius: inherit; 
        }
        .loading-overlay .loading-content { text-align: center; }
        .loading-overlay .spinner-large { 
            width: 36px; height: 36px; 
            border: 3px solid var(--border); 
            border-top-color: var(--blue); 
            border-radius: 50%; 
            animation: spin 0.7s linear infinite; 
            margin: 0 auto 14px; 
        }
        .loading-overlay .loading-text { 
            font-size: 13px; color: var(--text-secondary); font-weight: 500; 
            margin-bottom: 4px;
        }
        .loading-overlay .loading-subtext { 
            font-size: 11px; color: var(--text-muted); font-weight: 400; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse-text { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* Merge modal */
        .merge-modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .merge-modal-overlay.active { display: flex; }
        .merge-modal { background: var(--bg-white); border-radius: var(--radius-lg); max-width: 420px; width: 100%; padding: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .merge-modal-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .merge-modal-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .merge-modal-icon.warning { background: rgba(255, 149, 0, 0.15); }
        .merge-modal-icon.info { background: rgba(0, 122, 255, 0.1); }
        .merge-modal-title { font-size: 18px; font-weight: 600; }
        .merge-modal-body { margin-bottom: 20px; }
        .merge-modal-body p { font-size: 14px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.5; }
        .merge-modal-details { background: var(--bg); border-radius: 10px; padding: 14px; margin-top: 12px; }
        .merge-modal-detail { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 8px; }
        .merge-modal-detail:last-child { margin-bottom: 0; }
        .merge-modal-detail .label { color: var(--text-muted); }
        .merge-modal-detail .value { font-weight: 600; color: var(--text-primary); }
        .merge-modal-detail .value.warning { color: var(--orange); }
        .merge-modal-detail .value.green { color: var(--green); }
        .merge-modal-buttons { display: flex; flex-direction: column; gap: 10px; }
        .merge-modal-btn { padding: 14px 20px; border-radius: 10px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .merge-modal-btn.primary { background: var(--blue); color: #fff; }
        .merge-modal-btn.primary:hover { background: #0066d6; }
        .merge-modal-btn.success { background: var(--green); color: #fff; }
        .merge-modal-btn.success:hover { background: #2db550; }
        .merge-modal-btn.danger { background: var(--bg); color: var(--orange); border: 1px solid var(--orange); }
        .merge-modal-btn.danger:hover { background: rgba(255, 149, 0, 0.1); }
        .merge-modal-btn.secondary { background: var(--bg); color: var(--text-secondary); }
        .merge-modal-btn.secondary:hover { background: var(--border); }
        .merge-modal-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        @media (max-width: 768px) {
            .merge-modal { margin: 20px; max-width: none; }
            .merge-modal-buttons { gap: 8px; }
            .merge-modal-btn { padding: 16px; }
        }

        .portfolio-section { margin-bottom: 32px; }
        .portfolio-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        
        .portfolio-main-card {
            background: linear-gradient(135deg, #1d1d1f, #3a3a3c);
            border-radius: var(--radius-lg);
            padding: 28px;
            color: #fff;
            display: flex;
            flex-direction: column;
        }
        .portfolio-main-label { font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 8px; font-weight: 500; }
        .portfolio-main-value { font-size: 42px; font-weight: 700; letter-spacing: -1px; margin-bottom: 12px; line-height: 1; }
        .portfolio-main-sub { font-size: 14px; color: rgba(255,255,255,0.5); display: flex; flex-direction: column; gap: 6px; flex-grow: 1; }
        .portfolio-main-sub .row { display: flex; justify-content: space-between; }
        .portfolio-main-sub .value { color: #fff; font-weight: 600; }
        .trade-btn-bottom {
            margin-top: 20px;
            padding: 14px 20px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            text-align: center;
            transition: all 0.2s;
            display: block;
            width: 100%;
        }
        .trade-btn-bottom:hover { background: rgba(255,255,255,0.18); }

        /* Combined Earnings Card */
        .earnings-combined-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 28px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .earnings-combined-card:hover { box-shadow: var(--shadow-hover); transform: translateY(-2px); }
        
        .earnings-main { margin-bottom: 12px; }
        .earnings-main-label { font-size: 12px; font-weight: 500; color: var(--text-muted); margin-bottom: 8px; display: flex; align-items: center; }
        .earnings-main-value { font-size: 42px; font-weight: 700; letter-spacing: -1px; color: var(--green); line-height: 1; }
        
        .earnings-details { display: flex; flex-direction: column; gap: 6px; flex-grow: 1; }
        .earnings-detail-row { display: flex; justify-content: space-between; align-items: center; }
        .earnings-detail-row .label { font-size: 14px; color: var(--text-muted); display: flex; align-items: center; }
        .earnings-detail-row .value { font-size: 14px; font-weight: 600; }
        .earnings-detail-row .value.gold { color: var(--gold); }
        .earnings-detail-row .value.muted { color: #aaa; }
        
        .claim-btn-bottom {
            margin-top: 20px;
            padding: 14px 20px;
            background: var(--green);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        .claim-btn-bottom:hover { opacity: 0.9; }
        .claim-btn-bottom:disabled { opacity: 0.4; cursor: not-allowed; }

        .positions-card { background: var(--bg-white); border-radius: var(--radius-lg); box-shadow: var(--shadow); overflow: visible; margin-bottom: 24px; }
        .positions-header { padding: 16px 20px; border-bottom: 1px solid rgba(0,0,0,0.06); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; }
        .positions-header h3 { font-size: 14px; font-weight: 600; }
        .btc-price-display { display: flex; align-items: center; gap: 6px; }
        .btc-label { font-size: 11px; font-weight: 500; color: var(--text-muted); }
        .btc-value { font-size: 13px; font-weight: 500; color: var(--text-secondary); }
        .btc-change { font-size: 11px; font-weight: 600; }
        .btc-change.up { color: var(--green); }
        .btc-change.down { color: var(--red); }
        
        /* Lot Management Toolbar */
        .positions-toolbar { padding: 12px 20px; border-bottom: 1px solid rgba(0,0,0,0.06); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; background: var(--bg); }
        .toolbar-left { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .toolbar-right { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        
        /* Filter Pills */
        .filter-pills { display: flex; gap: 4px; }
        .filter-pill { padding: 6px 12px; border-radius: 16px; font-size: 12px; font-weight: 500; border: 1px solid var(--border); background: var(--bg-white); color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
        .filter-pill:hover { border-color: var(--text-muted); }
        .filter-pill.active { background: var(--text-primary); color: #fff; border-color: var(--text-primary); }
        .filter-pill .count { margin-left: 4px; opacity: 0.7; }
        
        /* Quick Select Dropdown */
        .quick-select { position: relative; }
        .quick-select-btn { padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 500; border: 1px solid var(--border); background: var(--bg-white); color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; gap: 4px; }
        .quick-select-btn:hover { border-color: var(--text-muted); }
        .quick-select-menu { position: absolute; top: 100%; left: 0; margin-top: 4px; background: var(--bg-white); border: 1px solid var(--border); border-radius: 8px; box-shadow: var(--shadow-hover); z-index: 20; min-width: 140px; display: none; }
        .quick-select-menu.show { display: block; }
        .quick-select-item { padding: 10px 14px; font-size: 12px; cursor: pointer; transition: background 0.15s; }
        .quick-select-item:hover { background: var(--bg); }
        .quick-select-item:first-child { border-radius: 7px 7px 0 0; }
        .quick-select-item:last-child { border-radius: 0 0 7px 7px; }
        
        /* Sort Dropdown */
        .sort-select { padding: 6px 10px; border-radius: 8px; font-size: 12px; border: 1px solid var(--border); background: var(--bg-white); color: var(--text-secondary); cursor: pointer; }
        
        /* Bulk Action Buttons */
        .bulk-actions { display: flex; gap: 6px; }
        .bulk-btn { padding: 8px 14px; border-radius: 8px; font-size: 12px; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .bulk-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .bulk-btn.claim { background: var(--green); color: #fff; }
        .bulk-btn.claim:hover:not(:disabled) { background: #2db550; }
        .bulk-btn.merge { background: var(--blue); color: #fff; }
        .bulk-btn.merge:hover:not(:disabled) { background: #0066d6; }
        .bulk-btn.claim-merge { background: linear-gradient(135deg, var(--green), var(--blue)); color: #fff; }
        .bulk-btn.claim-merge:hover:not(:disabled) { opacity: 0.9; }
        
        /* Selection Counter */
        .selection-counter { font-size: 12px; color: var(--text-muted); padding: 6px 0; }
        .selection-counter strong { color: var(--text-primary); }
        
        /* Lot Limit Banner */
        .lot-limit-banner { padding: 12px 20px; background: rgba(255, 149, 0, 0.1); border-bottom: 1px solid rgba(255, 149, 0, 0.2); display: flex; align-items: center; gap: 10px; font-size: 13px; color: var(--orange); }
        .lot-limit-banner.danger { background: rgba(255, 59, 48, 0.1); border-color: rgba(255, 59, 48, 0.2); color: var(--red); }
        .lot-limit-banner .icon { font-size: 16px; }
        
        /* Checkbox styling */
        .lot-checkbox { width: 18px; height: 18px; accent-color: var(--blue); cursor: pointer; }
        .select-all-checkbox { width: 18px; height: 18px; accent-color: var(--blue); cursor: pointer; }
        
        /* Row selection highlight */
        .positions-table tr.selected { background: rgba(0, 122, 255, 0.06); }
        .positions-table tr.selected:hover { background: rgba(0, 122, 255, 0.1); }
        
        /* Dust indicator */
        .dust-tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; background: rgba(134, 134, 139, 0.15); color: var(--text-muted); margin-left: 6px; }
        
        .lock-btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 12px; font-weight: 600; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
        .lock-btn:hover:not(:disabled) { background: var(--text-primary); color: #fff; border-color: var(--text-primary); }
        .lock-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .lock-btn .lock-icon { font-size: 11px; }
        .lock-header-btn { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 10px; font-weight: 600; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.3px; }
        .lock-header-btn:hover:not(:disabled) { background: var(--text-primary); color: #fff; border-color: var(--text-primary); }
        .lock-header-btn:disabled { opacity: 0.35; cursor: not-allowed; background: var(--bg); color: var(--text-muted); }
        .relock-chip { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: default; }
        .relock-chip.available { background: rgba(52, 199, 89, 0.12); color: var(--green); }
        .relock-chip.current { background: var(--bg); color: var(--text-muted); }
        .positions-table-wrapper { width: 100%; }
        .positions-table { width: 100%; border-collapse: collapse; }
        .positions-table th { text-align: left; padding: 12px 16px; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; background: var(--bg); }
        .positions-table th .tooltip-text { text-transform: none; letter-spacing: normal; }
        .positions-table td { padding: 14px 16px; font-size: 13px; border-bottom: 1px solid rgba(0,0,0,0.04); }
        .positions-table tr:last-child td { border-bottom: none; }
        .positions-table tr:hover { background: var(--bg); }
        .positions-table .green { color: var(--green); font-weight: 600; }
        .positions-table .red { color: var(--red); }
        .positions-table .muted { color: var(--text-muted); }
        .positions-table .bold { font-weight: 600; }
        .change-indicator { font-size: 11px; font-weight: 600; margin-left: 6px; }
        .change-indicator.green { color: var(--green); }
        .change-indicator.red { color: var(--red); }
        .change-indicator.muted { color: var(--text-muted); }
        .deductible-tag { font-size: 10px; color: var(--text-muted); margin-left: 4px; }
        .positions-empty { padding: 48px; text-align: center; color: var(--text-muted); font-size: 14px; }
        .positions-empty a { color: var(--blue); text-decoration: none; font-weight: 600; transition: opacity 0.2s; }
        .positions-empty a:hover { opacity: 0.7; text-decoration: underline; }

        .actions-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 32px; }
        .action-card { background: var(--bg-white); border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow); transition: all 0.3s ease; }
        .action-card:hover { box-shadow: var(--shadow-hover); transform: translateY(-2px); }
        .action-header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
        .action-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .action-icon.blue { background: rgba(0, 122, 255, 0.1); color: var(--blue); }
        .action-icon.gray { background: var(--bg); color: var(--text-secondary); }
        .action-card h3 { font-size: 16px; font-weight: 600; }
        .action-card > p { font-size: 13px; color: var(--text-muted); margin-bottom: 16px; }

        .mint-status { background: var(--bg); border-radius: 10px; padding: 14px; margin-bottom: 12px; }
        .status-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .status-badge { 
            display: inline-flex; 
            align-items: center; 
            gap: 6px; 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 600;
        }
        .status-badge.available { background: rgba(52, 199, 89, 0.15); color: var(--green); }
        .status-badge.unavailable { background: rgba(255, 59, 48, 0.1); color: var(--red); }
        .status-badge.capped { background: rgba(255, 149, 0, 0.15); color: var(--orange); }
        .status-badge .dot { width: 6px; height: 6px; border-radius: 50%; }
        .status-badge.available .dot { background: var(--green); }
        .status-badge.unavailable .dot { background: var(--red); }
        .status-badge.capped .dot { background: var(--orange); }
        .status-details { display: flex; flex-direction: column; gap: 4px; }
        .status-detail { display: flex; justify-content: space-between; font-size: 11px; }
        .status-detail .label { color: var(--text-muted); }
        .status-detail .value { font-weight: 600; color: var(--text-secondary); }
        .status-detail .value.green { color: var(--green); }

        .info-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 13px; border-bottom: 1px solid rgba(0,0,0,0.04); }
        .info-row:last-of-type { border-bottom: none; }
        .info-row .label { color: var(--text-muted); }
        .info-row .value { font-weight: 600; }

        .input-wrap { position: relative; margin-bottom: 8px; }
        .input-wrap input { width: 100%; background: var(--bg); border: none; border-radius: 10px; padding: 14px 90px 14px 16px; font-family: inherit; font-size: 15px; font-weight: 500; color: var(--text-primary); outline: none; -moz-appearance: textfield; }
        .input-wrap input::-webkit-outer-spin-button, .input-wrap input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .input-wrap input:focus { box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2); }
        .input-wrap .suffix { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: 600; color: var(--text-muted); }
        .input-wrap .max-btn { position: absolute; right: 50px; top: 50%; transform: translateY(-50%); background: rgba(0, 122, 255, 0.1); color: var(--blue); border: none; padding: 4px 8px; border-radius: 6px; font-family: inherit; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .input-wrap .max-btn:hover { background: rgba(0, 122, 255, 0.2); }

        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-family: inherit; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; margin-top: 8px; }
        .btn-primary { background: var(--text-primary); color: #fff; }
        .btn-primary:hover { opacity: 0.85; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .protocol-stats { margin-bottom: 48px; }
        .stats-box {
            background: linear-gradient(145deg, #1a1a1c 0%, #232325 100%);
            border-radius: 20px;
            padding: 28px;
            color: #fff;
            box-shadow: 0 4px 24px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.03);
        }
        
        /* Two column layout */
        .stats-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 48px;
            margin-bottom: 24px;
        }
        .stats-column { }
        .stats-column-label { 
            font-size: 11px; 
            color: rgba(255,255,255,0.4); 
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .stats-column-value { 
            font-size: 28px; 
            font-weight: 700; 
            letter-spacing: -0.5px; 
            margin-bottom: 16px;
            font-variant-numeric: tabular-nums;
        }
        .stats-breakdown { display: flex; flex-direction: column; gap: 8px; }
        .stats-breakdown-item {
            display: flex; 
            align-items: center; 
            gap: 8px; 
            padding: 12px 14px;
            background: rgba(255,255,255,0.03); 
            border-radius: 10px;
            text-decoration: none; 
            color: #fff; 
            transition: all 0.2s; 
            font-size: 13px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .stats-breakdown-item:hover { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.1); }
        .stats-breakdown-item-static { cursor: default; }
        .stats-breakdown-item-static:hover { background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.05); }
        .stats-breakdown-label { color: rgba(255,255,255,0.5); font-size: 13px; }
        .stats-breakdown-value { font-weight: 600; margin-left: auto; font-variant-numeric: tabular-nums; font-size: 13px; }
        a.stats-breakdown-item::after { content: 'â†—'; font-size: 10px; color: rgba(255,255,255,0.2); margin-left: 4px; }
        
        .stats-breakdown .tooltip-icon {
            width: 14px;
            height: 14px;
            font-size: 9px;
            background: rgba(255,255,255,0.06);
            color: rgba(255,255,255,0.35);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .stats-breakdown .tooltip-text { width: 240px; }
        
        /* Footer badges */
        .stats-footer-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.06);
        }
        .stats-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 16px 18px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.06);
        }
        .stats-badge .badge-label {
            font-size: 11px;
            color: rgba(255,255,255,0.5);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stats-badge .badge-value {
            font-size: 28px;
            font-weight: 700;
            margin-left: auto;
            font-variant-numeric: tabular-nums;
        }
        .stats-badge .tooltip-icon {
            width: 14px;
            height: 14px;
            font-size: 9px;
            background: rgba(255,255,255,0.06);
            color: rgba(255,255,255,0.35);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: help;
        }
        .stats-badge .tooltip-text { width: 260px; }
        
        .stats-badge-ratio {
            background: linear-gradient(135deg, rgba(52,199,89,0.1) 0%, rgba(52,199,89,0.04) 100%);
            border-color: rgba(52,199,89,0.15);
        }
        .stats-badge-ratio .badge-value { color: var(--green); }
        .stats-badge-ratio.ratio-warning {
            background: linear-gradient(135deg, rgba(255,149,0,0.1) 0%, rgba(255,149,0,0.04) 100%);
            border-color: rgba(255,149,0,0.15);
        }
        .stats-badge-ratio.ratio-warning .badge-value { color: var(--orange); }
        .stats-badge-ratio.ratio-danger {
            background: linear-gradient(135deg, rgba(255,59,48,0.1) 0%, rgba(255,59,48,0.04) 100%);
            border-color: rgba(255,59,48,0.15);
        }
        .stats-badge-ratio.ratio-danger .badge-value { color: var(--red); }
        
        .stats-badge-paid {
            background: linear-gradient(135deg, rgba(212,167,38,0.1) 0%, rgba(212,167,38,0.04) 100%);
            border-color: rgba(212,167,38,0.15);
        }
        .stats-badge-paid .badge-value { color: var(--gold); }

        .how-section { margin-bottom: 48px; }
        .section-header { text-align: center; margin-bottom: 28px; }
        .section-header h2 { font-size: 32px; font-weight: 700; letter-spacing: -1px; margin-bottom: 8px; }
        .section-header p { color: var(--text-muted); font-size: 16px; }
        .how-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .how-card { background: var(--bg-white); border-radius: var(--radius); padding: 24px 20px; text-align: center; box-shadow: var(--shadow); transition: all 0.3s ease; }
        .how-card:hover { box-shadow: var(--shadow-hover); transform: translateY(-2px); }
        .how-step { width: 32px; height: 32px; background: var(--text-primary); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; margin: 0 auto 14px; }
        .how-card h3 { font-size: 14px; font-weight: 600; margin-bottom: 8px; }
        .how-card p { font-size: 12px; color: var(--text-muted); line-height: 1.5; }

        footer { 
            background: #fafafa;
            padding: 64px 24px 48px; 
            border-top: 1px solid rgba(0,0,0,0.04); 
        }
        .footer-inner { max-width: 980px; margin: 0 auto; text-align: center; }
        .footer-brand { font-size: 13px; font-weight: 500; color: var(--text-primary); margin-bottom: 4px; letter-spacing: -0.2px; }
        .footer-tagline { font-size: 13px; color: var(--text-muted); margin-bottom: 32px; }
        .footer-contracts { display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; margin-bottom: 40px; }
        .footer-contract-link {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 8px 14px; background: transparent; border-radius: 8px;
            text-decoration: none; color: var(--text-muted); font-size: 12px; font-weight: 500;
            transition: all 0.2s ease; border: 1px solid transparent;
        }
        .footer-contract-link:hover { 
            color: var(--text-primary); background: #fff; border-color: var(--border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .footer-contract-link svg { width: 11px; height: 11px; opacity: 0.4; transition: opacity 0.2s; }
        .footer-contract-link:hover svg { opacity: 0.7; }
        .footer-meta { display: flex; align-items: center; justify-content: center; gap: 24px; flex-wrap: wrap; }
        .footer-meta-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-muted); }
        .footer-meta-item .base-logo { width: 14px; height: 14px; opacity: 0.7; }
        .footer-email { 
            font-size: 12px; color: var(--text-muted); text-decoration: none; 
            font-family: 'SF Mono', SFMono-Regular, ui-monospace, Menlo, monospace;
            letter-spacing: -0.3px; transition: color 0.2s;
        }
        .footer-email:hover { color: var(--text-primary); }
        .footer-dot { color: var(--border); font-size: 4px; }
        .footer-social { display: flex; gap: 4px; }
        .social-link { 
            width: 32px; height: 32px; border-radius: 8px; background: transparent;
            display: flex; align-items: center; justify-content: center; 
            color: var(--text-muted); transition: all 0.2s ease;
        }
        .social-link:hover { background: #fff; color: var(--text-primary); box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .social-link svg { width: 15px; height: 15px; }

        #toastContainer { position: fixed; top: 70px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; }
        .toast { padding: 12px 16px; border-radius: 10px; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 8px; animation: slideIn 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .toast.success { background: #e8f5e9; color: #2e7d32; }
        .toast.error { background: #ffebee; color: #c62828; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .spinner { width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; vertical-align: middle; margin-right: 6px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(4px); }
        .modal-content { background: #fff; border-radius: 16px; padding: 24px; max-width: 360px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
        .modal-content h3 { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .modal-desc { font-size: 14px; color: var(--text-secondary); margin-bottom: 16px; line-height: 1.5; }
        .modal-details { background: var(--bg); border-radius: 10px; padding: 12px 14px; margin-bottom: 12px; }
        .modal-row { display: flex; justify-content: space-between; font-size: 13px; padding: 6px 0; }
        .modal-row span:first-child { color: var(--text-muted); }
        .modal-row span:last-child { font-weight: 600; }
        .modal-note { font-size: 12px; color: var(--text-muted); margin-bottom: 20px; line-height: 1.5; }
        .modal-warning { background: #fff3cd; border: 1px solid #ffc107; border-radius: 10px; padding: 12px 14px; margin-bottom: 12px; font-size: 13px; color: #856404; line-height: 1.5; }
        .modal-buttons { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 10px; font-family: inherit; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; }
        .modal-btn.secondary { background: var(--bg); color: var(--text-secondary); }
        .modal-btn.secondary:hover { background: var(--border); }
        .modal-btn.primary { background: var(--text-primary); color: #fff; }
        .modal-btn.primary:hover { opacity: 0.9; }

        @media (max-width: 768px) {
            body { overflow-x: hidden; }
            main { padding: 24px 16px 60px; max-width: 100%; }
            header { padding: 0 16px; }
            .header-actions { gap: 12px; }
            .nav-link { font-size: 12px; }
            .connect-btn { padding: 6px 12px; font-size: 12px; border-radius: 16px; }
            .logo-text { font-size: 13px; }
            .hero { padding: 16px 0 32px; }
            .hero h1 { font-size: 32px; letter-spacing: -1px; }
            .trust-badges { gap: 6px; padding: 0 8px; }
            .trust-badge-item > span { font-size: 11px; }
            .trust-badges .separator { font-size: 11px; }
            .portfolio-grid { grid-template-columns: 1fr; gap: 12px; }
            .portfolio-main-card, .earnings-combined-card { padding: 20px; }
            .portfolio-main-value, .earnings-main-value { font-size: 36px; }
            .actions-grid { grid-template-columns: 1fr; }
            .action-card { padding: 20px; }
            .how-grid { grid-template-columns: 1fr; }
            .stats-section { margin: 0 -16px; border-radius: 0; }
            .stats-box { padding: 24px 20px; border-radius: 16px; }
            .stats-columns { 
                grid-template-columns: 1fr; 
                gap: 28px;
                margin-bottom: 20px;
            }
            .stats-column-value { font-size: 28px; margin-bottom: 14px; }
            .stats-breakdown { gap: 8px; }
            .stats-breakdown-item { 
                padding: 14px 16px;
            }
            .stats-footer-row {
                grid-template-columns: 1fr;
                gap: 10px;
                padding-top: 16px;
            }
            .stats-badge {
                padding: 14px 16px;
            }
            .stats-badge .badge-value {
                font-size: 24px;
            }
            .positions-card { margin: 0 -16px; border-radius: 0; padding: 16px; }
            .positions-toolbar { flex-direction: column; align-items: stretch; gap: 10px; padding: 12px 16px; }
            .toolbar-left, .toolbar-right { flex-direction: column; align-items: stretch; gap: 8px; }
            .filter-pills { justify-content: center; }
            .bulk-actions { flex-direction: column; }
            .bulk-btn { justify-content: center; }
            .selection-counter { text-align: center; }
            .positions-table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; margin: 0 -16px; padding: 0 16px; }
            .positions-table { font-size: 11px; min-width: 700px; }
            .positions-table th, .positions-table td { padding: 10px 8px; white-space: nowrap; }
            .section-label { font-size: 11px; }
            footer { padding: 48px 16px 40px; }
            .footer-tagline { margin-bottom: 24px; }
            .footer-contracts { margin-bottom: 32px; gap: 4px; }
            .footer-contract-link { padding: 8px 12px; font-size: 11px; }
            .footer-meta { gap: 16px; }
            
            /* Mobile tooltip - bottom sheet style */
            .trust-tooltip { display: none !important; }
            .tooltip-text { display: none !important; }
            .mobile-tooltip-sheet {
                display: none;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: #1d1d1f;
                color: #fff;
                padding: 24px 20px 32px;
                border-radius: 16px 16px 0 0;
                z-index: 1001;
                text-align: left;
                font-size: 14px;
                line-height: 1.6;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
            }
            .mobile-tooltip-sheet.active { display: block; }
            .mobile-tooltip-sheet .sheet-title {
                font-weight: 600;
                font-size: 15px;
                margin-bottom: 8px;
                color: #fff;
            }
            .mobile-tooltip-sheet .sheet-close {
                position: absolute;
                top: 16px;
                right: 16px;
                background: rgba(255,255,255,0.1);
                border: none;
                color: #fff;
                width: 28px;
                height: 28px;
                border-radius: 50%;
                font-size: 16px;
                cursor: pointer;
            }
            .tooltip-overlay {
                display: none;
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 1000;
            }
            .tooltip-overlay.active { display: block; }
        }
        
        /* Overlay for modals - must be outside media query */
        .tooltip-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            pointer-events: none;
        }
        .tooltip-overlay.active { 
            display: block; 
            pointer-events: auto;
        }
        /* Ensure overlays hidden by ID as fallback */
        #tooltipOverlay, #walletOverlay, #safariOverlay {
            display: none;
        }
        #tooltipOverlay.active, #walletOverlay.active, #safariOverlay.active {
            display: block;
        }
        
        /* Wallet picker modal */
        .wallet-modal {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            padding: 24px 20px 32px;
            border-radius: 16px 16px 0 0;
            z-index: 1001;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
        }
        .wallet-modal.active { display: block; }
        .wallet-modal h3 { font-size: 17px; font-weight: 600; margin-bottom: 20px; text-align: center; }
        .wallet-option {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: var(--bg);
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.2s;
            text-decoration: none;
            color: var(--text-primary);
        }
        .wallet-option:hover { background: var(--border); }
        .wallet-option img { width: 36px; height: 36px; border-radius: 8px; }
        .wallet-option span { font-size: 15px; font-weight: 500; }
        .wallet-divider { 
            display: flex; align-items: center; gap: 12px; 
            margin: 16px 0; color: var(--text-muted); font-size: 12px; 
        }
        .wallet-divider::before, .wallet-divider::after { 
            content: ''; flex: 1; height: 1px; background: var(--border); 
        }
        .copy-url-option { background: transparent; border: 1px dashed var(--border); }
        .copy-url-option:hover { background: var(--bg); }
        .copy-url-option .copy-icon { 
            width: 36px; height: 36px; display: flex; align-items: center; 
            justify-content: center; font-size: 20px; 
        }
        .copy-url-option span { font-size: 13px; font-weight: 400; color: var(--text-secondary); }
        .wallet-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: var(--bg);
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            color: var(--text-muted);
        }
    
/* FIXED overlay behavior */
.tooltip-overlay,
#walletOverlay,
#safariOverlay {
    display: none;
    pointer-events: none;
    z-index: 900;
}

.tooltip-overlay.active,
#walletOverlay.active,
#safariOverlay.active {
    display: block;
    pointer-events: auto;
    z-index: 900;
}

.wallet-modal {
    z-index: 950;
}

/* Safari QR Modal */
.safari-modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #fff;
    padding: 32px 28px;
    border-radius: 20px;
    z-index: 1001;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    text-align: center;
    max-width: 320px;
    width: 90%;
}
.safari-modal.active { display: block; }
.safari-modal h3 { font-size: 17px; font-weight: 600; margin-bottom: 8px; }
.safari-modal p { font-size: 14px; color: var(--text-secondary); margin-bottom: 20px; line-height: 1.5; }
.safari-modal .qr-container {
    background: #fff;
    padding: 16px;
    border-radius: 12px;
    display: inline-block;
    margin-bottom: 20px;
    border: 1px solid var(--border);
}
.safari-modal .qr-container canvas { display: block; }
.safari-modal .copy-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    padding: 14px 16px;
    background: var(--bg);
    border: 1px dashed var(--border);
    border-radius: 12px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    transition: background 0.2s;
}
.safari-modal .copy-btn:hover { background: var(--border); }
.safari-modal-close {
    position: absolute;
    top: 16px;
    right: 16px;
    background: var(--bg);
    border: none;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    font-size: 16px;
    cursor: pointer;
    color: var(--text-muted);
}

</style>
</head>
<body>
    <header>
        <div class="logo">
            <div class="logo-mark"><img src="data:image/png;base64,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" alt="DRT"></div>
            <span class="logo-text">De-Risk Token</span>
        </div>
        <div class="header-actions">
            <a href="https://drt.gitbook.io/" target="_blank" class="nav-link">Docs</a>
            <button class="connect-btn" id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
        </div>
    </header>

    <main>
        <section class="hero">
            <div class="hero-badge"><span class="dot"></span> Live on Base</div>
            <h1>Bitcoin <span class="gradient">De-Risk</span> Token</h1>
            <div class="trust-badges">
                <div class="trust-badge-item">
                    <span>âœ“ Ultra Transparent</span>
                    <div class="trust-tooltip">All reserves and contracts are open-source and visible on-chain. Verify anytime on Basescan.</div>
                </div>
                <span class="separator">â€¢</span>
                <div class="trust-badge-item">
                    <span>âœ“ Counter-Cyclical Asset</span>
                    <div class="trust-tooltip">Earn when Bitcoin drops. Never lose value when Bitcoin rises. No expiration date. Claiming payouts doesn't burn your tokens â€” you keep them until you sell or redeem.</div>
                </div>
                <span class="separator">â€¢</span>
                <div class="trust-badge-item">
                    <span>âœ“ 100% Decentralized</span>
                    <div class="trust-tooltip">No admin keys. No manual controls. Fully autonomous smart contracts.</div>
                </div>
                <span class="separator">â€¢</span>
                <div class="trust-badge-item">
                    <span>âœ“ Exit Anytime</span>
                    <div class="trust-tooltip">Redeem or sell 24/7. No lockups, no waiting periods.</div>
                </div>
            </div>
        </section>

        <section class="portfolio-section">
            <div class="section-label">Your Portfolio</div>
            <div class="portfolio-grid">
                <div class="portfolio-main-card">
                    <div class="portfolio-main-label">DRT Balance</div>
                    <div class="portfolio-main-value" id="balanceValue">0.00</div>
                    <div class="portfolio-main-sub">
                        <div class="row">
                            <span>Total Value (USD)</span>
                            <span class="value" id="portfolioValue">$0.00</span>
                        </div>
                        <div class="row">
                            <span>Market Price per DRT</span>
                            <span class="value" id="drtMarketPrice">$1.00</span>
                        </div>
                    </div>
                    <a href="https://app.uniswap.org/swap?chain=base&inputCurrency=0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913&outputCurrency=0x95b264bE73a16986a18eF178962117F73ef6047F" target="_blank" class="trade-btn-bottom">Trade</a>
                </div>
                <div class="earnings-combined-card">
                    <div class="earnings-main">
                        <div class="earnings-main-label">
                            Claimable
                            <div class="tooltip-wrap" data-title="Claimable">
                                <span class="tooltip-icon">â“˜</span>
                                <span class="tooltip-text">You start getting paid when Bitcoin drops 2%. See Your Positions table below for per-position breakdown.</span>
                            </div>
                        </div>
                        <div class="earnings-main-value" id="claimableValue">$0.00</div>
                    </div>
                    <div class="earnings-details">
                        <div class="earnings-detail-row">
                            <span class="label">Lifetime</span>
                            <span class="value gold" id="totalEarnings">$0.00</span>
                        </div>
                        <div class="earnings-detail-row">
                            <span class="label">Claimed</span>
                            <span class="value muted" id="claimedValue">$0.00</span>
                        </div>
                    </div>
                    <button class="claim-btn-bottom" id="claimBtn" onclick="claimAll()" disabled>Claim Payout</button>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="positions-card">
                <div class="positions-header">
                    <h3>Your Positions <span id="lotCountDisplay" style="font-weight:400;color:var(--text-muted);"></span></h3>
                    <div class="btc-price-display">
                        <span class="btc-label">Live Bitcoin</span>
                        <span class="btc-value" id="positionBtcPrice">â€”</span>
                        <span class="btc-change" id="btcChange"></span>
                    </div>
                </div>
                <div id="lotLimitBanner"></div>
                <div id="positionsToolbar" style="display:none;">
                    <div class="positions-toolbar">
                        <div class="toolbar-left">
                            <div class="quick-select">
                                <button class="quick-select-btn" onclick="toggleQuickSelect()">
                                    <span>Select</span>
                                    <span style="font-size:10px;">â–¼</span>
                                </button>
                                <div class="quick-select-menu" id="quickSelectMenu">
                                    <div class="quick-select-item" onclick="selectAll()">Select All</div>
                                    <div class="quick-select-item" onclick="selectNone()">Select None</div>
                                    <div class="quick-select-item" onclick="selectAllDust()">Select All Dust</div>
                                    <div class="quick-select-item" onclick="selectAllClaimable()">Select All Claimable</div>
                                </div>
                            </div>
                            <div class="filter-pills">
                                <button class="filter-pill active" data-filter="all" onclick="filterLots('all')">All <span class="count" id="filterAllCount"></span></button>
                                <button class="filter-pill" data-filter="dust" onclick="filterLots('dust')">
                                    <span class="tooltip-wrap" style="margin:0;">
                                        <span>Dust</span>
                                        <span class="tooltip-icon" style="width:14px;height:14px;font-size:9px;margin-left:4px;">â“˜</span>
                                        <span class="tooltip-text" style="width:160px;">Small position (&lt; 1 DRT)</span>
                                    </span>
                                    <span class="count" id="filterDustCount"></span>
                                </button>
                                <button class="filter-pill" data-filter="claimable" onclick="filterLots('claimable')">Claimable <span class="count" id="filterClaimableCount"></span></button>
                            </div>
                            <select class="sort-select" onchange="sortLots(this.value)">
                                <option value="newest">Newest First</option>
                                <option value="oldest">Oldest First</option>
                                <option value="amount-high">Amount: High â†’ Low</option>
                                <option value="amount-low">Amount: Low â†’ High</option>
                                <option value="claimable-high">Claimable: High â†’ Low</option>
                            </select>
                        </div>
                        <div class="toolbar-right">
                            <span class="selection-counter" id="selectionCounter">0 selected</span>
                            <div class="bulk-actions">
                                <button class="bulk-btn claim" id="bulkClaimBtn" onclick="claimSelectedLots()" disabled>Claim Selected</button>
                                <button class="bulk-btn merge" id="bulkMergeBtn" onclick="showMergeModal()" disabled>Merge Selected</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="positionsContainer"><div class="positions-empty">Connect wallet to view positions</div></div>
            </div>
        </section>

        <section class="section" id="mintSection">
            <div class="section-label">Actions</div>
            <div class="actions-grid">
                <div class="action-card">
                    <div class="action-header">
                        <div class="action-icon blue">â¬†</div>
                        <h3>Mint DRT</h3>
                    </div>
                    <p>Mint new tokens when market price is above $1.00</p>
                    <div class="mint-status">
                        <div class="status-row">
                            <div class="status-badge unavailable" id="mintStatusBadge">
                                <span class="dot"></span>
                                <span id="mintStatusText">Checking...</span>
                            </div>
                            <div class="tooltip-wrap" id="mintTooltipWrap" data-title="Mint Status">
                                <span class="tooltip-icon">â“˜</span>
                                <span class="tooltip-text" id="mintTooltipText">Checking mint conditions...</span>
                            </div>
                        </div>
                        <div class="status-details">
                            <div class="status-detail">
                                <div class="tooltip-wrap" style="margin-left: 0;">
                                    <span class="label" style="cursor: help;">Mint Price â“˜</span>
                                    <span class="tooltip-text" style="left: 0; transform: none;">The current spot market price. You mint new tokens at this price.</span>
                                </div>
                                <span class="value" id="dexPrice">$1.00</span>
                            </div>
                            <div class="status-detail">
                                <div class="tooltip-wrap" style="margin-left: 0;">
                                    <span class="label" style="cursor: help;">Market Pulse â“˜</span>
                                    <span class="tooltip-text" style="left: 0; transform: none;">How much above $1 the market price of DRT is. 20% pulse means price is $1.20 and you can mint up to 20% of total supply today.</span>
                                </div>
                                <span class="value" id="pulsePercent">0%</span>
                            </div>
                            <div class="status-detail">
                                <div class="tooltip-wrap" style="margin-left: 0;">
                                    <span class="label" style="cursor: help;">Daily Cap â“˜</span>
                                    <span class="tooltip-text" style="left: 0; transform: none;">The maximum amount of new tokens that can be minted today, as a percentage of total supply. Resets at midnight UTC.</span>
                                </div>
                                <span class="value" id="dailyCapPercent">0% of supply</span>
                            </div>
                            <div class="status-detail">
                                <div class="tooltip-wrap" style="margin-left: 0;">
                                    <span class="label" style="cursor: help;">Mintable Today â“˜</span>
                                    <span class="tooltip-text" style="left: 0; transform: none; width: 240px;">Amount of DRT available to mint today. Resets at midnight UTC.</span>
                                </div>
                                <span class="value green" id="dailyCapLeft">0 DRT</span>
                            </div>
                        </div>
                    </div>
                    <div class="input-wrap">
                        <input type="number" id="mintAmount" placeholder="0.00" step="0.01">
                        <button class="max-btn" onclick="setMaxMint()">MAX</button>
                        <span class="suffix">DRT</span>
                    </div>
                    <div class="info-row"><span class="label">Cost</span><span class="value" id="mintCost">0.00 USDC</span></div>
                    <button class="btn btn-primary" id="mintBtn" onclick="mintDRT()" disabled>Mint DRT</button>
                </div>

                <div class="action-card">
                    <div class="action-header">
                        <div class="action-icon gray">â¬‡</div>
                        <h3>Redeem DRT</h3>
                    </div>
                    <p>Redeem tokens for $0.95 USDC anytime</p>
                    <div class="info-row" style="margin-top: 82px;"><span class="label">Redemption Rate</span><span class="value">$0.95/DRT</span></div>
                    <div class="input-wrap">
                        <input type="number" id="redeemAmount" placeholder="0.00" step="0.01">
                        <button class="max-btn" onclick="setMaxRedeem()">MAX</button>
                        <span class="suffix">DRT</span>
                    </div>
                    <div class="info-row"><span class="label">You Receive</span><span class="value" id="redeemReceive">0.00 USDC</span></div>
                    <button class="btn btn-primary" id="redeemBtn" onclick="redeemDRT()" disabled>Redeem DRT</button>
                </div>
            </div>
        </section>

        <section class="protocol-stats">
            <div class="stats-box">
                <div class="stats-columns">
                    <!-- Left Column: Reserves -->
                    <div class="stats-column">
                        <div class="stats-column-label">RESERVES</div>
                        <div class="stats-column-value" id="totalReserves">$0.00</div>
                        <div class="stats-breakdown">
                            <a href="https://basescan.org/address/0xf32381A5a32dbd435F71EF42f5692FF57B61C9c7" target="_blank" class="stats-breakdown-item">
                                <span class="stats-breakdown-label">Senior Vault</span>
                                <div class="tooltip-wrap" data-title="Senior Vault">
                                    <span class="tooltip-icon">â“˜</span>
                                    <span class="tooltip-text">Holds $0.95 per token. Pays claims and redemptions directly. Auto-refilled by Junior Vault.</span>
                                </div>
                                <span class="stats-breakdown-value" id="seniorVault">$0.00</span>
                            </a>
                            <a href="https://basescan.org/address/0x02657aBD69244045F0B8fDDE139F1167E1C3467a" target="_blank" class="stats-breakdown-item">
                                <span class="stats-breakdown-label">Junior Vault</span>
                                <div class="tooltip-wrap" data-title="Junior Vault">
                                    <span class="tooltip-icon">â“˜</span>
                                    <span class="tooltip-text">Dynamic surplus buffer. Auto-refills Senior Vault after claims.</span>
                                </div>
                                <span class="stats-breakdown-value" id="juniorVault">$0.00</span>
                            </a>
                        </div>
                    </div>

                    <!-- Right Column: Liabilities -->
                    <div class="stats-column">
                        <div class="stats-column-label">LIABILITIES</div>
                        <div class="stats-column-value" id="totalLiabilities">$0.00</div>
                        <div class="stats-breakdown">
                            <div class="stats-breakdown-item stats-breakdown-item-static">
                                <span class="stats-breakdown-label">Redemption</span>
                                <div class="tooltip-wrap" data-title="Redemption Liability">
                                    <span class="tooltip-icon">â“˜</span>
                                    <span class="tooltip-text">Amount owed if all holders redeem their DRT at $0.95 per token.</span>
                                </div>
                                <span class="stats-breakdown-value" id="redemptionLiability">$0.00</span>
                            </div>
                            <div class="stats-breakdown-item stats-breakdown-item-static">
                                <span class="stats-breakdown-label">Claimable</span>
                                <div class="tooltip-wrap" data-title="Claimable Liability">
                                    <span class="tooltip-icon">â“˜</span>
                                    <span class="tooltip-text">Outstanding payouts currently owed to all holders based on BTC price movement.</span>
                                </div>
                                <span class="stats-breakdown-value" id="claimableLiability">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="stats-footer-row">
                    <div class="stats-badge stats-badge-ratio">
                        <span class="badge-label">Reserve / Liability</span>
                        <div class="tooltip-wrap" data-title="Reserve / Liability">
                            <span class="tooltip-icon">â“˜</span>
                            <span class="tooltip-text">Total reserves divided by total liabilities. Above 100% means the protocol can cover all obligations.</span>
                        </div>
                        <span class="badge-value" id="backingRatio">100%</span>
                    </div>
                    <div class="stats-badge stats-badge-paid">
                        <span class="badge-label">Total Paid to Holders</span>
                        <div class="tooltip-wrap" data-title="Total Paid to Holders">
                            <span class="tooltip-icon">â“˜</span>
                            <span class="tooltip-text" id="paidTooltip">All-time USDC distributed to holders through claims and redemptions.</span>
                        </div>
                        <span class="badge-value" id="totalPaidHolders">$0.00</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="how-section">
            <div class="section-header">
                <h2>How It Works</h2>
                <p>Get the most out of Bitcoin volatility</p>
            </div>
            <div class="how-grid">
                <div class="how-card">
                    <div class="how-step">1</div>
                    <h3>Get DRT</h3>
                    <p>Get DRT on Uniswap or mint it here. This locks your starting Bitcoin price. If the price goes up, you can lock in that new high anytime you want.</p>
                </div>
                <div class="how-card">
                    <div class="how-step">2</div>
                    <h3>Collect Yield</h3>
                    <p>When Bitcoin drops 2%, you start getting paid. The system tracks the lowest point for you, so you don't have to worry about timing the bottom.</p>
                </div>
                <div class="how-card">
                    <div class="how-step">3</div>
                    <h3>Exit Anytime</h3>
                    <p>Exit anytime, 24/7. You can swap back to USDC inside the app or sell on Uniswap for instant cash.</p>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="footer-inner">
            <div class="footer-brand">De-Risk Protocol</div>
            <div class="footer-tagline">Make volatility profitable</div>
            <div class="footer-contracts">
                <a href="https://basescan.org/address/0x95b264bE73a16986a18eF178962117F73ef6047F" target="_blank" class="footer-contract-link">
                    DRT Token
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                </a>
                <a href="https://basescan.org/address/0xf32381A5a32dbd435F71EF42f5692FF57B61C9c7" target="_blank" class="footer-contract-link">
                    Senior Vault
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                </a>
                <a href="https://basescan.org/address/0x02657aBD69244045F0B8fDDE139F1167E1C3467a" target="_blank" class="footer-contract-link">
                    Junior Vault
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                </a>
            </div>
            <div class="footer-meta">
                <span class="footer-meta-item">
                    <svg class="base-logo" viewBox="0 0 111 111" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="55.5" cy="55.5" r="55.5" fill="#0052FF"/>
                        <path d="M55.4 91.9c20.1 0 36.4-16.3 36.4-36.4S75.5 19.1 55.4 19.1c-18.5 0-33.8 13.8-36 31.6h47.5v9.6H19.4c2.2 17.8 17.5 31.6 36 31.6z" fill="white"/>
                    </svg>
                    Built on Base
                </span>
                <span class="footer-dot">â—</span>
                <a href="/cdn-cgi/l/email-protection#cda9a8bb8da9a8bfa4bea6b9a2a6a8a3e3a2bfaa" class="footer-email"><span class="__cf_email__" data-cfemail="d7b3b2a197b3b2a5bea4bca3b8bcb2b9f9b8a5b0">[email&#160;protected]</span></a>
                <span class="footer-dot">â—</span>
                <div class="footer-social">
                    <a href="#" target="_blank" class="social-link" aria-label="Discord">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
                    </a>
                    <a href="#" target="_blank" class="social-link" aria-label="Farcaster">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.24 3H5.76A2.76 2.76 0 0 0 3 5.76v12.48A2.76 2.76 0 0 0 5.76 21h12.48A2.76 2.76 0 0 0 21 18.24V5.76A2.76 2.76 0 0 0 18.24 3zM7.5 6.75h9v1.5H18v6h-1.5v-4.5h-9v4.5H6v-6h1.5v-1.5zm0 10.5h9v-3h1.5v4.5h-12v-4.5h1.5v3z"/></svg>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <div id="toastContainer"></div>
    <div class="tooltip-overlay" id="tooltipOverlay" onclick="closeMobileTooltip()" style="display:none;"></div>
    
    <!-- Mobile Tooltip Bottom Sheet -->
    <div class="mobile-tooltip-sheet" id="mobileTooltipSheet">
        <button class="sheet-close" onclick="closeMobileTooltip()">Ã—</button>
        <div class="sheet-title" id="sheetTitle"></div>
        <div class="sheet-content" id="sheetContent"></div>
    </div>
    
    <!-- Wallet Picker Modal -->
    <div class="tooltip-overlay" id="walletOverlay" onclick="closeWalletModal()" style="display:none;"></div>
    <div class="wallet-modal" id="walletModal">
        <button class="wallet-modal-close" onclick="closeWalletModal()">Ã—</button>
        <h3>Connect Wallet</h3>
        <a class="wallet-option" onclick="openWallet('metamask')">
            <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask">
            <span>MetaMask</span>
        </a>
        <a class="wallet-option" onclick="openWallet('coinbase')">
            <img src="https://altcoinsbox.com/wp-content/uploads/2022/12/coinbase-wallet-logo.webp" alt="Coinbase Wallet">
            <span>Coinbase Wallet</span>
        </a>
        <a class="wallet-option" onclick="openWallet('trust')">
            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'%3E%3Crect fill='%233375BB' width='40' height='40' rx='8'/%3E%3Cpath d='M20 8c5.5 3 10 3 10 3v11c0 6-10 12-10 12s-10-6-10-12V11s4.5 0 10-3z' fill='white'/%3E%3C/svg%3E" alt="Trust Wallet">
            <span>Trust Wallet</span>
        </a>
        <a class="wallet-option" onclick="openWallet('rainbow')">
            <img src="https://avatars.githubusercontent.com/u/48327834?s=200&v=4" alt="Rainbow">
            <span>Rainbow</span>
        </a>
        <div class="wallet-divider">
            <span>or</span>
        </div>
        <a class="wallet-option copy-url-option" onclick="copyDappUrl()">
            <div class="copy-icon">ðŸ“‹</div>
            <span>Copy URL to paste in wallet browser</span>
        </a>
    </div>

    <!-- Safari QR Code Modal -->
    <div class="tooltip-overlay" id="safariOverlay" onclick="closeSafariModal()" style="display:none;"></div>
    <div class="safari-modal" id="safariModal">
        <button class="safari-modal-close" onclick="closeSafariModal()">Ã—</button>
        <h3>Safari Not Supported</h3>
        <p>Safari doesn't support wallet extensions. Scan to open on your phone:</p>
        <div class="qr-container">
            <canvas id="safariQrCode"></canvas>
        </div>
        <button class="copy-btn" onclick="copyDappUrlFromSafari()">
            <span>ðŸ“‹</span> Copy URL
        </button>
    </div>

    <!-- Lock New High Confirmation Modal -->
    <div id="lockModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h3>Lock New High</h3>
            <p class="modal-desc">Update your entry price to the current BTC price for eligible positions.</p>
            <div class="modal-warning" id="lockWarning" style="display:none;"></div>
            <div class="modal-details">
                <div class="modal-row">
                    <span>Positions to update</span>
                    <span id="modalEligibleCount">0</span>
                </div>
                <div class="modal-row">
                    <span>New entry price</span>
                    <span id="modalNewPrice">$0</span>
                </div>
            </div>
            <p class="modal-note">How it works: Your wallet will show a transfer of all tokens to yourself. This is required to trigger the update, but only eligible positions (where BTC is higher than entry) will be changed. Ineligible positions remain unchanged. Your tokens stay in your wallet the entire time.</p>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeLockModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmLockNewHigh()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Claim Payout Confirmation Modal -->
    <div id="claimModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h3>Claim Payout</h3>
            <p class="modal-desc">You'll receive USDC in your wallet for your claimable positions.</p>
            <div class="modal-details">
                <div class="modal-row">
                    <span>You'll receive</span>
                    <span id="modalClaimAmount">$0.00 USDC</span>
                </div>
            </div>
            <p class="modal-note">This will reset your Bitcoin entry price to the current price for claimed positions.</p>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeClaimModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmClaimAll()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Merge Modal -->
    <div class="merge-modal-overlay" id="mergeModalOverlay" onclick="closeMergeModal(event)">
        <div class="merge-modal" onclick="event.stopPropagation()">
            <div class="merge-modal-header">
                <div class="merge-modal-icon" id="mergeModalIcon">âš ï¸</div>
                <h3 class="merge-modal-title" id="mergeModalTitle">Merge Positions</h3>
            </div>
            <div class="merge-modal-body">
                <p id="mergeModalDesc">Combine selected positions into one.</p>
                <div class="merge-modal-details">
                    <div class="merge-modal-detail">
                        <span class="label">Positions to merge</span>
                        <span class="value" id="mergeModalCount">0</span>
                    </div>
                    <div class="merge-modal-detail">
                        <span class="label">Total DRT</span>
                        <span class="value" id="mergeModalAmount">0.00 DRT</span>
                    </div>
                    <div class="merge-modal-detail">
                        <span class="label">New entry price</span>
                        <span class="value" id="mergeModalEntry">Current BTC</span>
                    </div>
                    <div class="merge-modal-detail" id="mergeModalClaimableRow" style="display:none;">
                        <span class="label">Unclaimed payouts</span>
                        <span class="value warning" id="mergeModalClaimable">$0.00</span>
                    </div>
                </div>
            </div>
            <div class="merge-modal-buttons" id="mergeModalButtons">
                <!-- Buttons injected by JS -->
            </div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // Contract addresses - TDRT v18
        const TDRT_ADDRESS = "0x95b264bE73a16986a18eF178962117F73ef6047F";
        const SENIOR_ADDRESS = "0xf32381A5a32dbd435F71EF42f5692FF57B61C9c7";
        const JUNIOR_ADDRESS = "0x02657aBD69244045F0B8fDDE139F1167E1C3467a";
        const USDC_ADDRESS = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";
        const CBBTC_USD_FEED = "0x07DA0E54543a844a80ABE69c8A12F22B3aA59f9D";

        // ABIs - v17
        const TDRT_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function totalSupply() view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function getBtcPrice() view returns (uint256)",
            "function getDexPrice() view returns (uint256)",
            "function getPremiumBps() view returns (uint256)",
            "function getMintCapacity() view returns (uint256 capacity, uint256 used, uint256 remaining)",
            "function checkMintConditions() view returns (bool canMint, uint256 dexPrice, uint256 premiumBps, uint256 dailyCapacity, uint256 dailyUsed, uint256 dailyRemaining, uint256 trueMaxMint)",
            "function getUserLots(address) view returns (tuple(uint256 amount, uint256 anchorPrice, uint256 lowestPrice, uint256 timestamp, uint256 purchasePrice)[])",
            "function getUserStats(address) view returns (uint256 totalTokens, uint256 lotCount, uint256 averageAnchor, uint256 lowestTracked)",
            "function checkClaimStatus(address user, uint256 lotIndex) view returns (bool canClaim, uint256 potentialPayout, uint256 anchorPrice, uint256 lowestPrice, uint256 currentBtcPrice)",
            "function mint(uint256 usdcAmount)",
            "function redeem(uint256 amount)",
            "function claim(uint256 lotIndex)",
            "function claimLots(uint256[] lotIndices)",
            "function mergeLots(uint256[] lotIndices)",
            "function claimAndMergeLots(uint256[] lotIndices)",
            "function transfer(address to, uint256 amount) returns (bool)",
            "function getCheckpointsCount() view returns (uint256)",
            "event Minted(address indexed user, uint256 amount, uint256 btcPrice, uint256 usdcPaid, uint256 founderFee)",
            "event Claimed(address indexed user, uint256 lotIndex, uint256 payout, uint256 btcPriceAtClaim)",
            "event LotsClaimed(address indexed user, uint256 lotCount, uint256 totalPayout)",
            "event LotsMerged(address indexed user, uint256 mergedCount, uint256 newAmount, uint256 newAnchor)",
            "event Redeemed(address indexed user, uint256 amount, uint256 usdcReceived)",
            "event PartialClaim(address indexed user, uint256 lotIndex, uint256 requestedPayout, uint256 actualPayout)",
            "event PartialRedeem(address indexed user, uint256 amount, uint256 requestedUsdc, uint256 actualUsdc)"
        ];

        const VAULT_ABI = ["function balance() view returns (uint256)"];
        const ERC20_ABI = ["function approve(address, uint256) returns (bool)", "function allowance(address, address) view returns (uint256)", "function balanceOf(address) view returns (uint256)"];
        const CHAINLINK_ABI = ["function latestRoundData() view returns (uint80, int256, uint256, uint256, uint80)"];

        // State
        let provider, signer, userAddress;
        let tdrtContract, seniorContract, juniorContract, usdcContract, chainlinkContract;
        let currentMarketPrice = 1.00;
        let userLotsData = [];
        let userBalance = 0;
        let remainingDailyCap = 0;
        let refreshInterval;

        // Detect mobile
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        // Detect Safari on desktop
        function isSafariDesktop() {
            const ua = navigator.userAgent;
            const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
            return isSafari && !isMobile();
        }
        
        // Simple QR Code generator (no external library)
        function generateQRCode(canvas, text, size = 180) {
            const ctx = canvas.getContext('2d');
            canvas.width = size;
            canvas.height = size;
            
            // Use a simple QR code generation via external API rendered to canvas
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = function() {
                ctx.drawImage(img, 0, 0, size, size);
            };
            img.src = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(text)}&margin=0`;
        }
        
        // Safari modal functions
        function showSafariModal() {
            document.getElementById('safariOverlay').style.display = 'block';
            document.getElementById('safariOverlay').classList.add('active');
            document.getElementById('safariModal').classList.add('active');
            // Generate QR code
            const canvas = document.getElementById('safariQrCode');
            generateQRCode(canvas, window.location.href);
        }
        
        function closeSafariModal() {
            document.getElementById('safariOverlay').style.display = 'none';
            document.getElementById('safariOverlay').classList.remove('active');
            document.getElementById('safariModal').classList.remove('active');
        }
        
        async function copyDappUrlFromSafari() {
            try {
                await navigator.clipboard.writeText(window.location.href);
                showToast('URL copied!', 'success');
                closeSafariModal();
            } catch (e) {
                const input = document.createElement('input');
                input.value = window.location.href;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                showToast('URL copied!', 'success');
                closeSafariModal();
            }
        }

        // Wallet modal functions
        function showWalletModal() {
            document.getElementById('walletOverlay').style.display = 'block';
            document.getElementById('walletOverlay').classList.add('active');
            document.getElementById('walletModal').classList.add('active');
        }
        
        function closeWalletModal() {
            document.getElementById('walletOverlay').style.display = 'none';
            document.getElementById('walletOverlay').classList.remove('active');
            document.getElementById('walletModal').classList.remove('active');
        }
        
        function openWallet(wallet) {
            const dappUrl = window.location.href;
            const host = window.location.host + window.location.pathname;
            
            const links = {
                // MetaMask: opens MetaMask browser with the dapp
                metamask: `https://metamask.app.link/dapp/${host}`,
                // Coinbase Wallet: opens Coinbase browser with the dapp
                coinbase: `https://go.cb-w.com/dapp?cb_url=${encodeURIComponent(dappUrl)}`,
                // Trust Wallet: opens Trust browser with the dapp
                trust: `trust://open_url?coin_id=60&url=${encodeURIComponent(dappUrl)}`,
                // Rainbow: opens Rainbow browser with the dapp
                rainbow: `https://rnbwapp.com/dapp?url=${encodeURIComponent(dappUrl)}`
            };
            
            closeWalletModal();
            window.location.href = links[wallet];
        }
        
        // Copy dapp URL to clipboard
        async function copyDappUrl() {
            try {
                await navigator.clipboard.writeText(window.location.href);
                showToast('URL copied! Paste in your wallet browser.', 'success');
                closeWalletModal();
            } catch (e) {
                // Fallback for older browsers
                const input = document.createElement('input');
                input.value = window.location.href;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                showToast('URL copied! Paste in your wallet browser.', 'success');
                closeWalletModal();
            }
        }

        // Connect wallet
        async function connectWallet() {
            // Mobile without injected wallet - show wallet picker
            if (isMobile() && !window.ethereum) {
                showWalletModal();
                return;
            }
            
            // Safari desktop - show QR code modal
            if (isSafariDesktop() && !window.ethereum) {
                showSafariModal();
                return;
            }
            
            if (!window.ethereum) { 
                showToast('Please install a Web3 wallet (MetaMask, Coinbase Wallet, etc.)', 'error'); 
                return; 
            }
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum, "any");
                await provider.send("eth_requestAccounts", []);
                const network = await provider.getNetwork();
                
                if (network.chainId !== 8453) {
                    try {
                        await window.ethereum.request({ 
                            method: 'wallet_switchEthereumChain', 
                            params: [{ chainId: '0x2105' }] 
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x2105',
                                    chainName: 'Base',
                                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                    rpcUrls: ['https://mainnet.base.org'],
                                    blockExplorerUrls: ['https://basescan.org']
                                }]
                            });
                        }
                    }
                    provider = new ethers.providers.Web3Provider(window.ethereum, "any");
                }
                
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                document.getElementById('connectBtn').textContent = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
                document.getElementById('connectBtn').classList.add('connected');
                
                tdrtContract = new ethers.Contract(TDRT_ADDRESS, TDRT_ABI, signer);
                seniorContract = new ethers.Contract(SENIOR_ADDRESS, VAULT_ABI, provider);
                juniorContract = new ethers.Contract(JUNIOR_ADDRESS, VAULT_ABI, provider);
                usdcContract = new ethers.Contract(USDC_ADDRESS, ERC20_ABI, signer);
                chainlinkContract = new ethers.Contract(CBBTC_USD_FEED, CHAINLINK_ABI, provider);
                
                await refreshData();
                if (refreshInterval) clearInterval(refreshInterval);
                refreshInterval = setInterval(refreshData, 30000);
                
                showToast('Connected to Base', 'success');
            } catch (e) { 
                console.error('Connect error:', e);
                showToast(e.message, 'error'); 
            }
        }

        // Refresh all data
        let isRefreshing = false;
        async function refreshData() {
            if (!tdrtContract) return;
            if (isRefreshing) return; // Prevent concurrent refreshes
            isRefreshing = true;
            
            try {
                // BTC price
                let currentBtc;
                try {
                    const roundData = await chainlinkContract.latestRoundData();
                    currentBtc = Number(roundData[1]) / 1e8;
                } catch (e) {
                    const btcPrice = await tdrtContract.getBtcPrice();
                    currentBtc = Number(btcPrice) / 1e8;
                }
                
                // Store for modal
                currentBtcForModal = currentBtc;
                
                // Update BTC price display in positions header
                const btcDisplay = document.getElementById('positionBtcPrice');
                if (btcDisplay) btcDisplay.textContent = '$' + currentBtc.toLocaleString(undefined, {maximumFractionDigits: 0});
                
                // 24h change indicator (placeholder - would need historical data API for real values)
                const btcChangeEl = document.getElementById('btcChange');
                if (btcChangeEl) {
                    // For now just show a neutral indicator since we don't have 24h historical data
                    btcChangeEl.textContent = '';
                }

                // DEX price
                const dexPrice = await tdrtContract.getDexPrice();
                currentMarketPrice = Number(dexPrice) / 1e6;
                document.getElementById('drtMarketPrice').textContent = '$' + currentMarketPrice.toFixed(2);
                document.getElementById('dexPrice').textContent = '$' + currentMarketPrice.toFixed(4);

                // Balance (v8 uses 6 decimals)
                const bal = await tdrtContract.balanceOf(userAddress);
                const balNum = Number(bal) / 1e6;
                userBalance = balNum;
                document.getElementById('balanceValue').textContent = balNum.toFixed(2);

                // Portfolio value
                const portfolioValue = balNum * currentMarketPrice;
                document.getElementById('portfolioValue').textContent = '$' + portfolioValue.toFixed(2);

                // Load user lots and calculate claimable
                await loadUserLots(currentBtc);
                
                // Button states
                document.getElementById('redeemBtn').disabled = balNum <= 0;

                await checkMintStatus();
                await loadVaultData();
                await loadPositions(currentBtc);
                
                // Hide any loading overlay
                hideLoadingState();
            } catch (e) { 
                console.error('refreshData error:', e);
                hideLoadingState();
            } finally {
                isRefreshing = false;
            }
        }

        // Load user lots
        async function loadUserLots(currentBtc) {
            try {
                const lots = await tdrtContract.getUserLots(userAddress);
                userLotsData = [];
                let totalClaimable = 0;

                for (let i = 0; i < lots.length; i++) {
                    const lot = lots[i];
                    const amt = Number(lot.amount) / 1e6;
                    if (amt < 0.0001) continue;

                    try {
                        const status = await tdrtContract.checkClaimStatus(userAddress, i);
                        const payout = Number(status.potentialPayout) / 1e6;
                        userLotsData.push({
                            index: i,
                            amount: amt,
                            anchorPrice: Number(lot.anchorPrice) / 1e8,
                            lowestPrice: Number(status.lowestPrice) / 1e8,  // Use effectiveLowest from checkClaimStatus
                            timestamp: Number(lot.timestamp),
                            purchasePrice: Number(lot.purchasePrice) / 1e6,
                            canClaim: status.canClaim,
                            payout: payout
                        });
                        totalClaimable += payout;
                    } catch (e) {
                        userLotsData.push({
                            index: i,
                            amount: amt,
                            anchorPrice: Number(lot.anchorPrice) / 1e8,
                            lowestPrice: Number(lot.lowestPrice) / 1e8,  // Fallback to stored if checkClaimStatus fails
                            timestamp: Number(lot.timestamp),
                            purchasePrice: Number(lot.purchasePrice) / 1e6,
                            canClaim: false,
                            payout: 0
                        });
                    }
                }

                // Smart format: show more decimals for small amounts
                function formatUsd(val) {
                    if (val < 0.01 && val > 0) return '$' + val.toFixed(4);
                    return '$' + val.toFixed(2);
                }

                // Query historical Claimed events for this user
                let totalClaimed = 0;
                try {
                    // Single claim events
                    const filter = tdrtContract.filters.Claimed(userAddress);
                    const events = await tdrtContract.queryFilter(filter);
                    totalClaimed = events.reduce((sum, e) => sum + Number(e.args.payout) / 1e6, 0);
                    
                    // Batch claim events (claimLots, claimAndMergeLots)
                    const batchFilter = tdrtContract.filters.LotsClaimed(userAddress);
                    const batchEvents = await tdrtContract.queryFilter(batchFilter);
                    totalClaimed += batchEvents.reduce((sum, e) => sum + Number(e.args.totalPayout) / 1e6, 0);
                } catch (e) {
                    console.log('Could not query claim history:', e);
                }

                const totalEarnings = totalClaimed + totalClaimable;

                document.getElementById('claimableValue').textContent = formatUsd(totalClaimable);
                document.getElementById('claimedValue').textContent = formatUsd(totalClaimed);
                document.getElementById('totalEarnings').textContent = formatUsd(totalEarnings);
                document.getElementById('claimBtn').disabled = totalClaimable <= 0;
            } catch (e) {
                console.error('loadUserLots error:', e);
                userLotsData = [];
            }
        }

        // Countdown interval for cap reset
        let countdownInterval;

        function getTimeUntilMidnightUTC() {
            const now = new Date();
            const midnight = new Date(now);
            midnight.setUTCDate(midnight.getUTCDate() + 1);
            midnight.setUTCHours(0, 0, 0, 0);
            const diff = midnight - now;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            return hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
        }

        function startCapCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                const tooltip = document.getElementById('mintTooltipText');
                if (tooltip && remainingDailyCap < 0.01) {
                    tooltip.textContent = 'Daily mint cap reached. Unlocks at midnight UTC (in ' + getTimeUntilMidnightUTC() + ') or if market price rises.';
                }
            }, 1000);
        }

        // Check mint status - v14 elastic cap with Market Pulse and true max
        let trueMaxMintable = 0;
        async function checkMintStatus() {
            try {
                const c = await tdrtContract.checkMintConditions();
                const canMint = c.canMint;
                const dexPrice = Number(c.dexPrice) / 1e6;
                const premiumBps = Number(c.premiumBps);
                const pulsePercent = premiumBps / 100;
                const dailyCapacity = Number(c.dailyCapacity) / 1e6;
                const dailyUsed = Number(c.dailyUsed) / 1e6;
                remainingDailyCap = Number(c.dailyRemaining) / 1e6;
                trueMaxMintable = Number(c.trueMaxMint) / 1e6;

                document.getElementById('pulsePercent').textContent = '+' + pulsePercent.toFixed(1) + '%';
                document.getElementById('dailyCapPercent').textContent = pulsePercent.toFixed(1) + '% of supply';
                document.getElementById('dailyCapLeft').textContent = remainingDailyCap.toFixed(2) + ' DRT';

                const badge = document.getElementById('mintStatusBadge');
                const text = document.getElementById('mintStatusText');
                const tooltip = document.getElementById('mintTooltipText');
                const mintBtn = document.getElementById('mintBtn');

                if (dexPrice <= 1.00) {
                    // Price at or below $1.00 - closed
                    badge.className = 'status-badge unavailable';
                    text.textContent = 'Closed';
                    tooltip.innerHTML = 'Minting is closed. Market price must be above $1.00 to mint new tokens. Current price: $' + dexPrice.toFixed(4) + ' <a href="https://app.uniswap.org/swap?chain=base&inputCurrency=0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913&outputCurrency=0x95b264bE73a16986a18eF178962117F73ef6047F" target="_blank" style="color:#007aff;text-decoration:none;font-weight:600;">Trade â†’</a>';
                    mintBtn.disabled = true;
                    if (countdownInterval) clearInterval(countdownInterval);
                } else if (remainingDailyCap < 0.01) {
                    // Cap reached
                    badge.className = 'status-badge capped';
                    text.textContent = 'Cap Reached';
                    tooltip.innerHTML = 'Daily mint cap reached. Unlocks at midnight UTC (in ' + getTimeUntilMidnightUTC() + ') or if market price rises. <a href="https://app.uniswap.org/swap?chain=base&inputCurrency=0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913&outputCurrency=0x95b264bE73a16986a18eF178962117F73ef6047F" target="_blank" style="color:#007aff;text-decoration:none;font-weight:600;">Trade â†’</a>';
                    mintBtn.disabled = true;
                    startCapCountdown();
                } else {
                    // Open for minting
                    badge.className = 'status-badge available';
                    text.textContent = 'Open';
                    tooltip.textContent = 'Minting is open. Available when market price is above $1.00, capped at ' + pulsePercent.toFixed(1) + '% of total supply today.';
                    mintBtn.disabled = false;
                    if (countdownInterval) clearInterval(countdownInterval);
                }
            } catch (e) {
                console.error('checkMintStatus error:', e);
                document.getElementById('mintStatusText').textContent = 'Error';
            }
        }

        // Load vault data (works without wallet connection)
        async function loadVaultData() {
            try {
                // Use read-only provider if no wallet connected
                const readProvider = provider || new ethers.providers.JsonRpcProvider('https://mainnet.base.org');
                const seniorRead = new ethers.Contract(SENIOR_ADDRESS, VAULT_ABI, readProvider);
                const juniorRead = new ethers.Contract(JUNIOR_ADDRESS, VAULT_ABI, readProvider);
                const tdrtRead = new ethers.Contract(TDRT_ADDRESS, TDRT_ABI, readProvider);
                
                const seniorBal = await seniorRead.balance();
                const juniorBal = await juniorRead.balance();
                const supply = await tdrtRead.totalSupply();
                const senior = Number(seniorBal) / 1e6;
                const junior = Number(juniorBal) / 1e6;
                const totalSupply = Number(supply) / 1e6;
                const totalReserves = senior + junior;
                
                // Calculate redemption liability (totalSupply Ã— $0.95)
                const redemptionLiability = totalSupply * 0.95;
                
                // Update basic displays
                document.getElementById('seniorVault').textContent = '$' + senior.toFixed(2);
                document.getElementById('juniorVault').textContent = '$' + junior.toFixed(2);
                document.getElementById('totalReserves').textContent = '$' + totalReserves.toFixed(2);
                document.getElementById('redemptionLiability').textContent = '$' + redemptionLiability.toFixed(2);
                
                // Load claimable liability and paid totals in background
                loadProtocolMetrics(tdrtRead, readProvider, totalReserves, redemptionLiability);
                
            } catch (e) { 
                console.error('loadVaultData error:', e); 
            }
        }
        
        // Load protocol metrics (claimable liability, total paid) from Cloudflare worker
        async function loadProtocolMetrics(tdrtRead, readProvider, totalReserves, redemptionLiability) {
            try {
                const res = await fetch('https://drt-metrics.tdrt-protocol.workers.dev');
                const data = await res.json();
                
                const totalClaimableLiability = data.claimableLiability || 0;
                const totalPaidToHolders = data.totalPaid || 0;
                const claimsPaid = data.claimsPaid || 0;
                const redemptionsPaid = data.redemptionsPaid || 0;
                
                const totalLiabilities = redemptionLiability + totalClaimableLiability;
                const reserveRatio = totalLiabilities > 0 ? (totalReserves / totalLiabilities * 100) : 100;
                
                // Update displays
                document.getElementById('claimableLiability').textContent = '$' + totalClaimableLiability.toFixed(2);
                document.getElementById('totalLiabilities').textContent = '$' + totalLiabilities.toFixed(2);
                document.getElementById('totalPaidHolders').textContent = '$' + totalPaidToHolders.toFixed(2);
                
                // Update tooltip with breakdown
                const paidTooltip = document.getElementById('paidTooltip');
                if (paidTooltip) {
                    paidTooltip.textContent = `Claims: $${claimsPaid.toFixed(2)} Â· Redemptions: $${redemptionsPaid.toFixed(2)}`;
                }
                
                // Update ratio with color coding
                const ratioEl = document.getElementById('backingRatio');
                const ratioBadge = ratioEl.closest('.stats-badge-ratio');
                const ratioNum = Math.round(reserveRatio);
                ratioEl.textContent = ratioNum + '%';
                ratioBadge.classList.remove('ratio-warning', 'ratio-danger');
                if (ratioNum < 100) {
                    ratioBadge.classList.add('ratio-danger');
                } else if (ratioNum < 105) {
                    ratioBadge.classList.add('ratio-warning');
                }
                
            } catch (e) {
                console.error('loadProtocolMetrics error:', e);
                // Set fallback values
                document.getElementById('claimableLiability').textContent = '$0.00';
                document.getElementById('totalLiabilities').textContent = '$' + redemptionLiability.toFixed(2);
                const ratioEl = document.getElementById('backingRatio');
                const ratioNum = redemptionLiability > 0 ? Math.round(totalReserves / redemptionLiability * 100) : 100;
                ratioEl.textContent = ratioNum + '%';
            }
        }
        
        // Load vault data on page load
        document.addEventListener('DOMContentLoaded', loadVaultData);

        // Load positions table
        let anyLotCanRelock = false;
        let selectedLots = new Set();
        let currentFilter = 'all';
        let currentSort = 'newest';
        let currentBtcPriceGlobal = 0;
        const DUST_THRESHOLD = 1; // 1 DRT

        async function loadPositions(currentBtc) {
            currentBtcPriceGlobal = currentBtc;
            const container = document.getElementById('positionsContainer');
            const toolbar = document.getElementById('positionsToolbar');
            const lotLimitBanner = document.getElementById('lotLimitBanner');
            const lotCountDisplay = document.getElementById('lotCountDisplay');
            anyLotCanRelock = false;
            
            if (userLotsData.length === 0) {
                container.innerHTML = '<div class="positions-empty"><a href="https://app.uniswap.org/swap?chain=base&inputCurrency=0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913&outputCurrency=0x95b264bE73a16986a18eF178962117F73ef6047F" target="_blank">Buy</a> or <a href="#mintSection">Mint</a> DRT to get started.</div>';
                toolbar.style.display = 'none';
                lotLimitBanner.innerHTML = '';
                lotCountDisplay.textContent = '';
                return;
            }

            // Show toolbar
            toolbar.style.display = 'block';
            
            // Show lot count and limit banner
            const lotCount = userLotsData.length;
            lotCountDisplay.textContent = `(${lotCount}/100)`;
            
            if (lotCount >= 100) {
                lotLimitBanner.innerHTML = `<div class="lot-limit-banner danger"><span class="icon">ðŸš«</span> <strong>Max lot limit reached (100/100).</strong> Merge existing positions to receive new DRT transfers.</div>`;
            } else if (lotCount >= 95) {
                lotLimitBanner.innerHTML = `<div class="lot-limit-banner danger"><span class="icon">âš ï¸</span> <strong>Almost at limit (${lotCount}/100).</strong> Merge positions soon to keep receiving transfers.</div>`;
            } else if (lotCount >= 80) {
                lotLimitBanner.innerHTML = `<div class="lot-limit-banner"><span class="icon">âš ï¸</span> Approaching lot limit: ${lotCount}/100. Consider merging positions.</div>`;
            } else {
                lotLimitBanner.innerHTML = '';
            }
            
            // Update filter counts
            const dustCount = userLotsData.filter(l => l.amount < DUST_THRESHOLD).length;
            const claimableCount = userLotsData.filter(l => l.canClaim).length;
            document.getElementById('filterAllCount').textContent = `(${lotCount})`;
            document.getElementById('filterDustCount').textContent = `(${dustCount})`;
            document.getElementById('filterClaimableCount').textContent = `(${claimableCount})`;
            
            // Apply filter
            let filteredLots = [...userLotsData];
            if (currentFilter === 'dust') {
                filteredLots = filteredLots.filter(l => l.amount < DUST_THRESHOLD);
            } else if (currentFilter === 'claimable') {
                filteredLots = filteredLots.filter(l => l.canClaim);
            }
            
            // Apply sort (use index as secondary key for stable sorting when primary values are equal)
            switch (currentSort) {
                case 'newest': 
                    filteredLots.sort((a, b) => {
                        if (a.timestamp !== b.timestamp) return b.timestamp - a.timestamp;
                        return b.index - a.index;
                    }); 
                    break;
                case 'oldest': 
                    filteredLots.sort((a, b) => {
                        if (a.timestamp !== b.timestamp) return a.timestamp - b.timestamp;
                        return a.index - b.index;
                    }); 
                    break;
                case 'amount-high': filteredLots.sort((a, b) => b.amount - a.amount || a.index - b.index); break;
                case 'amount-low': filteredLots.sort((a, b) => a.amount - b.amount || a.index - b.index); break;
                case 'claimable-high': filteredLots.sort((a, b) => b.payout - a.payout || a.index - b.index); break;
            }

            let html = `<table class="positions-table"><thead><tr>
                <th style="width:40px;"><input type="checkbox" class="select-all-checkbox" onchange="toggleSelectAll(this)" /></th>
                <th>Opened</th>
                <th>Amount</th>
                <th><div class="tooltip-wrap"><span style="cursor:help;">Entry BTC â“˜</span><span class="tooltip-text" style="width:220px;">The BTC price when you acquired this position. You can lock new high when BTC price is higher.</span></div></th>
                <th><button class="lock-header-btn" id="lockNewHighBtn" onclick="lockNewHigh()" disabled>â†‘ Lock New High</button><div class="tooltip-wrap" data-title="â†‘ Lock New High"><span class="tooltip-icon" style="margin-left:4px;">â“˜</span><span class="tooltip-text" style="width:220px;">Lock current BTC price as your new entry. Only available when BTC is higher than your entry.</span></div></th>
                <th><div class="tooltip-wrap"><span style="cursor:help;">Claim Below â“˜</span><span class="tooltip-text" style="width:200px;">You can claim payouts when BTC drops 2% from your entry.</span></div></th>
                <th><div class="tooltip-wrap"><span style="cursor:help;">Tracked Low â“˜</span><span class="tooltip-text" style="width:200px;">The lowest BTC price recorded since you opened this position. Payouts are based on this.</span></div></th>
                <th>Claimable</th>
                <th></th>
            </tr></thead><tbody>`;

            filteredLots.forEach((lot) => {
                const date = new Date(lot.timestamp * 1000).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const lowest = lot.lowestPrice;
                const changePercent = ((lowest - lot.anchorPrice) / lot.anchorPrice) * 100;
                const isDust = lot.amount < DUST_THRESHOLD;
                const isSelected = selectedLots.has(lot.index);
                
                let changeDisplay;
                if (Math.abs(changePercent) < 0.05) {
                    changeDisplay = '<span class="change-indicator muted">0.0%</span>';
                } else if (changePercent < 0) {
                    changeDisplay = `<span class="change-indicator red">â–¼ ${Math.abs(changePercent).toFixed(1)}%</span>`;
                } else {
                    changeDisplay = `<span class="change-indicator green">â–² ${Math.abs(changePercent).toFixed(1)}%</span>`;
                }
                
                const canRelock = currentBtc > lot.anchorPrice;
                if (canRelock) anyLotCanRelock = true;
                const relockStatus = canRelock 
                    ? `<span class="relock-chip available" title="Click 'Lock New High' to update entry to $${currentBtc.toLocaleString(undefined, {maximumFractionDigits: 0})}">â†‘ $${currentBtc.toLocaleString(undefined, {maximumFractionDigits: 0})}</span>` 
                    : `<span class="relock-chip current"><span class="tooltip-wrap" data-title="Current" style="margin:0;"><span>Current</span><span class="tooltip-text" style="width:200px;">Your entry price is already higher than current BTC, so no need to lock new high.</span></span></span>`;

                html += `<tr class="${isSelected ? 'selected' : ''}" data-index="${lot.index}">
                    <td><input type="checkbox" class="lot-checkbox" data-index="${lot.index}" ${isSelected ? 'checked' : ''} onchange="toggleLotSelection(${lot.index})" /></td>
                    <td class="muted">${date}</td>
                    <td class="bold">${lot.amount.toFixed(2)} DRT${isDust ? '<span class="tooltip-wrap" data-title="Dust" style="margin:0;"><span class="dust-tag">DUST</span><span class="tooltip-text" style="width:160px;">Small position (&lt; 1 DRT)</span></span>' : ''}</td>
                    <td>$${lot.anchorPrice.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                    <td>${relockStatus}</td>
                    <td>$${(lot.anchorPrice * 0.98).toLocaleString(undefined, {maximumFractionDigits: 0})} <span class="deductible-tag">-2%</span></td>
                    <td>$${lowest.toLocaleString(undefined, {maximumFractionDigits: 0})} ${changeDisplay}</td>
                    <td class="green">${lot.payout < 0.01 && lot.payout > 0 ? '$' + lot.payout.toFixed(4) : '$' + lot.payout.toFixed(2)}</td>
                    <td>${lot.canClaim ? `<button onclick="claimLot(${lot.index})" style="background:var(--green);color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;">Claim</button>` : ''}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = '<div class="positions-table-wrapper">' + html + '</div>';
            
            // Enable/disable Lock New High button
            const lockBtn = document.getElementById('lockNewHighBtn');
            if (lockBtn) lockBtn.disabled = !anyLotCanRelock;
            
            updateBulkActionButtons();
            updateSelectionCounter();
        }

        // Toggle lot selection
        function toggleLotSelection(index) {
            if (selectedLots.has(index)) {
                selectedLots.delete(index);
            } else {
                selectedLots.add(index);
            }
            // Update row styling
            const row = document.querySelector(`tr[data-index="${index}"]`);
            if (row) row.classList.toggle('selected', selectedLots.has(index));
            updateBulkActionButtons();
            updateSelectionCounter();
        }

        // Toggle select all
        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.lot-checkbox');
            checkboxes.forEach(cb => {
                const index = parseInt(cb.dataset.index);
                if (checkbox.checked) {
                    selectedLots.add(index);
                } else {
                    selectedLots.delete(index);
                }
                cb.checked = checkbox.checked;
                const row = document.querySelector(`tr[data-index="${index}"]`);
                if (row) row.classList.toggle('selected', checkbox.checked);
            });
            updateBulkActionButtons();
            updateSelectionCounter();
        }

        // Quick select functions
        function toggleQuickSelect() {
            document.getElementById('quickSelectMenu').classList.toggle('show');
        }
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.quick-select')) {
                document.getElementById('quickSelectMenu')?.classList.remove('show');
            }
        });

        function selectAll() {
            userLotsData.forEach(lot => selectedLots.add(lot.index));
            loadPositions(currentBtcPriceGlobal);
            document.getElementById('quickSelectMenu').classList.remove('show');
        }

        function selectNone() {
            selectedLots.clear();
            loadPositions(currentBtcPriceGlobal);
            document.getElementById('quickSelectMenu').classList.remove('show');
        }

        function selectAllDust() {
            selectedLots.clear();
            userLotsData.filter(l => l.amount < DUST_THRESHOLD).forEach(lot => selectedLots.add(lot.index));
            loadPositions(currentBtcPriceGlobal);
            document.getElementById('quickSelectMenu').classList.remove('show');
        }

        function selectAllClaimable() {
            selectedLots.clear();
            userLotsData.filter(l => l.canClaim).forEach(lot => selectedLots.add(lot.index));
            loadPositions(currentBtcPriceGlobal);
            document.getElementById('quickSelectMenu').classList.remove('show');
        }

        // Filter lots
        function filterLots(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
            document.querySelector(`.filter-pill[data-filter="${filter}"]`).classList.add('active');
            loadPositions(currentBtcPriceGlobal);
        }

        // Sort lots
        function sortLots(sort) {
            currentSort = sort;
            loadPositions(currentBtcPriceGlobal);
        }

        // Update bulk action buttons
        function updateBulkActionButtons() {
            const count = selectedLots.size;
            const selectedLotsData = userLotsData.filter(l => selectedLots.has(l.index));
            const hasClaimable = selectedLotsData.some(l => l.canClaim);
            const canMerge = count >= 2;
            
            document.getElementById('bulkClaimBtn').disabled = !hasClaimable;
            document.getElementById('bulkMergeBtn').disabled = !canMerge;
        }

        // Update selection counter
        function updateSelectionCounter() {
            const count = selectedLots.size;
            const selectedLotsData = userLotsData.filter(l => selectedLots.has(l.index));
            const totalAmount = selectedLotsData.reduce((sum, l) => sum + l.amount, 0);
            const totalClaimable = selectedLotsData.reduce((sum, l) => sum + l.payout, 0);
            
            let text = `<strong>${count}</strong> selected`;
            if (count > 0) {
                text += ` Â· ${totalAmount.toFixed(2)} DRT`;
                if (totalClaimable > 0) {
                    text += ` Â· <span style="color:var(--green)">$${totalClaimable.toFixed(2)} claimable</span>`;
                }
            }
            document.getElementById('selectionCounter').innerHTML = text;
        }

        // Batch claim selected lots
        async function claimSelectedLots() {
            const indices = Array.from(selectedLots).filter(i => userLotsData.find(l => l.index === i)?.canClaim);
            if (indices.length === 0) {
                showToast('No claimable lots selected', 'error');
                return;
            }
            
            const btn = document.getElementById('bulkClaimBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner"></span> Claiming...';
            btn.disabled = true;
            
            try {
                const tx = await tdrtContract.claimLots(indices);
                await tx.wait();
                const totalClaimed = userLotsData.filter(l => indices.includes(l.index)).reduce((sum, l) => sum + l.payout, 0);
                showToast(`Claimed $${totalClaimed.toFixed(2)} from ${indices.length} lots!`, 'success');
                selectedLots.clear();
                await smartRefresh();
            } catch (e) {
                console.error('Batch claim error:', e);
                showToast(e.reason || e.message, 'error');
            }
            btn.innerHTML = originalText;
            updateBulkActionButtons();
        }

        // Show merge modal
        function showMergeModal() {
            const indices = Array.from(selectedLots);
            if (indices.length < 2) {
                showToast('Select at least 2 lots to merge', 'error');
                return;
            }
            
            const selectedLotsData = userLotsData.filter(l => selectedLots.has(l.index));
            const totalAmount = selectedLotsData.reduce((sum, l) => sum + l.amount, 0);
            const totalClaimable = selectedLotsData.reduce((sum, l) => sum + l.payout, 0);
            const hasClaimable = selectedLotsData.some(l => l.canClaim);
            
            // Update modal content
            document.getElementById('mergeModalCount').textContent = indices.length;
            document.getElementById('mergeModalAmount').textContent = totalAmount.toFixed(2) + ' DRT';
            document.getElementById('mergeModalEntry').textContent = '$' + currentBtcPriceGlobal.toLocaleString(undefined, {maximumFractionDigits: 0});
            
            const claimableRow = document.getElementById('mergeModalClaimableRow');
            const modalIcon = document.getElementById('mergeModalIcon');
            const modalTitle = document.getElementById('mergeModalTitle');
            const modalDesc = document.getElementById('mergeModalDesc');
            const buttonsContainer = document.getElementById('mergeModalButtons');
            
            if (hasClaimable) {
                // Has unclaimed payouts - warning mode
                modalIcon.className = 'merge-modal-icon warning';
                modalIcon.textContent = 'âš ï¸';
                modalTitle.textContent = 'Unclaimed Payouts Detected';
                modalDesc.textContent = 'Selected positions have unclaimed payouts. Choose how to proceed:';
                claimableRow.style.display = 'flex';
                
                // Smart format for tiny amounts
                const claimableDisplay = totalClaimable < 0.01 && totalClaimable > 0 
                    ? '$' + totalClaimable.toFixed(4) 
                    : '$' + totalClaimable.toFixed(2);
                document.getElementById('mergeModalClaimable').textContent = claimableDisplay;
                
                buttonsContainer.innerHTML = `
                    <button class="merge-modal-btn success" onclick="executeMerge(true)">
                        <span>âœ“</span> Claim ${claimableDisplay} & Merge
                    </button>
                    <button class="merge-modal-btn danger" onclick="executeMerge(false)">
                        <span>âš </span> Merge & Forfeit ${claimableDisplay}
                    </button>
                    <button class="merge-modal-btn secondary" onclick="closeMergeModal()">Cancel</button>
                `;
            } else {
                // No unclaimed - info mode
                modalIcon.className = 'merge-modal-icon info';
                modalIcon.textContent = 'ðŸ”—';
                modalTitle.textContent = 'Merge ' + indices.length + ' Positions';
                modalDesc.textContent = 'Combine into a single position at current BTC price. Tracked low will reset.';
                claimableRow.style.display = 'none';
                
                buttonsContainer.innerHTML = `
                    <button class="merge-modal-btn primary" onclick="executeMerge(false)">Confirm Merge</button>
                    <button class="merge-modal-btn secondary" onclick="closeMergeModal()">Cancel</button>
                `;
            }
            
            document.getElementById('mergeModalOverlay').classList.add('active');
        }
        
        function closeMergeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('mergeModalOverlay').classList.remove('active');
        }
        
        // Execute merge (with or without claim)
        async function executeMerge(claimFirst) {
            const indices = Array.from(selectedLots);
            const selectedLotsData = userLotsData.filter(l => selectedLots.has(l.index));
            const totalAmount = selectedLotsData.reduce((sum, l) => sum + l.amount, 0);
            const totalClaimable = selectedLotsData.reduce((sum, l) => sum + l.payout, 0);
            
            // Disable buttons
            const buttons = document.querySelectorAll('.merge-modal-btn');
            buttons.forEach(btn => btn.disabled = true);
            
            // Update active button to show spinner
            const activeBtn = claimFirst ? 
                document.querySelector('.merge-modal-btn.success') : 
                document.querySelector('.merge-modal-btn.primary, .merge-modal-btn.danger');
            if (activeBtn) {
                activeBtn.innerHTML = '<span class="spinner"></span> Processing...';
            }
            
            try {
                let tx;
                if (claimFirst) {
                    tx = await tdrtContract.claimAndMergeLots(indices);
                } else {
                    tx = await tdrtContract.mergeLots(indices);
                }
                await tx.wait();
                
                let msg = `Merged ${indices.length} positions into ${totalAmount.toFixed(2)} DRT`;
                if (claimFirst && totalClaimable > 0) {
                    msg = `Claimed $${totalClaimable.toFixed(2)} & merged ${indices.length} positions`;
                }
                showToast(msg, 'success');
                selectedLots.clear();
                closeMergeModal();
                await smartRefresh();
            } catch (e) {
                console.error('Merge error:', e);
                showToast(e.reason || e.message, 'error');
                // Re-enable buttons
                buttons.forEach(btn => btn.disabled = false);
                // Restore button text
                showMergeModal(); // Refresh modal content
            }
        }
        
        // Show loading state after transaction
        let loadingLocked = false;
        function showLoadingState() {
            loadingLocked = true;
            
            // Clear and pause the auto-refresh interval during loading
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
            
            // Add loading overlay to positions container
            const container = document.getElementById('positionsContainer');
            const existingOverlay = container.querySelector('.loading-overlay');
            if (!existingOverlay) {
                const overlay = document.createElement('div');
                overlay.className = 'loading-overlay';
                overlay.innerHTML = `
                    <div class="loading-content">
                        <div class="spinner-large"></div>
                        <div class="loading-text">Updating positions...</div>
                        <div class="loading-subtext">(up to 30s)</div>
                    </div>
                `;
                container.style.position = 'relative';
                container.appendChild(overlay);
            }
            
            // Also show loading on portfolio cards
            const portfolioValue = document.getElementById('portfolioValue');
            if (portfolioValue) portfolioValue.style.opacity = '0.5';
            const balanceValue = document.getElementById('balanceValue');
            if (balanceValue) balanceValue.style.opacity = '0.5';
        }
        
        // Smart refresh - waits for blockchain sync then refreshes
        async function smartRefresh() {
            showLoadingState();
            await new Promise(resolve => setTimeout(resolve, 30000));
            await refreshData();
        }
        
        // Hide loading state
        function hideLoadingState() {
            loadingLocked = false;
            
            // Small delay to ensure DOM has rendered new content
            setTimeout(() => {
                const container = document.getElementById('positionsContainer');
                const overlay = container.querySelector('.loading-overlay');
                if (overlay) overlay.remove();
                
                const portfolioValue = document.getElementById('portfolioValue');
                if (portfolioValue) portfolioValue.style.opacity = '1';
                const balanceValue = document.getElementById('balanceValue');
                if (balanceValue) balanceValue.style.opacity = '1';
                
                // Restart auto-refresh interval
                if (!refreshInterval && tdrtContract) {
                    refreshInterval = setInterval(refreshData, 30000);
                }
            }, 150);
        }

        // Mint DRT - v8 takes USDC amount, user enters DRT
        async function mintDRT() {
            const drtAmt = document.getElementById('mintAmount').value;
            if (!drtAmt || parseFloat(drtAmt) <= 0) return;
            
            // Ensure we have fresh data before minting
            if (!currentMarketPrice || currentMarketPrice <= 0) {
                showToast('Loading price data, please wait...', 'error');
                await refreshData();
                return;
            }
            
            const btn = document.getElementById('mintBtn');
            const originalText = btn.innerHTML;
            
            try {
                // Calculate USDC cost from DRT amount
                const drtAmount = parseFloat(drtAmt);
                const usdcCost = drtAmount * currentMarketPrice;
                const usdcAmount = ethers.utils.parseUnits(usdcCost.toFixed(6), 6);
                
                const allow = await usdcContract.allowance(userAddress, TDRT_ADDRESS);
                
                if (allow.lt(usdcAmount)) {
                    btn.innerHTML = '<span class="spinner"></span> Approving...';
                    btn.disabled = true;
                    const approveTx = await usdcContract.approve(TDRT_ADDRESS, ethers.constants.MaxUint256);
                    await approveTx.wait();
                    
                    // Wait for state to sync after approval
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // Re-initialize provider and contracts to get fresh state
                    provider = new ethers.providers.Web3Provider(window.ethereum, "any");
                    signer = provider.getSigner();
                    tdrtContract = new ethers.Contract(TDRT_ADDRESS, TDRT_ABI, signer);
                    usdcContract = new ethers.Contract(USDC_ADDRESS, ERC20_ABI, signer);
                }
                
                btn.innerHTML = '<span class="spinner"></span> Minting...';
                btn.disabled = true;
                const mintTx = await tdrtContract.mint(usdcAmount);
                await mintTx.wait();
                
                showToast('Minted ' + drtAmt + ' DRT successfully!', 'success');
                document.getElementById('mintAmount').value = '';
                document.getElementById('mintCost').textContent = '0.00 USDC';
                await smartRefresh();
            } catch (e) { 
                console.error('Mint error:', e);
                // Provide clearer error messages
                let errorMsg = e.reason || e.message || 'Transaction failed';
                if (errorMsg.includes('user rejected') || errorMsg.includes('User denied')) {
                    errorMsg = 'Transaction cancelled';
                } else if (errorMsg.includes('insufficient funds')) {
                    errorMsg = 'Insufficient ETH for gas';
                } else if (errorMsg.includes('INSUFFICIENT_BALANCE') || errorMsg.includes('transfer amount exceeds balance')) {
                    errorMsg = 'Insufficient USDC balance';
                } else if (errorMsg.includes('revert') || errorMsg.includes('execution reverted')) {
                    errorMsg = 'Transaction failed - please try again';
                }
                showToast(errorMsg, 'error'); 
            }
            btn.innerHTML = originalText;
            await checkMintStatus();
        }

        // Redeem DRT
        async function redeemDRT() {
            const amt = document.getElementById('redeemAmount').value;
            if (!amt || parseFloat(amt) <= 0) return;
            
            const btn = document.getElementById('redeemBtn');
            btn.innerHTML = '<span class="spinner"></span> Redeeming...';
            btn.disabled = true;
            
            try {
                const amount = ethers.utils.parseUnits(amt, 6);
                const tx = await tdrtContract.redeem(amount);
                await tx.wait();
                showToast('Redeemed ' + amt + ' DRT for ' + (parseFloat(amt) * 0.95).toFixed(2) + ' USDC', 'success');
                document.getElementById('redeemAmount').value = '';
                document.getElementById('redeemReceive').textContent = '0.00 USDC';
                await smartRefresh();
            } catch (e) { 
                console.error('Redeem error:', e);
                showToast(e.reason || e.message, 'error'); 
            }
            btn.innerHTML = 'Redeem DRT';
            btn.disabled = false;
        }

        // Claim single lot
        async function claimLot(lotIndex) {
            try {
                showToast('Claiming...', 'success');
                const tx = await tdrtContract.claim(lotIndex);
                await tx.wait();
                showToast('Claimed successfully!', 'success');
                await smartRefresh();
            } catch (e) {
                console.error('Claim error:', e);
                showToast(e.reason || e.message, 'error');
            }
        }

        // Claim all claimable lots - show modal first
        function claimAll() {
            const claimableLots = userLotsData.filter(l => l.canClaim);
            if (claimableLots.length === 0) return;
            
            // Calculate total claimable
            const totalClaimable = claimableLots.reduce((sum, lot) => sum + lot.payout, 0);
            
            // Smart format for modal
            const formattedAmount = totalClaimable < 0.01 && totalClaimable > 0 
                ? '$' + totalClaimable.toFixed(4) + ' USDC'
                : '$' + totalClaimable.toFixed(2) + ' USDC';
            
            // Populate modal
            document.getElementById('modalClaimAmount').textContent = formattedAmount;
            
            // Show modal
            document.getElementById('claimModal').style.display = 'flex';
        }
        
        function closeClaimModal() {
            document.getElementById('claimModal').style.display = 'none';
        }
        
        // Actually execute the claim after confirmation
        async function confirmClaimAll() {
            closeClaimModal();
            
            const claimableLots = userLotsData.filter(l => l.canClaim);
            if (claimableLots.length === 0) return;

            const btn = document.getElementById('claimBtn');
            btn.innerHTML = '<span class="spinner"></span> Claiming...';
            btn.disabled = true;

            try {
                for (const lot of claimableLots) {
                    const tx = await tdrtContract.claim(lot.index);
                    await tx.wait();
                }
                showToast('All claims processed!', 'success');
                await smartRefresh();
            } catch (e) {
                console.error('Claim error:', e);
                showToast(e.reason || e.message, 'error');
            }
            btn.innerHTML = 'Claim Payout';
            btn.disabled = false;
        }

        // Lock New High - show confirmation modal first
        let currentBtcForModal = 0;
        function lockNewHigh() {
            if (!anyLotCanRelock) return;
            
            // Count eligible lots and check for claimables ONLY in eligible lots
            const eligibleLots = userLotsData.filter(lot => currentBtcForModal > lot.anchorPrice);
            const eligibleClaimable = eligibleLots.reduce((sum, lot) => sum + lot.payout, 0);
            
            // Populate modal
            document.getElementById('modalEligibleCount').textContent = eligibleLots.length + ' of ' + userLotsData.length;
            document.getElementById('modalNewPrice').textContent = '$' + currentBtcForModal.toLocaleString(undefined, {maximumFractionDigits: 0});
            
            // Show warning if there are unclaimed payouts in ELIGIBLE positions only
            const warningEl = document.getElementById('lockWarning');
            if (eligibleClaimable > 0.01) {
                warningEl.innerHTML = `âš ï¸ You have <strong>$${eligibleClaimable.toFixed(2)}</strong> unclaimed payouts in eligible positions. Locking a new high resets your position's history. If you lock now without claiming, you will lose these earnings.`;
                warningEl.style.display = 'block';
            } else {
                warningEl.style.display = 'none';
            }
            
            // Show modal
            document.getElementById('lockModal').style.display = 'flex';
        }
        
        function closeLockModal() {
            document.getElementById('lockModal').style.display = 'none';
        }
        
        // Actually execute the lock after confirmation
        async function confirmLockNewHigh() {
            closeLockModal();
            
            const btn = document.getElementById('lockNewHighBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner"></span>';
            btn.disabled = true;

            try {
                // Get user's full balance
                const balance = await tdrtContract.balanceOf(userAddress);
                if (balance == 0) {
                    showToast('No tokens to re-lock', 'error');
                    return;
                }
                
                // Self-transfer triggers anchor ratchet in _update hook
                const tx = await tdrtContract.transfer(userAddress, balance);
                await tx.wait();
                
                showToast('Locked at new high! Your entry prices have been updated.', 'success');
                await smartRefresh();
            } catch (e) {
                console.error('Lock error:', e);
                showToast(e.reason || e.message, 'error');
            }
            btn.innerHTML = originalText;
            btn.disabled = !anyLotCanRelock;
        }

        // Input handlers
        document.getElementById('mintAmount').addEventListener('input', e => {
            const drt = parseFloat(e.target.value) || 0;
            const usdcCost = drt * currentMarketPrice;
            document.getElementById('mintCost').textContent = usdcCost.toFixed(2) + ' USDC';
        });

        document.getElementById('redeemAmount').addEventListener('input', e => {
            const drt = parseFloat(e.target.value) || 0;
            document.getElementById('redeemReceive').textContent = (drt * 0.95).toFixed(2) + ' USDC';
        });

        // Max buttons - use minimum of daily cap and true max
        function setMaxMint() {
            // Use the lesser of daily cap remaining and true max mintable
            const safeMax = Math.max(0, Math.min(remainingDailyCap, trueMaxMintable));
            document.getElementById('mintAmount').value = safeMax.toFixed(6);
            document.getElementById('mintCost').textContent = (safeMax * currentMarketPrice).toFixed(2) + ' USDC';
        }

        function setMaxRedeem() {
            document.getElementById('redeemAmount').value = userBalance.toFixed(6);
            document.getElementById('redeemReceive').textContent = (userBalance * 0.95).toFixed(2) + ' USDC';
        }

        // Toast
        function showToast(msg, type = 'success') {
            const t = document.createElement('div');
            t.className = 'toast ' + type;
            t.innerHTML = `<span>${type === 'success' ? 'âœ“' : 'âœ•'}</span><span>${msg}</span>`;
            document.getElementById('toastContainer').appendChild(t);
            setTimeout(() => t.remove(), 4000);
        }

        // Auto-connect on page load
        document.addEventListener('DOMContentLoaded', async () => {
            if (window.ethereum) {
                try {
                    // Only auto-connect if wallet already authorized (no popup)
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        await connectWallet();
                    }
                } catch (e) {
                    console.log('Auto-connect failed:', e);
                }
            }
        });

        // Handle account/chain changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', a => a.length ? connectWallet() : location.reload());
            window.ethereum.on('chainChanged', () => location.reload());
        }

        // Refresh data when user returns to tab (e.g., after trading on Uniswap)
        let lastHidden = 0;
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                lastHidden = Date.now();
            } else {
                // Only refresh if away for more than 5 seconds and wallet is connected
                const awayTime = Date.now() - lastHidden;
                if (awayTime > 5000 && tdrtContract && !loadingLocked) {
                    refreshData();
                }
            }
        });

        // Mobile tooltip - bottom sheet style
        const tooltipData = {
            'Ultra Transparent': 'All reserves and contracts are open-source and visible on-chain. Verify anytime on Basescan.',
            'Counter-Cyclical Asset': 'Earn when Bitcoin drops. Never lose value when Bitcoin rises. No expiration date. Claiming payouts doesn\'t burn your tokens â€” you keep them until you sell or redeem.',
            '100% Decentralized': 'No admin keys. No manual controls. Fully autonomous smart contracts.',
            'Exit Anytime': 'Redeem or sell 24/7. No lockups, no waiting periods.'
        };
        
        function closeMobileTooltip() {
            document.getElementById('tooltipOverlay').style.display = 'none';
            document.getElementById('tooltipOverlay').classList.remove('active');
            document.getElementById('mobileTooltipSheet').classList.remove('active');
        }
        
        function showMobileTooltip(title, content) {
            document.getElementById('sheetTitle').textContent = title;
            document.getElementById('sheetContent').textContent = content;
            document.getElementById('tooltipOverlay').style.display = 'block';
            document.getElementById('tooltipOverlay').classList.add('active');
            document.getElementById('mobileTooltipSheet').classList.add('active');
        }
document.querySelectorAll('.trust-badge-item').forEach(item => {
    const handler = function(e) {
        if (window.innerWidth <= 768) {
            e.preventDefault();
            e.stopPropagation();
            const title = this.querySelector('span')?.textContent.replace('âœ“ ', '') || '';
            const tooltipEl = this.querySelector('.trust-tooltip');
            const content = tooltipEl ? tooltipEl.textContent : '';
            if (content) {
                showMobileTooltip(title || 'Info', content);
            }
        }
    };
    item.addEventListener('click', handler);
    item.addEventListener('touchstart', handler, { passive: false });
});

// Mobile tooltip support using Event Delegation (works for dynamic elements like Positions table)
// Using CAPTURE phase to intercept before inline onclick handlers
document.addEventListener('click', function(e) {
    if (window.innerWidth > 768) return;
    
    const wrap = e.target.closest('.tooltip-wrap');
    if (!wrap) return;
    
    const tooltipText = wrap.querySelector('.tooltip-text');
    if (!tooltipText) return;
    
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();
    
    const content = tooltipText.textContent;
    let title = wrap.getAttribute('data-title') || '';
    
    if (!title) {
        const label = wrap.querySelector('.label') || wrap.closest('.status-detail')?.querySelector('.label');
        if (label) {
            title = label.textContent.replace(' â“˜', '').trim();
        }
    }
    if (!title) {
        // For table header tooltips - get only the label span, not tooltip-text
        const labelSpan = wrap.querySelector('span:not(.tooltip-text)');
        if (labelSpan) {
            title = labelSpan.textContent.replace('â“˜', '').trim();
        }
    }
    if (!title) {
        // Fallback: use first 30 chars of content
        title = content.substring(0, 30) + '...';
    }
    
    showMobileTooltip(title || 'Info', content);
}, true); // true = CAPTURE phase, runs BEFORE bubbling handlers
</script>
</body>
</html>
